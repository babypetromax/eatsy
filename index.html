<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เมนูอาหาร - [Eatsy ปลวกแดง]</title>
    <meta name="description" content="เมนูอาหารร้าน Eatsy Healthy Food and Bar ปลวกแดง Healthy Bowl ! อาหารสุขภาพ, อาหารทะเลสุด, สลัดเลิศๆ, อัปเดตล่าสุด ดูเมนูและสั่งออนไลน์ได้เลย ราคาล่าสุด สั่งเดลิเวอรี่ออนไลน์ได้เลย!">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#656D4A">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- Base Styles --- */
        :root {
            --color-darkest: #333D29;
            --color-dark-green: #414833;
            --color-medium-green: #656D4A;
            --color-light-green: #A4AC86;
            --color-lightest-green: #C2C5AA;
            --color-light-beige: #B6AD90;
            --color-medium-beige: #A68A64;
            --color-text-primary: #343A40;
            --color-text-secondary: #6C757D;
            --color-background: #F8F9FA;
            --color-white: #FFFFFF;
            --color-white-rgb: 255, 255, 255; /* For RGBA */
            --color-background-rgb: 248, 249, 250; /* For RGBA */
            --color-white-transparent: rgba(var(--color-white-rgb), 0.9);
            --color-footer-transparent: rgba(var(--color-background-rgb), 0.9);
            --color-border: #dee2e6;
            --color-danger: #dc3545;
            --color-info: #17a2b8;
            --color-modal-bg: rgba(0, 0, 0, 0.6);
            --transition-speed-fast: 0.2s;
            --transition-speed-medium: 0.3s;
            --transition-speed-slow: 0.5s;
            --category-bar-height: 58px; /* Approximate height for category bar */
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--color-background); color: var(--color-text-primary);
            overscroll-behavior-y: contain;
            padding-bottom: 290px; /* Increased padding for new icon */
            /*padding-top: var(--category-bar-height); */
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 10px; }

        /* --- Category Bar (MODIFIED for Sticky Top & Hide/Show on scroll) --- */
        .category-bar {
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            background-color: rgba(var(--color-white-rgb), 0.95); /* Slightly transparent */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: 10px 5px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            box-sizing: border-box;
            border-radius: 0; /* No radius if it's edge to edge */
            margin-bottom: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Softer shadow */
            -ms-overflow-style: none;
            scrollbar-width: none;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: transform var(--transition-speed-medium) ease-out, opacity var(--transition-speed-medium) ease-out;
            height: var(--category-bar-height); /* Define height for smooth transitions */
        }
        .category-bar.hidden-by-scroll {
            transform: translateY(-100%);
            opacity: 0.8;
            pointer-events: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }
        .category-item {
            display: flex; flex-direction: column; align-items: center; padding: 6px 10px; /* Adjusted padding */
            margin: 0 3px; /* Adjusted margin */
            background-color: transparent; color: var(--color-text-secondary); border-radius: 6px; /* Softer radius */
            cursor: pointer;
            flex-shrink: 0; font-size: 0.75em; /* Slightly smaller font */
            text-align: center;
            transition: background-color var(--transition-speed-medium) ease, color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
            border-bottom: 2px solid transparent;
            user-select: none;
        }
        .category-item.selected { color: var(--color-dark-green); font-weight: bold; border-bottom: 2px solid var(--color-medium-green); background-color: rgba(var(--color-background-rgb),0.8); }
        .category-item i { font-size: 1.2em; margin-bottom: 2px; pointer-events: none; }
        .category-item span { font-size: 0.7em; white-space: normal; line-height: 1.1; pointer-events: none; }
        .category-item:hover:not(.selected) { color: #495057; background-color: rgba(var(--color-background-rgb),0.5); transform: translateY(-1px); }


        /* --- Top Section --- */
        .top-section {
            width: calc(100% + 20px); 
            position: relative;
            margin-left: -10px; margin-right: -10px;
        }
        .image-container {
            width: 100%;
            aspect-ratio: 8 / 9;
            overflow: hidden;
            background-color: #e0e0e0; position: relative; cursor: grab;
            margin-bottom: 30px; 
        }
        .image-container:active { cursor: grabbing; }
        .main-food-image {
            width: 100%; height: 100%; object-fit: cover;
            object-position: center;
            display: block;
        }

        /* --- Swipe Animation Classes --- */
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-container.slide-out-left { animation: slideOutLeft var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-right { animation: slideInRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-out-right { animation: slideOutRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-left { animation: slideInLeft var(--transition-speed-medium) ease-out forwards; }

        /* --- Film Strip Section (MODIFIED for Overlay) --- */
        #film-strip-section {
            width: calc(100% + 20px);
            margin-left: -10px;
            margin-right: -10px;
            overflow: hidden;
            padding: 8px 0; /* Adjusted padding */
            background: linear-gradient(to top, rgba(var(--color-white-rgb), 0.9) 60%, rgba(var(--color-white-rgb), 0.4) 100%); /* Gradient for smooth overlay */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            box-sizing: border-box;
            position: relative;
            margin-top: -55px; 
            z-index: 10; 
            border-top: 1px solid rgba(0,0,0,0.03); 
        }
        #film-strip-items-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 5px 10px; 
            gap: 2px; 
            -webkit-overflow-scrolling: touch;
        }
        #film-strip-items-container::-webkit-scrollbar { height: 4px; } 
        #film-strip-items-container::-webkit-scrollbar-thumb { background-color: var(--color-light-green); border-radius: 2px; }
        #film-strip-items-container::-webkit-scrollbar-track { background-color: transparent; } 

        .film-strip-item {
            flex-shrink: 0;
            width: 68px; height: 88px; 
            border-radius: 5px; 
            overflow: hidden; cursor: pointer;
            position: relative; border: 1px solid transparent; 
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: rgba(var(--color-background-rgb), 0.5); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); 
        }
        .film-strip-item img {
            width: 100%; height: 100%; object-fit: cover;
            object-position: center; display: block;
        }
        .film-strip-item:hover { transform: scale(1.03); border-color: var(--color-medium-green); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .film-strip-item.active {
            border-color: var(--color-darkest); 
            transform: scale(1.08); 
            box-shadow: 0 0 10px rgba(var(--color-dark-green-rgb, 51, 61, 41), 0.6); 
            z-index: 11; 
        }

        /* --- Menu Details --- */
        #menu-details {
            padding: 15px 10px; background-color: var(--color-white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); display: none;
            margin-left: 10px; margin-right: 10px;
            width: calc(100% - 20px); border-radius: 0 0 10px 10px;
            position: relative; 
            z-index: 5; 
        }
        .menu-name-container { margin-bottom: 5px; }
        #menu-name { font-size: 28px; font-weight: bold; text-transform: uppercase; margin: 0; color: var(--color-darkest); line-height: 1.2; }
        #menu-description { font-size: 14px; margin: 0 0 10px 0; color: var(--color-medium-green); line-height: 1.5; }
        
        /* -- Price/Size Selection (IMPROVED) -- */
        #menu-price-options { margin-bottom: 15px; }
        .price-option-item {
            display: flex; align-items: center; padding: 8px 0;
            border-bottom: 1px solid #eee; cursor: pointer;
            transition: background-color var(--transition-speed-fast);
        }
        .price-option-item:last-child { border-bottom: none; }
        .price-option-item:hover { background-color: #f8f9fa; }
        .price-option-item input[type="radio"] {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            width: 18px; height: 18px; border: 2px solid var(--color-light-green);
            border-radius: 50%; margin-right: 12px; cursor: pointer;
            position: relative; outline: none;
            transition: border-color var(--transition-speed-fast);
        }
        .price-option-item input[type="radio"]:checked { border-color: var(--color-dark-green); }
        .price-option-item input[type="radio"]:checked::before {
            content: ''; display: block; width: 10px; height: 10px;
            background-color: var(--color-medium-green); border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .price-option-label-text { flex-grow: 1; font-size: 0.95em; color: var(--color-text-primary); }
        .price-option-label-text .size-name { font-weight: 500; }
        .price-option-value-text { font-size: 1em; font-weight: bold; color: var(--color-medium-beige); }
        .hidden { display: none !important; }


        /* --- Additional Menu Options (e.g., Sweetness, Toppings) --- */
        .menu-options-section { border-top: 1px solid var(--color-border); padding-top: 15px; }
        .menu-options-container { margin-bottom: 10px; }
        .option-title { font-size: 0.95em; font-weight: bold; color: var(--color-dark-green); margin: 0 0 8px 0; display: block; }
        .option-choices { display: flex; flex-wrap: wrap; gap: 8px; }
        .option-choice-label {
            display: inline-flex; align-items: center; background-color: #e9ecef; color: var(--color-text-secondary);
            padding: 6px 12px; border-radius: 15px; cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease;
            font-size: 0.85em; border: 1px solid transparent; user-select: none;
        }
        .option-choice-label input[type="radio"] { appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 0; height: 0; opacity: 0; position: absolute; margin: 0; padding: 0; }
        .option-choice-label:has(input[type="radio"]:checked) { background-color: var(--color-medium-green); color: var(--color-white); font-weight: bold; border: 1px solid var(--color-dark-green); }
        .option-choice-label:not(:has(input[type="radio"]:checked)):hover { background-color: #ced4da; }
        
        /* -- Item Notes & Main Add to Cart Button (NEW) -- */
        #item-notes-section { margin-top: 15px; }
        #item-notes-label { display: block; font-size: 0.95em; font-weight: bold; color: var(--color-dark-green); margin-bottom: 8px; }
        #item-notes-textarea {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border);
            font-size: 0.9em; line-height: 1.5; min-height: 60px; resize: vertical;
            box-sizing: border-box; transition: border-color var(--transition-speed-fast);
        }
        #item-notes-textarea:focus { border-color: var(--color-medium-green); outline: none; box-shadow: 0 0 0 0.2rem rgba(var(--color-medium-green-rgb, 101, 109, 74), 0.25); }
        
        #main-add-to-cart-button {
            display: flex; align-items: center; justify-content: center;
            width: 100%; background-color: var(--color-medium-green); color: var(--color-white);
            padding: 12px 20px; margin-top: 20px; border: none; border-radius: 8px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease, opacity var(--transition-speed-fast) ease;
        }
        #main-add-to-cart-button:hover:not(:disabled) { background-color: var(--color-dark-green); }
        #main-add-to-cart-button:disabled { background-color: #cccccc; color: #666666; cursor: not-allowed; opacity: 0.7; }
        #main-add-to-cart-button .price-on-button { margin-left: auto; font-size: 0.9em; opacity: 0.9;}

        /* Common options styling for lists (kept for consistency if needed elsewhere) */
        .list-item-options { font-size: 0.8em; color: var(--color-text-secondary); margin-top: 3px; margin-left: 10px; line-height: 1.3; }
        .list-item-options span { display: block; margin-bottom: 2px; }
        .receipt-item-options {
             font-size: 0.8em; color: var(--color-text-secondary); grid-column: 1 / -1;
             padding-left: 15px; margin-top: -5px; margin-bottom: 5px; line-height: 1.4;
        }
        .receipt-item-options span { display: block; }


        /* --- Pinterest-Style Menu Grid --- */
        .bottom-menu {
            width: 100%; padding-top: 10px; column-count: 2;
            column-gap: 10px; contain: layout paint;
        }
        .menu-item {
            display: inline-block; width: 100%; margin-bottom: 10px; border-radius: 10px; overflow: hidden;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform var(--transition-speed-fast) ease-in-out, box-shadow var(--transition-speed-fast) ease-in-out, filter var(--transition-speed-fast) ease-in-out;
            break-inside: avoid; position: relative;
        }
        .menu-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.05); }
        .menu-item img { width: 100%; height: auto; display: block; }

        /* --- Floating Icons --- */
        .floating-icon {
            position: fixed; right: 20px;
            background-color: var(--color-medium-green); color: var(--color-white);
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
        }
        .floating-icon:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        .icon-badge {
            position: absolute; top: -5px; right: -5px; background-color: var(--color-danger); color: white;
            border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; line-height: 22px; border: 1px solid white;
            transition: transform var(--transition-speed-fast) ease;
        }
        .floating-icon.updated .icon-badge { transform: scale(1.3); }
        /* Adjusted bottom positions for 4 icons */
        #translate-icon-container { bottom: 285px; z-index: 1013; font-size: 22px; } /* New Icon */
        #call-staff-icon-container { bottom: 220px; z-index: 1012; font-size: 22px; }
        #my-food-icon-container { bottom: 155px; z-index: 1011; font-size: 22px; }
        #cart-icon-container { bottom: 90px; z-index: 1010; font-size: 24px; }
        #call-staff-icon-container .fa-spinner { font-size: 24px; }
        #translate-icon-container .lang-indicator { 
            position: absolute; bottom: 3px; right: 5px; background-color: rgba(0,0,0,0.4);
            color: white; border-radius: 3px; padding: 1px 3px; font-size: 9px;
            font-weight: bold; line-height: 1;
        }


        /* --- Popups (Cart, My Food, Language) --- */
        .popup-base {
            position: fixed; right: 20px; width: 90%; max-width: 380px;
            background-color: var(--color-white-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none; flex-direction: column; overflow: hidden;
            opacity: 0; transform: translateY(20px) scale(0.95);
            transition: opacity var(--transition-speed-medium) ease-out, transform var(--transition-speed-medium) ease-out, bottom var(--transition-speed-medium) ease-out;
            pointer-events: none; 
        }
        .popup-base.open { display: flex; opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        /* Adjusted bottom positions for popups */
        #language-popup { bottom: 350px; max-height: 40vh; z-index: 1009;} /* New Popup */
        #cart-popup { bottom: 155px; max-height: 45vh; z-index: 1007; } 
        #my-food-popup { bottom: 220px; max-height: 50vh; z-index: 1008; }

        .popup-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--color-border); border-radius: 10px 10px 0 0; flex-shrink: 0;
        }
        .popup-header h3 { margin: 0; font-size: 1.1em; color: var(--color-darkest); }
        .popup-close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; }
        .cart-header { background-color: rgba(182, 173, 144, 0.8); }
        .my-food-header { background-color: rgba(164, 172, 134, 0.8); }
        .language-header { background-color: rgba(120, 130, 100, 0.8); } 
        .popup-items-list { padding: 5px 15px; overflow-y: auto; flex-grow: 1; }
        .list-item-base { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .list-item-base:last-child { border-bottom: none; }
        .list-item-details { flex-grow: 1; margin-right: 10px; }
        .list-item-name { font-weight: bold; color: var(--color-dark-green); }
        .list-item-info { color: var(--color-medium-beige); font-size: 0.9em; }
        .list-item-total { font-weight: bold; color: var(--color-medium-beige); flex-shrink: 0;}
        .cart-item-controls { display: flex; align-items: center; flex-shrink: 0; }
        .cart-quantity-btn {
            background-color: #e9ecef; color: var(--color-text-secondary); border: 1px solid var(--color-border);
            border-radius: 4px; width: 25px; height: 25px; font-size: 16px; cursor: pointer;
            margin: 0 5px; line-height: 23px; text-align: center; transition: background-color var(--transition-speed-fast) ease;
        }
        .cart-quantity-btn:hover { background-color: #ced4da; }
        .cart-item-quantity { min-width: 20px; text-align: center; font-weight: bold; }
        .cart-remove-btn { background: none; border: none; color: var(--color-danger); font-size: 16px; cursor: pointer; margin-left: 10px; transition: color var(--transition-speed-fast) ease; padding: 0 5px;}
        .cart-remove-btn:hover { color: #a0232f; }
        .popup-footer {
            padding: 15px; border-top: 1px solid var(--color-border); background-color: var(--color-footer-transparent);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 0 0 10px 10px; flex-shrink: 0;
        }
        .popup-actions { display: flex; justify-content: center; gap: 10px; }
        .popup-action-btn {
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-size: 0.9em; transition: opacity 0.2s ease; flex-grow: 1; margin: 0;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .popup-action-btn:hover { opacity: 0.85; }
        .popup-action-btn:disabled { background-color: #ccc !important; color: #666 !important; cursor: not-allowed; opacity: 0.7; }
        .popup-action-btn .fa-spinner { font-size: 1em; }
        .order-btn { background-color: var(--color-light-green); color: var(--color-darkest); }
        .my-food-checkout-btn { background-color: var(--color-medium-beige); color: var(--color-white); }
        .popup-empty-message { text-align: center; color: var(--color-text-secondary); padding: 20px; }
        #my-food-total-display { text-align: right; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; color: var(--color-darkest); }
        
        /* Language Popup Specific Styles */
        .language-option-item {
            padding: 12px 10px; font-size: 1em; color: var(--color-darkest);
            cursor: pointer; border-radius: 5px; margin: 3px 0;
            transition: background-color var(--transition-speed-fast) ease;
            display: flex; align-items: center; justify-content: space-between;
        }
        .language-option-item:hover { background-color: rgba(var(--color-lightest-green-rgb, 194, 197, 170), 0.5); }
        .language-option-item.selected-lang { background-color: var(--color-medium-green); color: var(--color-white); font-weight: bold; }
        .language-option-item .lang-flag { font-size: 1.2em; margin-right: 10px; } 


        /* --- Table Number Display & Modal --- */
        #table-number-display {
            position: fixed; bottom: 20px; left: 20px; z-index: 990; 
            background-color: var(--color-medium-green); color: var(--color-white);
            font-family: 'Sarabun', 'Inter', sans-serif; font-size: 0.9rem; font-weight: bold;
            padding: 8px 15px; border-radius: 9999px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            user-select: none;
        }
        #table-number-display:hover { background-color: var(--color-dark-green); transform: scale(1.05); }
        #table-number-display .table-icon { margin-right: 5px; }
        #table-number-display .placeholder-text { font-style: italic; opacity: 0.8; }
        #table-select-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-modal-bg);
            display: none; justify-content: center; align-items: center; z-index: 1050;
            opacity: 0; transition: opacity var(--transition-speed-medium) ease;
        }
        #table-select-modal.open { display: flex; opacity: 1; }
        .table-select-content {
            background-color: var(--color-white); border-radius: 10px;
            padding: 20px; max-width: 90%; width: 300px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: scale(0.95); transition: transform var(--transition-speed-medium) ease;
            max-height: 80vh; display: flex; flex-direction: column;
        }
        #table-select-modal.open .table-select-content { transform: scale(1); }
        .table-select-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--color-border); padding-bottom: 10px; flex-shrink: 0; }
        .table-select-header h4 { margin: 0; font-size: 1.2em; color: var(--color-darkest); }
        .table-select-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; padding: 0; }
        #table-list {
            overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px; padding: 5px; flex-grow: 1;
        }
        .table-list-item {
            padding: 10px; border: 1px solid var(--color-border); border-radius: 5px; text-align: center; font-weight: bold; cursor: pointer;
            background-color: var(--color-background);
            transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }
        .table-list-item:hover { background-color: var(--color-lightest-green); color: var(--color-darkest); transform: scale(1.05); }
        .table-list-item.selected { background-color: var(--color-medium-green); color: var(--color-white); border-color: var(--color-dark-green); }

        /* --- First Load Prompt Notification --- */
        #table-prompt-notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--color-info); color: var(--color-white);
            padding: 10px 20px; border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 1100;
            font-size: 0.9em; font-weight: bold; text-align: center;
            opacity: 0; transition: top var(--transition-speed-medium) ease-out, opacity var(--transition-speed-medium) ease-out;
        }
        #table-prompt-notification.show { top: var(--category-bar-height); opacity: 1; } 
         #table-prompt-notification.show.category-bar-is-hidden { top: 0; } 


        /* --- Receipt Modal Styles --- */
        #receipt-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-modal-bg);
            display: none; justify-content: center; align-items: center; z-index: 1060;
            opacity: 0; transition: opacity var(--transition-speed-medium) ease;
            padding: 15px; box-sizing: border-box;
        }
        #receipt-modal.open { display: flex; opacity: 1; }
        .receipt-modal-content {
            max-width: 90%; width: 380px; max-height: 90vh; display: flex; flex-direction: column;
            background-color: var(--color-white); border-radius: 8px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); overflow: hidden;
        }
        #receipt-content { padding: 25px; overflow-y: auto; font-family: 'Sarabun', 'Courier New', Courier, monospace; color: var(--color-text-primary); flex-grow: 1; }
        .receipt-header { text-align: center; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-logo { max-width: 70px; height: auto; margin-bottom: 10px; }
        .receipt-header h3 { font-size: 1.2em; font-weight: bold; color: var(--color-darkest); margin: 0 0 8px 0; }
        .receipt-info { font-size: 0.85em; color: var(--color-text-secondary); line-height: 1.5; }
        .receipt-info span { margin: 0 5px; }
        .receipt-title { text-align: center; font-size: 1.2em; font-weight: bold; margin: 15px 0 10px 0; color: var(--color-darkest); }
        .receipt-title-hr { border: none; border-top: 1px dashed var(--color-border); margin: 5px auto 15px auto; width: 80%; }
        #receipt-items-header {
            display: grid; grid-template-columns: 1fr minmax(3.5em, auto) minmax(4.5em, auto) minmax(5em, auto);
            gap: 5px 10px; padding: 8px 0; font-size: 0.8em; font-weight: bold;
            border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border);
            margin-bottom: 5px; color: var(--color-text-secondary);
        }
        #receipt-items-header span { display: block; }
        #receipt-items-header .header-item { text-align: left; }
        #receipt-items-header .header-qty { text-align: center; }
        #receipt-items-header .header-price { text-align: right; }
        #receipt-items-header .header-total { text-align: right; }
        #receipt-items-header .secondary-text { font-size: 0.9em; font-weight: normal; opacity: 0.8; }
        #receipt-items-list { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--color-border); }
        .receipt-item {
            display: grid; grid-template-columns: 1fr minmax(3.5em, auto) minmax(4.5em, auto) minmax(5em, auto);
            gap: 5px 10px; padding: 8px 0; font-size: 0.9em; align-items: start;
        }
        .receipt-item-name { font-weight: normal; line-height: 1.4; text-align: left; }
        .receipt-item-qty { text-align: center; font-weight: normal; }
        .receipt-item-price { text-align: right; color: var(--color-text-secondary); }
        .receipt-item-total { text-align: right; font-weight: bold; color: var(--color-dark-green); }
        .receipt-total {
             text-align: right; font-size: 1.15em; font-weight: bold;
             margin-top: 10px; margin-bottom: 20px; padding-top: 15px;
             border-top: 1px solid var(--color-text-secondary); border-bottom: 3px double var(--color-darkest);
             padding-bottom: 5px; color: var(--color-darkest);
         }
         .receipt-total .total-label-eng { display: block; font-size: 0.7em; font-weight: normal; color: var(--color-text-secondary); margin-top: 2px; }
        .receipt-qr { text-align: center; margin-bottom: 20px; }
        .receipt-qr img { max-width: 295px; height: auto; display: inline-block; border: 1px solid var(--color-border); padding: 6px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .receipt-footer { text-align: center; font-size: 0.85em; color: var(--color-medium-green); padding-top: 15px; border-top: 1px dashed var(--color-border); line-height: 1.5; }
        .receipt-actions { display: flex; justify-content: center; gap: 10px; padding: 15px 20px; background-color: var(--color-background); border-top: 1px solid var(--color-border); flex-shrink: 0; }

        /* --- Responsive Adjustments --- */
        @media (min-width: 640px) {
             .container { padding: 0 20px; }
             .bottom-menu { column-count: 3; }
             #menu-name { font-size: 32px; }
             .price-option-value-text { font-size: 1.1em; }
             .add-to-cart-button { width: 28px; height: 28px; line-height: 28px; font-size: 18px; }
             .top-section { width: calc(100% + 40px); margin-left: -20px; margin-right: -20px; }
             #film-strip-section { width: calc(100% + 40px); margin-left: -20px; margin-right: -20px;}
             .film-strip-item { width: 75px; height: 95px; } 
             #menu-details { margin-left: 20px; margin-right: 20px; width: calc(100% - 40px); }
             #table-number-display { font-size: 1rem; bottom: 15px; left: 15px; padding: 10px 20px; }
             #table-prompt-notification { font-size: 1em; }
             .receipt-modal-content { width: 420px; }
             .receipt-header h3 { font-size: 1.4em; }
             .receipt-title { font-size: 1.3em; }
             #receipt-items-header { font-size: 0.85em; }
             .receipt-item { font-size: 0.95em; }
             .receipt-total { font-size: 1.2em; }
             .category-item { padding: 8px 12px; font-size: 0.8em; } 
             .category-item i { font-size: 1.3em; }
             .category-item span { font-size: 0.75em; }
             :root { --category-bar-height: 62px; } 
        }
        @media (min-width: 768px) { .bottom-menu { column-count: 4; } .film-strip-item { width: 80px; height: 100px; } }
        @media (min-width: 1024px) { .bottom-menu { column-count: 5; } }
        @media (min-width: 1280px) { .bottom-menu { column-count: 6; } }

        /* Google Translate Widget Styling - to hide the original widget and its popups */
        #google_translate_element { display: none !important; }
        .goog-te-banner-frame.skiptranslate, iframe.goog-te-menu-frame { display: none !important; }
        body { top: 0px !important; } /* Override Google Translate's top banner style */
        .goog-tooltip { display: none !important; } /* Hide the "Rate this translation" tooltip */
        .goog-tooltip:hover { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; box-shadow: none !important; border: none !important; }
    </style>
</head>
<body>
    <!-- Table Number Display -->
    <div id="table-number-display" title="เลือกหมายเลขโต๊ะ">
        <span id="table-number-text"><span class="placeholder-text">เลือกโต๊ะ</span></span>
    </div>

    <!-- Table Selection Modal -->
    <div id="table-select-modal">
        <div class="table-select-content">
            <div class="table-select-header">
                <h4>เลือกหมายเลขโต๊ะ</h4>
                <button class="table-select-close-btn" title="ปิด">×</button>
            </div>
            <div id="table-list">
                <!-- Table numbers populated by JS -->
            </div>
        </div>
    </div>

    <!-- Table Prompt Notification -->
    <div id="table-prompt-notification">
        <i class="fas fa-info-circle"></i> กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ
    </div>

    <div class="container">
        <!-- Category Bar -->
        <div class="category-bar">
            <!-- Categories populated by JS -->
         </div>

        <!-- Top Section: Image, Film Strip, and Details -->
        <div class="top-section">
             <div class="image-container" id="image-swipe-area">
                 <img id="main-food-image" class="main-food-image" src="https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Salad Bowl">
             </div>
            <div id="film-strip-section">
                <div id="film-strip-items-container">
                    <!-- Thumbnails will be populated by JS -->
                </div>
            </div>
             <div id="menu-details">
                 <div class="menu-name-container">
                     <h2 id="menu-name">ชื่อเมนู</h2>
                 </div>
                 <p id="menu-description">คำอธิบายเมนูอาหาร</p>
                 
                 <!-- IMPROVED: Price/Size Selection with Radio Buttons -->
                 <div id="menu-price-options">
                    <!-- Price options populated by JS -->
                 </div>

                 <!-- Additional Menu Options (sweetness, toppings etc.) -->
                 <div id="menu-options-section" class="menu-options-section" style="margin-top: 15px;">
                     <div id="menu-option1-container" class="menu-options-container hidden">
                         <h4 class="option-title" id="option1-title"></h4>
                         <div class="option-choices" id="option1-choices"></div>
                     </div>
                     <div id="menu-option2-container" class="menu-options-container hidden" style="margin-top: 10px;">
                          <h4 class="option-title" id="option2-title"></h4>
                          <div class="option-choices" id="option2-choices"></div>
                     </div>
                 </div>

                 <!-- NEW: Item Notes Section -->
                 <div id="item-notes-section">
                    <label id="item-notes-label" for="item-notes-textarea">หมายเหตุถึงร้านอาหาร (ถ้ามี):</label>
                    <textarea id="item-notes-textarea" rows="2" placeholder="เช่น ไม่ใส่ผักชี, ขอเผ็ดน้อย, etc."></textarea>
                 </div>

                 <!-- NEW: Main Add to Cart Button -->
                 <button id="main-add-to-cart-button" disabled>
                    <span>เพิ่มไปยังตะกร้า</span>
                    <span class="price-on-button hidden" id="selected-price-on-button"></span>
                </button>
             </div>
        </div>

        <!-- Menu Grid -->
        <div class="bottom-menu">
            <!-- Menu items populated by JS -->
        </div>

    </div> <!-- End .container -->

    <!-- Floating Icons -->
    <div id="translate-icon-container" class="floating-icon" title="เปลี่ยนภาษา">
        <i class="fas fa-language"></i>
        <span id="current-lang-indicator" class="lang-indicator hidden"></span>
    </div>
    <div id="call-staff-icon-container" class="floating-icon" title="เรียกพนักงาน">
        <i class="fas fa-bell"></i>
    </div>
    <div id="my-food-icon-container" class="floating-icon" title="เปิด/ปิด รายการอาหารของฉัน">
        <i class="fas fa-receipt"></i>
        <span id="my-food-item-count" class="icon-badge hidden">0</span>
    </div>
    <div id="cart-icon-container" class="floating-icon" title="เปิด/ปิด ตระกร้า">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-item-count" class="icon-badge hidden">0</span>
    </div>

    <!-- Language Selection Popup -->
    <div id="language-popup" class="popup-base">
        <div class="popup-header language-header">
            <h3>เลือกภาษา</h3>
            <button class="popup-close-btn language-close-btn" title="ปิด">×</button>
        </div>
        <div class="popup-items-list" id="language-options-list">
            <!-- Language options populated by JS -->
            <p class="popup-empty-message language-empty-message">กำลังโหลดตัวเลือกภาษา...</p>
        </div>
    </div>

    <!-- My Food Popup -->
    <div id="my-food-popup" class="popup-base">
        <div class="popup-header my-food-header">
            <h3>รายการอาหารที่สั่งแล้ว</h3>
            <button class="popup-close-btn my-food-close-btn" title="ปิดรายการ">×</button>
        </div>
        <div class="popup-items-list" id="my-food-items-list">
            <p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>
        </div>
        <div class="popup-footer my-food-footer">
            <div id="my-food-total-display"></div>
            <div class="popup-actions my-food-actions">
                <button class="popup-action-btn my-food-checkout-btn" id="my-food-checkout-button">
                    สรุปยอดและเรียกชำระเงิน
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Popup -->
    <div id="cart-popup" class="popup-base">
        <div class="popup-header cart-header">
            <h3>ตระกร้าสินค้า</h3>
            <button class="popup-close-btn cart-close-btn" title="ปิดตระกร้า">×</button>
        </div>
        <div class="popup-items-list" id="cart-items-list">
            <p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>
        </div>
        <div class="popup-footer cart-footer">
            <div class="popup-actions cart-actions">
                <button class="popup-action-btn order-btn" id="order-button">
                    สั่งรายการอาหาร
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal">
        <div class="receipt-modal-content">
            <div id="receipt-content">
                <div class="receipt-header">
                    <img src="https://raw.githubusercontent.com/babypetromax/eatsy/main/icons/icon-512x512.png" alt="Logo" class="receipt-logo">
                    <h3 id="receipt-restaurant-name">ชื่อร้าน</h3>
                    <p class="receipt-info">
                        <span id="receipt-table-info">โต๊ะ: -</span> |
                        <span id="receipt-datetime">วันที่: - เวลา: -</span>
                    </p>
                </div>
                <h4 class="receipt-title">ใบสรุปรายการอาหาร</h4>
                <hr class="receipt-title-hr">
                <div id="receipt-items-header">
                    <span class="header-item">รายการ<br><span class="secondary-text">(Item)</span></span>
                    <span class="header-qty">จำนวน<br><span class="secondary-text">(Qty)</span></span>
                    <span class="header-price">ราคา<br><span class="secondary-text">(Price)</span></span>
                    <span class="header-total">รวม<br><span class="secondary-text">(Total)</span></span>
                </div>
                <div id="receipt-items-list"></div>
                <div class="receipt-total" id="receipt-grand-total"></div>
                <div class="receipt-qr">
                    <p style="font-size: 0.9em; margin-bottom: 5px; color: var(--color-text-secondary);">สแกนเพื่อชำระเงิน</p>
                    <img id="receipt-qr-image" src="" alt="QR Code Scan to Pay">
                </div>
                <div class="receipt-footer">
                     <p>สุขภาพดีเริ่มต้นที่นี่ ขอบคุณที่ให้Eatsy เป็นส่วนหนึ่งนะคะ ☀️<br>
                       Good health starts here. Thanks for making us a part of your wellness journey! 😊</p>
                </div>
            </div>
            <div class="receipt-actions">
                <button id="save-receipt-btn" class="popup-action-btn receipt-action-btn">
                    <i class="fas fa-download"></i> บันทึกเป็นรูปภาพ
                </button>
                <button id="close-receipt-btn" class="popup-action-btn receipt-action-btn receipt-close-btn">
                    <i class="fas fa-times"></i> ปิด
                </button>
            </div>
        </div>
    </div>

    <!-- Google Translate Element (Hidden) -->
    <div id="google_translate_element" style="display:none;"></div>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async defer></script>
<script>
    // ========================================================================
    // START: Configuration
    // ========================================================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHffrMtJPHnCf4NIryF-JUqOg60YO9k-FqCHAAfoqhzMxLI0Ot_rxg_C_87A01Yafh/exec";
    const RESTAURANT_NAME = "Eatsy Healthy Food and Bar ปลวกแดง";
    const QR_CODE_IMAGE_URL = "https://raw.githubusercontent.com/babypetromax/eatsy/main/icons/qrpamentkbank.jpg";
    const TABLE_NUMBER_PREFIX = "โต๊ะ ";
    const MAX_TABLE_NUMBER = 30;
    const TABLE_SELECT_PROMPT_MESSAGE = "กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ";
    const TABLE_STORAGE_KEY = 'selectedTableData_v123';
    const TABLE_EXPIRY_HOURS = 6;
    const CART_LOCAL_STORAGE_KEY = 'menuCartData_v123_db';
    const ORDERED_ITEMS_LOCAL_STORAGE_KEY = 'menuOrderedItemsData_v123_db';
    const tPart1 = 'NzA0ODk5NzkxODpB'; const tPart2 = 'QUhZdDVqQk9HM1E2'; const tPart3 = 'N2JwenRJbl9SR3BE'; const tPart4 = 'Q2NYMHlBVVlWQQ==';
    const CHAT_ID = '-1002634956608';
    const AVAILABLE_LANGUAGES = [ 
        { code: 'th', name: 'ไทย', flag: '🇹🇭', short: 'TH' },
        { code: 'en', name: 'English', flag: '🇬🇧', short: 'EN' },
        { code: 'zh-CN', name: '中文 (简体)', flag: '🇨🇳', short: 'CN' },
        { code: 'ja', name: '日本語', flag: '🇯🇵', short: 'JP' },
        { code: 'ko', name: '한국어', flag: '🇰🇷', short: 'KR' }
    ];


    // --- Global Data Variables ---
    let menuData = [];
    let allCategories = [];
    let globalFilmStripItems = [];
    let sortedCategoriesCache = [];

    // --- State Variables ---
    let cartItems = [];
    let orderedItems = [];
    let selectedTableNumber = null;
    let currentDisplayedItemId = null;
    let currentCategory = null;
    let currentGlobalFilmStripIndex = -1;
    let touchStartX = 0; let touchEndX = 0; let isSwiping = false; const swipeThreshold = 50;
    let lastScrollTop = 0; 
    let currentSelectedLanguage = 'th';
    let googleTranslateInitialized = false;


    // --- DOM Elements ---
    const categoryBarEl = document.querySelector('.category-bar'); 
    const tableNumberDisplay = document.getElementById('table-number-display');
    const tableNumberText = document.getElementById('table-number-text');
    const tableSelectModal = document.getElementById('table-select-modal');
    const tableListContainer = document.getElementById('table-list');
    const tableSelectCloseBtn = tableSelectModal?.querySelector('.table-select-close-btn');
    const tablePromptNotification = document.getElementById('table-prompt-notification');
    const mainFoodImage = document.getElementById('main-food-image');
    const imageContainer = document.getElementById('image-swipe-area');
    const filmStripSection = document.getElementById('film-strip-section');
    const filmStripItemsContainer = document.getElementById('film-strip-items-container');
    const bottomMenu = document.querySelector('.bottom-menu');
    const menuDetailsContainer = document.getElementById('menu-details');
    const menuNameElement = document.getElementById('menu-name');
    const menuDescriptionElement = document.getElementById('menu-description');
    
    // IMPROVED: Price/Size related DOM elements
    const menuPriceOptionsContainer = document.getElementById('menu-price-options');
    const mainAddToCartButton = document.getElementById('main-add-to-cart-button');
    const selectedPriceOnButton = document.getElementById('selected-price-on-button');
    const itemNotesTextarea = document.getElementById('item-notes-textarea');
    
    const menuOptionsSection = document.getElementById('menu-options-section');
    const menuOption1Container = document.getElementById('menu-option1-container');
    const menuOption1TitleEl = document.getElementById('option1-title');
    const menuOption1ChoicesEl = document.getElementById('option1-choices');
    const menuOption2Container = document.getElementById('menu-option2-container');
    const menuOption2TitleEl = document.getElementById('option2-title');
    const menuOption2ChoicesEl = document.getElementById('option2-choices');
    const cartIconContainer = document.getElementById('cart-icon-container');
    const cartItemCountBadge = document.getElementById('cart-item-count');
    const cartPopup = document.getElementById('cart-popup');
    const cartItemsList = document.getElementById('cart-items-list');
    const cartCloseBtn = cartPopup?.querySelector('.cart-close-btn');
    const orderButton = document.getElementById('order-button');
    const myFoodIconContainer = document.getElementById('my-food-icon-container');
    const myFoodItemCountBadge = document.getElementById('my-food-item-count');
    const myFoodPopup = document.getElementById('my-food-popup');
    const myFoodItemsList = document.getElementById('my-food-items-list');
    const myFoodTotalDisplay = document.getElementById('my-food-total-display');
    const myFoodCloseBtn = myFoodPopup?.querySelector('.my-food-close-btn');
    const myFoodCheckoutButton = document.getElementById('my-food-checkout-button');
    const callStaffIconContainer = document.getElementById('call-staff-icon-container');
    const receiptModal = document.getElementById('receipt-modal');
    const receiptContent = document.getElementById('receipt-content');
    const receiptRestaurantName = document.getElementById('receipt-restaurant-name');
    const receiptTableInfo = document.getElementById('receipt-table-info');
    const receiptDateTime = document.getElementById('receipt-datetime');
    const receiptItemsListEl = document.getElementById('receipt-items-list');
    const receiptGrandTotal = document.getElementById('receipt-grand-total');
    const receiptQrImage = document.getElementById('receipt-qr-image');
    const saveReceiptBtn = document.getElementById('save-receipt-btn');
    const closeReceiptBtn = document.getElementById('close-receipt-btn');
    
    const translateIconContainer = document.getElementById('translate-icon-container');
    const currentLangIndicator = document.getElementById('current-lang-indicator');
    const languagePopup = document.getElementById('language-popup');
    const languageOptionsList = document.getElementById('language-options-list');
    const languageCloseBtn = languagePopup?.querySelector('.language-close-btn');


    // --- Utility Functions ---
    function getCurrentDateString() { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; }
    function getCurrentLocalDateTimeStrings() {
        const now = new Date(); const thaiLocale = 'th-TH';
        const dateFormatter = new Intl.DateTimeFormat(thaiLocale, { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'buddhist'});
        const timeFormatter = new Intl.DateTimeFormat(thaiLocale, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        return { date: dateFormatter.format(now), time: timeFormatter.format(now) };
    }
    function getExpiryTimestamp(hours) { return Date.now() + hours * 60 * 60 * 1000; }
    function safeJsonParse(key) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch (e) { console.error(`LS Error (Parse ${key}):`, e); localStorage.removeItem(key); return null; } }

    // --- Google Translate Functions ---
    function googleTranslateElementInit() {
        if (googleTranslateInitialized) return; // Prevent multiple initializations
        googleTranslateInitialized = true;
        new google.translate.TranslateElement({
            pageLanguage: 'th',
            includedLanguages: AVAILABLE_LANGUAGES.map(l => l.code).join(','),
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
            autoDisplay: false
        }, 'google_translate_element');
        
        // Wait a brief moment for the widget to potentially load and apply cookie-based translation
        setTimeout(() => {
            updateLanguageIndicator();
            console.log("Google Translate Initialized. Current lang from cookie:", getCurrentSelectedLanguage());
        }, 500); 
    }

    function changeLanguage(langCode) {
        console.log("Attempting to change language to:", langCode);
        currentSelectedLanguage = langCode; // Update state immediately

        const googleTranslateElement = document.getElementById('google_translate_element');
        if (googleTranslateElement && google.translate && google.translate.TranslateElement) {
            const currentCookieLang = getCurrentSelectedLanguage();
            if (currentCookieLang !== langCode) {
                 // Set the googtrans cookie for the selected language
                document.cookie = `googtrans=/th/${langCode}; expires=Session; path=/; SameSite=Lax`;
                // Forcing reload after cookie set
                window.location.reload();
            } else if (langCode === 'th' && currentCookieLang !== 'th') {
                // This case might not be hit if currentCookieLang is already 'th'
                document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax';
                window.location.reload();
            } else {
                // If already the correct language or trying to set 'th' when it's already 'th'
                console.log("Language is already set to or reverting to 'th'. No cookie change needed or already handled.");
                updateLanguageIndicator(); // Just update UI
            }
        } else {
            console.error("Google Translate Element or API not fully loaded.");
        }
        closeLanguagePopup();
    }
    
    function populateLanguageOptions() {
        if (!languageOptionsList) return;
        languageOptionsList.innerHTML = '';
        const frag = document.createDocumentFragment();
        const activeLang = getCurrentSelectedLanguage(); 

        AVAILABLE_LANGUAGES.forEach(lang => {
            const item = document.createElement('div');
            item.className = 'language-option-item notranslate'; 
            if (lang.code === activeLang) {
                item.classList.add('selected-lang');
            }
            item.dataset.langCode = lang.code;
            item.innerHTML = `<span class="lang-flag">${lang.flag}</span> ${lang.name} <i class="fas fa-check ${lang.code === activeLang ? '' : 'hidden'}"></i>`;
            item.onclick = (e) => {
                e.stopPropagation(); // Prevent popup from closing if logic inside takes time
                if (lang.code !== activeLang) {
                    changeLanguage(lang.code);
                } else {
                    closeLanguagePopup(); // Close if clicking the already selected language
                }
            };
            frag.appendChild(item);
        });
        languageOptionsList.appendChild(frag);
    }

    function openLanguagePopup() {
        if (languagePopup) {
            closeAllPopupsExcept(languagePopup);
            populateLanguageOptions();
            languagePopup.classList.add('open');
        }
    }

    function closeLanguagePopup() {
        if (languagePopup) languagePopup.classList.remove('open');
    }
    
    function getCurrentSelectedLanguage() {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith('googtrans=')) {
                const value = cookie.split('=')[1];
                if (value && value !== 'null' && value.includes('/')) {
                    const parts = value.split('/');
                     // parts[0] is source lang (e.g., empty or 'auto'), parts[1] is target lang (e.g., 'en')
                    // For /th/en, parts will be ['', 'th', 'en'] if path is just /
                    // Or if cookie is /auto/en, then parts is ['', 'auto', 'en']
                    // We are interested in the target language.
                    if (parts.length === 3 && parts[1] === 'th' && parts[2]) { // Our specific format /th/TARGET_LANG
                        return parts[2];
                    } else if (parts.length === 2 && parts[0] === '' && parts[1] !== 'th') { //Handles format like /en
                         return parts[1];
                    }
                }
            }
        }
        return 'th'; // Default language if no cookie or malformed
    }

    function updateLanguageIndicator() {
        const langCode = getCurrentSelectedLanguage();
        currentSelectedLanguage = langCode; // Update global state
        const langObj = AVAILABLE_LANGUAGES.find(l => l.code === langCode);

        if (currentLangIndicator && langObj) {
            if (langObj.code !== 'th') {
                currentLangIndicator.textContent = langObj.short;
                currentLangIndicator.classList.remove('hidden');
                if(translateIconContainer) translateIconContainer.style.backgroundColor = 'var(--color-dark-green)';
            } else {
                currentLangIndicator.classList.add('hidden');
                if(translateIconContainer) translateIconContainer.style.backgroundColor = 'var(--color-medium-green)';
            }
        }
    }


    // --- Table Selection Logic ---
    function openTableSelectModal() { if (tableSelectModal) { closeAllPopupsExcept(tableSelectModal); tableListContainer?.querySelectorAll('.table-list-item')?.forEach(i => i.classList.toggle('selected', i.dataset.table === selectedTableNumber)); tableSelectModal.classList.add('open'); } }
    function closeTableSelectModal() { if (tableSelectModal) tableSelectModal.classList.remove('open'); }
    function populateTableList(maxTables) {
        if (!tableListContainer) return; tableListContainer.innerHTML = ''; const frag = document.createDocumentFragment();
        for (let i = 1; i <= maxTables; i++) { const t = String(i), li = document.createElement('div'); li.className = 'table-list-item'; li.textContent = t; li.dataset.table = t; li.onclick = () => selectTable(t); frag.appendChild(li); }
        tableListContainer.appendChild(frag);
    }
    function selectTable(tableNum) {
        selectedTableNumber = tableNum; updateTableDisplay(tableNum); saveSelectedTable(tableNum); closeTableSelectModal();
        document.title = `${RESTAURANT_NAME} - ${TABLE_NUMBER_PREFIX}${tableNum}`; hideTablePromptNotification();
        loadCartFromLocalStorage(); loadOrderedItemsFromLocalStorage(); renderCart(); renderOrderedItems(); updateCartIconCount(); updateMyFoodIconCount();
    }
    function updateTableDisplay(tableNum) {
        if (tableNumberText) {
            if (tableNum) { tableNumberText.innerHTML = `<i class="fas fa-chair table-icon"></i>${TABLE_NUMBER_PREFIX}${tableNum}`; tableNumberText.classList.remove('placeholder-text'); }
            else { tableNumberText.innerHTML = `<span class="placeholder-text">เลือกโต๊ะ</span>`; tableNumberText.classList.add('placeholder-text'); document.title = `เมนูอาหาร - ${RESTAURANT_NAME}`; }
        }
    }
    function saveSelectedTable(tableNum) { const exp = getExpiryTimestamp(TABLE_EXPIRY_HOURS); try { localStorage.setItem(TABLE_STORAGE_KEY, JSON.stringify({ tableNumber: tableNum, expiry: exp })); } catch (e) { console.error("LS Error (Save Table):", e); } }
    function loadSelectedTable() {
        const p = safeJsonParse(TABLE_STORAGE_KEY);
        if (p && p.tableNumber && p.expiry && Date.now() < p.expiry) return p.tableNumber;
        if (p) localStorage.removeItem(TABLE_STORAGE_KEY); return null;
    }
    function showTablePromptNotification() {
        if (tablePromptNotification) {
            tablePromptNotification.classList.add('show');
            if (categoryBarEl && categoryBarEl.classList.contains('hidden-by-scroll')) {
                tablePromptNotification.classList.add('category-bar-is-hidden');
            } else {
                tablePromptNotification.classList.remove('category-bar-is-hidden');
            }
        }
    }
    function hideTablePromptNotification() { if (tablePromptNotification) tablePromptNotification.classList.remove('show'); }

    // --- Fetch Menu Data ---
    async function fetchMenuData() {
        console.log("Fetching menu data..."); const ld = document.createElement('div'); ld.textContent = 'กำลังโหลดเมนู...'; ld.style.cssText = 'text-align: center; padding: 20px; color: var(--color-text-secondary);';
        const cont = document.querySelector('.container');
        if (cont && categoryBarEl) cont.insertBefore(ld, categoryBarEl.nextSibling);
        else if (cont) cont.prepend(ld);

        try {
            const resp = await fetch(GOOGLE_SCRIPT_URL); if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}, statusText: ${resp.statusText}`);
            const ct = resp.headers.get("content-type"); if (!ct || !ct.includes("application/json")) { const tr = await resp.text(); console.error("Non-JSON response received:", tr.substring(0,200)); throw new Error(`Expected JSON, but got ${ct}. Check GAS deployment and script output.`); }
            const data = await resp.json(); if (data.error || (data.success === false)) throw new Error(`Script error: ${data.message || 'Unknown error from script'}`);
            if (!data || !Array.isArray(data.menuData) || !Array.isArray(data.categories)) { console.error("Invalid data structure received:", data); throw new Error("Invalid data structure received from script.");}
            console.log("Menu data fetched successfully:", data.menuData.length, "items,", data.categories.length, "categories.");
            menuData = data.menuData; allCategories = data.categories; return true;
        } catch (e) {
            console.error('Error fetching or processing menu data:', e); const errDiv = document.createElement('div');
            errDiv.innerHTML = `<p style="color:red;text-align:center;padding:20px;background-color:#ffebee;border:1px solid red;border-radius:5px;">❌ เกิดข้อผิดพลาดในการโหลดข้อมูลเมนู:<br><small>${e.message}</small><br>โปรดลองรีเฟรชหน้า หรือติดต่อพนักงาน</p>`;
            if (cont && categoryBarEl) cont.insertBefore(errDiv, categoryBarEl.nextSibling);
            else if (cont) cont.prepend(errDiv);
            menuData = []; allCategories = []; return false;
        } finally { if (ld) ld.remove(); }
    }

    // --- Film Strip Logic ---
    function getSortedCategories() {
        if (sortedCategoriesCache.length > 0) return sortedCategoriesCache;
        const desiredCategoryOrder = ["ทานเล่น", "สลัด", "เฮลท์ตี้ โบวล์", "ซุป", "จานหลัก", "ทะเล", "เครื่องดื่ม", "ของหวาน"];
        const orderMap = new Map(desiredCategoryOrder.map((cat, index) => [cat.trim().toLowerCase(), index]));
        sortedCategoriesCache = [...allCategories].sort((a, b) => {
            const normA = String(a).trim().toLowerCase(); const normB = String(b).trim().toLowerCase();
            const indexA = orderMap.get(normA); const indexB = orderMap.get(normB);
            if (indexA !== undefined && indexB !== undefined) return indexA - indexB;
            if (indexA !== undefined) return -1; if (indexB !== undefined) return 1;
            return String(a).localeCompare(String(b), 'th');
        });
        return sortedCategoriesCache;
    }

    function initializeGlobalFilmStripItems() {
        globalFilmStripItems = [];
        const sortedCats = getSortedCategories();
        sortedCats.forEach(categoryName => {
            menuData.forEach((item, originalIndex) => {
                if (Array.isArray(item.category) && item.category.includes(categoryName)) {
                    globalFilmStripItems.push({
                        id: item.id,
                        name: item.name,
                        src: item.dataImageSrc || item.src,
                        alt: item.alt || item.name,
                        categoryName: categoryName,
                        originalMenuDataIndex: originalIndex,
                        prices: item.prices,
                        description: item.description,
                        option1_title: item.option1_title,
                        option1_choices: item.option1_choices,
                        option2_title: item.option2_title,
                        option2_choices: item.option2_choices,
                    });
                }
            });
        });
        console.log("Global film strip items initialized:", globalFilmStripItems.length);
    }

    function populateFilmStrip() {
        if (!filmStripItemsContainer) { console.error("Film strip container not found."); return; }
        filmStripItemsContainer.innerHTML = '';
        if (globalFilmStripItems.length === 0) {
            filmStripItemsContainer.innerHTML = '<p style="color:var(--color-text-secondary);padding:5px;">ไม่มีภาพตัวอย่าง</p>';
            return;
        }
        const frag = document.createDocumentFragment();
        globalFilmStripItems.forEach((item, globalIndex) => {
            const div = document.createElement('div');
            div.className = 'film-strip-item';
            div.dataset.itemId = item.id;
            div.dataset.globalIndex = globalIndex;
            const img = document.createElement('img');
            img.src = item.src || 'placeholder.jpg';
            img.alt = item.alt || item.name || 'Menu thumbnail';
            img.loading = 'lazy';
            img.onerror = function() { this.onerror = null; this.src = 'placeholder.jpg'; this.alt = `${item.name || 'Menu item'} (Image unavailable)`; };
            div.appendChild(img);
            div.onclick = () => onFilmStripItemClick(globalIndex);
            frag.appendChild(div);
        });
        filmStripItemsContainer.appendChild(frag);
    }

    function onFilmStripItemClick(globalIndex) {
        currentGlobalFilmStripIndex = globalIndex;
        const itemData = globalFilmStripItems[globalIndex];
        showItemDetailsByGlobalIndex(globalIndex, 'none');

        if (itemData.categoryName !== currentCategory) {
            currentCategory = itemData.categoryName;
            document.querySelectorAll('.category-bar .category-item').forEach(c => c.classList.remove('selected'));
            const catEl = Array.from(document.querySelectorAll('.category-bar .category-item')).find(el => el.dataset.category === currentCategory);
            if (catEl) {
                 catEl.classList.add('selected');
                 catEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            displayMenuItems(currentCategory);
        }
         if (imageContainer) { 
            const imageContainerTop = imageContainer.getBoundingClientRect().top + window.pageYOffset - (categoryBarEl && !categoryBarEl.classList.contains('hidden-by-scroll') ? categoryBarEl.offsetHeight : 0);
            window.scrollTo({ top: imageContainerTop - 10, behavior: 'smooth' });
        }
    }

    function highlightActiveFilmStripItem(globalIndex) {
        if (!filmStripItemsContainer) return;
        filmStripItemsContainer.querySelectorAll('.film-strip-item').forEach(thumb => thumb.classList.remove('active'));
        const activeThumbnail = filmStripItemsContainer.querySelector(`.film-strip-item[data-global-index="${globalIndex}"]`);
        if (activeThumbnail) {
            activeThumbnail.classList.add('active');
            activeThumbnail.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    // --- Local Storage (Cart & Ordered Items) ---
    function saveCartToLocalStorage() { if (!selectedTableNumber) return; try { localStorage.setItem(CART_LOCAL_STORAGE_KEY, JSON.stringify({ table: selectedTableNumber, date: getCurrentDateString(), items: cartItems })); } catch (e) { console.error("LS Save Cart Error:", e); } }
    function loadCartFromLocalStorage() { cartItems = []; const p = safeJsonParse(CART_LOCAL_STORAGE_KEY); if (p && Array.isArray(p.items) && p.table === selectedTableNumber) {cartItems = p.items; console.log(`Loaded cart for table ${selectedTableNumber}. Items: ${cartItems.length}`);} else if (p && p.table !== selectedTableNumber) { console.log(`Ignoring cart data from table ${p.table}. Current table: ${selectedTableNumber}.`);}}
    function saveOrderedItemsToLocalStorage() { if (!selectedTableNumber) return; try { localStorage.setItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY, JSON.stringify({ table: selectedTableNumber, date: getCurrentDateString(), items: orderedItems })); } catch (e) { console.error("LS Save Ordered Error:", e); } }
    function loadOrderedItemsFromLocalStorage() { orderedItems = []; const p = safeJsonParse(ORDERED_ITEMS_LOCAL_STORAGE_KEY); if (p && Array.isArray(p.items) && p.table === selectedTableNumber) {orderedItems = p.items; console.log(`Loaded ordered items for table ${selectedTableNumber}. Items: ${orderedItems.length}`);} else if (p && p.table !== selectedTableNumber) { console.log(`Ignoring ordered items data from table ${p.table}. Current table: ${selectedTableNumber}.`);}}

    // --- Cart Update Functions ---
    // IMPROVED: This is the main function now called by the big "Add to Cart" button
    function handleMainAddToCart() {
        if (currentGlobalFilmStripIndex < 0 || currentGlobalFilmStripIndex >= globalFilmStripItems.length) {
            console.error("Invalid currentGlobalFilmStripIndex for addToCart");
            return;
        }
        const prod = globalFilmStripItems[currentGlobalFilmStripIndex];
        if (!prod || prod.id !== currentDisplayedItemId) {
            console.error("Product mismatch for addToCart:", currentDisplayedItemId, prod.id);
            return;
        }

        const selectedSizeRadio = menuPriceOptionsContainer?.querySelector('input[name="itemSizeOption"]:checked');
        if (!selectedSizeRadio) {
            alert("กรุณาเลือกขนาดของรายการอาหาร");
            return;
        }
        const size = selectedSizeRadio.value;
        const price = parseFloat(selectedSizeRadio.dataset.price);

        if (price == null || isNaN(price)) {
            console.error("Invalid price for", prod.id, size);
            alert("เกิดข้อผิดพลาด: ไม่สามารถหาราคาของขนาดที่เลือกได้");
            return;
        }

        const opt1 = menuOption1ChoicesEl?.querySelector('input[name="option1"]:checked')?.value || null;
        const opt2 = menuOption2ChoicesEl?.querySelector('input[name="option2"]:checked')?.value || null;
        const note = itemNotesTextarea?.value.trim() || null;
        
        // Construct a unique cartId based on item, size, and selected options (but not note)
        const cartId = `${prod.id}-${size}${(opt1 ? '-' + opt1.replace(/\s+/g, '') : '')}${(opt2 ? '-' + opt2.replace(/\s+/g, '') : '')}`;
        
        const existingItemIndex = cartItems.findIndex(item => item.cartId === cartId);

        if (existingItemIndex > -1) {
            // If item with same size and options exists, increment quantity. Note is typically per-item in cart if it changes, but for simplicity here, we're assuming one note for grouped items or the latest note applies. If each addition with a different note should be a new cart line, the cartId needs to include a hash of the note or a timestamp. For now, group them.
            cartItems[existingItemIndex].quantity++;
            if (note) cartItems[existingItemIndex].note = note; // Update note if provided for existing item
        } else {
            cartItems.push({
                cartId,
                id: prod.id,
                name: prod.name,
                price,
                size,
                quantity: 1,
                selectedOption1: opt1,
                selectedOption2: opt2,
                note: note
            });
        }

        saveCartToLocalStorage();
        renderCart();
        updateCartIconCount();
        cartIconContainer?.classList.add('updated');
        setTimeout(() => cartIconContainer?.classList.remove('updated'), 300);

        // Optional: Give feedback
        // alert(`${prod.name} (${size}) ${note ? 'พร้อมหมายเหตุ' : ''} ถูกเพิ่มลงในตระกร้าแล้ว`);
    }

    function updateQuantity(cartId, change) {
        const idx = cartItems.findIndex(i => i.cartId === cartId);
        if (idx > -1) { cartItems[idx].quantity += change; if (cartItems[idx].quantity <= 0) cartItems.splice(idx, 1); saveCartToLocalStorage(); renderCart(); updateCartIconCount(); }
    }
    function removeFromCart(cartId) {
        const idx = cartItems.findIndex(i => i.cartId === cartId);
        if (idx > -1) { cartItems.splice(idx, 1); saveCartToLocalStorage(); renderCart(); updateCartIconCount(); }
    }

    // --- Rendering Functions ---
    function renderCart() {
        if (!cartItemsList) return; cartItemsList.innerHTML = '';
        if (cartItems.length === 0) { cartItemsList.innerHTML = '<p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>'; }
        else { const frag = document.createDocumentFragment(); cartItems.forEach(item => {
                const el = document.createElement('div'); el.className = 'list-item-base cart-item';
                let optsHtml = ''; 
                if (item.selectedOption1 || item.selectedOption2 || item.note) { 
                    optsHtml += '<div class="list-item-options">'; 
                    if (item.selectedOption1) optsHtml += `<span>+ ${item.selectedOption1}</span>`; 
                    if (item.selectedOption2) optsHtml += `<span>+ ${item.selectedOption2}</span>`; 
                    if (item.note) optsHtml += `<span style="font-style:italic; color: var(--color-info);">หมายเหตุ: ${item.note}</span>`;
                    optsHtml += '</div>'; 
                }
                el.innerHTML = `<div class="list-item-details cart-item-details"><div class="list-item-name cart-item-name">${item.name||'N/A'} (${item.size||'N/A'})</div>${optsHtml}<div class="list-item-info cart-item-price">${(item.price||0).toLocaleString()} x ${item.quantity||0} = ${((item.price||0)*(item.quantity||0)).toLocaleString()}</div></div><div class="cart-item-controls"><button class="cart-quantity-btn decrease-qty" data-cartid="${item.cartId}" aria-label="ลดจำนวน">-</button><span class="cart-item-quantity">${item.quantity||0}</span><button class="cart-quantity-btn increase-qty" data-cartid="${item.cartId}" aria-label="เพิ่มจำนวน">+</button><button class="cart-remove-btn" data-cartid="${item.cartId}" title="ลบรายการนี้" aria-label="ลบรายการนี้"><i class="fas fa-trash-alt"></i></button></div>`;
                el.querySelector('.decrease-qty').onclick = (e) => updateQuantity(e.currentTarget.dataset.cartid, -1);
                el.querySelector('.increase-qty').onclick = (e) => updateQuantity(e.currentTarget.dataset.cartid, 1);
                el.querySelector('.cart-remove-btn').onclick = (e) => removeFromCart(e.currentTarget.dataset.cartid);
                frag.appendChild(el); }); cartItemsList.appendChild(frag);
        }
        if (orderButton) { orderButton.disabled = !(cartItems.length > 0 && selectedTableNumber); orderButton.title = (cartItems.length === 0)?"ตระกร้าว่างเปล่า":(!selectedTableNumber?"กรุณาเลือกโต๊ะก่อน":"สั่งรายการอาหาร");}
    }
    function updateCartIconCount() { if (!cartItemCountBadge) return; const qty = cartItems.reduce((s, i) => s + (i.quantity || 0), 0); cartItemCountBadge.textContent = qty; cartItemCountBadge.classList.toggle('hidden', qty === 0); }
    function renderOrderedItems() {
        if (!myFoodItemsList || !myFoodCheckoutButton || !myFoodTotalDisplay) return; myFoodItemsList.innerHTML = ''; let grandTotal = 0; const hasItems = orderedItems.length > 0;
        if (!hasItems) { myFoodItemsList.innerHTML = '<p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>'; myFoodTotalDisplay.textContent = ''; }
        else { const frag = document.createDocumentFragment(); orderedItems.forEach(item => {
                const el = document.createElement('div'); el.className = 'list-item-base ordered-item'; const itemTotal = (item.price||0)*(item.quantity||0); grandTotal += itemTotal;
                let optsHtml = ''; 
                if (item.selectedOption1 || item.selectedOption2 || item.note) { 
                    optsHtml += '<div class="list-item-options">'; 
                    if (item.selectedOption1) optsHtml += `<span>+ ${item.selectedOption1}</span>`; 
                    if (item.selectedOption2) optsHtml += `<span>+ ${item.selectedOption2}</span>`;
                    if (item.note) optsHtml += `<span style="font-style:italic; color: var(--color-info);">หมายเหตุ: ${item.note}</span>`;
                    optsHtml += '</div>'; 
                }
                el.innerHTML = `<div class="list-item-details ordered-item-details"><div class="list-item-name ordered-item-name">${item.name||'N/A'} (${item.size||'N/A'})</div>${optsHtml}<div class="list-item-info ordered-item-info">จำนวน: ${item.quantity||0} (${(item.price||0).toLocaleString()}/ชิ้น)</div></div><div class="list-item-total ordered-item-total">${itemTotal.toLocaleString()}</div>`;
                frag.appendChild(el); }); myFoodItemsList.appendChild(frag); myFoodTotalDisplay.textContent = `ยอดรวมที่สั่งแล้ว: ${grandTotal.toLocaleString()}`;
        }
        myFoodCheckoutButton.disabled = !(hasItems && selectedTableNumber); myFoodCheckoutButton.title = (!hasItems)?"ไม่มีรายการที่สั่ง":(!selectedTableNumber?"กรุณาเลือกโต๊ะก่อน":"สรุปยอดและเรียกชำระเงิน"); myFoodTotalDisplay.style.display = hasItems?'block':'none';
    }
    function updateMyFoodIconCount() { if (!myFoodItemCountBadge) return; const qty = orderedItems.reduce((s, i) => s + (i.quantity || 0), 0); myFoodItemCountBadge.textContent = qty; myFoodItemCountBadge.classList.toggle('hidden', qty === 0); if (qty > 0 && myFoodIconContainer) { myFoodIconContainer.classList.add('updated'); setTimeout(() => myFoodIconContainer?.classList.remove('updated'), 300);}}

    function showItemDetailsByGlobalIndex(globalIndex, direction = 'none') {
        // Ensure essential elements for the new structure exist
        if (!menuDetailsContainer || !mainFoodImage || !menuNameElement || !menuDescriptionElement || !menuPriceOptionsContainer || !imageContainer || 
            !menuOptionsSection || !menuOption1Container || !menuOption1TitleEl || !menuOption1ChoicesEl || 
            !menuOption2Container || !menuOption2TitleEl || !menuOption2ChoicesEl ||
            !mainAddToCartButton || !itemNotesTextarea || !selectedPriceOnButton) {
            console.error("Required elements for item details/options/new cart logic missing."); 
            return;
        }
        if (globalIndex < 0 || globalIndex >= globalFilmStripItems.length) { 
            menuDetailsContainer.style.display = 'none'; 
            currentDisplayedItemId = null; 
            currentGlobalFilmStripIndex = -1; 
            highlightActiveFilmStripItem(-1); 
            return; 
        }

        currentGlobalFilmStripIndex = globalIndex;
        const itemData = globalFilmStripItems[currentGlobalFilmStripIndex];
        currentDisplayedItemId = itemData.id;

        const newImgSrc = itemData.src || 'placeholder.jpg', curImgSrc = mainFoodImage.getAttribute('src');
        const updateImgEl = (src, alt) => { mainFoodImage.src = src; mainFoodImage.alt = alt||itemData.name||'Menu item'; mainFoodImage.onerror = () => { mainFoodImage.src = 'placeholder.jpg'; mainFoodImage.alt = `${itemData.name||'Menu item'} (Image unavailable)`; mainFoodImage.onerror=null;};};
        imageContainer.classList.remove('slide-out-left','slide-in-right','slide-out-right','slide-in-left');
        if (direction!=='none' && curImgSrc!==newImgSrc && curImgSrc!=='placeholder.jpg') {
            let outC='',inC=''; if(direction==='next'){outC='slide-out-left';inC='slide-in-right';}else if(direction==='prev'){outC='slide-out-right';inC='slide-in-left';}
            requestAnimationFrame(()=>{ imageContainer.classList.add(outC); imageContainer.addEventListener('animationend', function hOut(){ imageContainer.removeEventListener('animationend',hOut); imageContainer.classList.remove(outC); updateImgEl(newImgSrc, itemData.alt); requestAnimationFrame(()=>{ imageContainer.classList.add(inC); imageContainer.addEventListener('animationend', function hIn(){ imageContainer.removeEventListener('animationend',hIn); imageContainer.classList.remove(inC);},{once:true});});},{once:true});});
        } else { updateImgEl(newImgSrc,itemData.alt); }

        menuNameElement.textContent = itemData.name || 'ชื่อเมนู'; 
        menuDescriptionElement.textContent = itemData.description || 'ไม่มีคำอธิบาย';

        // --- IMPROVED: Populate Price/Size Radio Buttons ---
        menuPriceOptionsContainer.innerHTML = ''; // Clear previous options
        const prices = itemData.prices || {};
        const priceOrder = ['Small', 'Normal', 'Extra', 'Family']; // Define order
        let hasPriceOptions = false;

        priceOrder.forEach((sizeKey, index) => {
            if (prices[sizeKey] != null && !isNaN(prices[sizeKey])) {
                hasPriceOptions = true;
                const priceValue = Number(prices[sizeKey]);
                const optionId = `price-option-${itemData.id}-${sizeKey}`;

                const div = document.createElement('div');
                div.className = 'price-option-item';
                
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.name = 'itemSizeOption'; // Same name for grouping
                radioInput.id = optionId;
                radioInput.value = sizeKey;
                radioInput.dataset.price = priceValue;

                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.className = 'price-option-label-text'; // For flex grow
                
                const sizeNameSpan = document.createElement('span');
                sizeNameSpan.className = 'size-name';
                // Map sizeKey to Thai label
                let thaiSizeName = sizeKey;
                if (sizeKey === 'Small') thaiSizeName = 'เล็ก';
                else if (sizeKey === 'Normal') thaiSizeName = 'ปกติ';
                else if (sizeKey === 'Extra') thaiSizeName = 'พิเศษ';
                else if (sizeKey === 'Family') thaiSizeName = 'ครอบครัว';
                sizeNameSpan.textContent = `${thaiSizeName}`;

                const priceValueSpan = document.createElement('span');
                priceValueSpan.className = 'price-option-value-text';
                priceValueSpan.textContent = `${priceValue.toLocaleString()} ฿`;
                
                label.appendChild(sizeNameSpan);
                div.appendChild(radioInput);
                div.appendChild(label);
                div.appendChild(priceValueSpan); // Price on the right

                // Auto-select first available option for better UX, or "Normal" if available
                 if (index === 0 || (sizeKey === 'Normal' && !menuPriceOptionsContainer.querySelector('input[type="radio"]:checked'))) {
                    if (prices[sizeKey] != null && !isNaN(prices[sizeKey])) { // Ensure 'Normal' price actually exists
                       // No auto-selection for cleaner UI; user must pick
                    }
                }
                
                div.addEventListener('click', () => { // Allow clicking whole row to select
                    radioInput.checked = true;
                    handleSizeSelectionChange(); // Update button state and price
                });
                menuPriceOptionsContainer.appendChild(div);
            }
        });
        // Show/hide the price options container
        menuPriceOptionsContainer.style.display = hasPriceOptions ? 'block' : 'none';
        handleSizeSelectionChange(); // Initial call to set button state

        // Reset and populate additional options (sweetness, toppings)
        const createOptRadio = (name, val, lbl, idx) => { const uid=`${name}-${val.replace(/\s+/g,'-')}-${idx}`, lab=document.createElement('label'); lab.className='option-choice-label'; lab.htmlFor=uid; const inp=document.createElement('input'); inp.type='radio'; inp.name=name; inp.value=val; inp.id=uid; const spn=document.createElement('span'); spn.textContent=lbl; lab.append(inp,spn); return lab;};
        let hasVisOpts=false;
        if(menuOption1Container&&menuOption1TitleEl&&menuOption1ChoicesEl&&itemData.option1_title&&itemData.option1_choices?.length>0){ menuOption1TitleEl.textContent=itemData.option1_title; menuOption1ChoicesEl.innerHTML=''; const f1=document.createDocumentFragment(); itemData.option1_choices.forEach((c,i)=>f1.appendChild(createOptRadio('option1',c,c,i))); menuOption1ChoicesEl.appendChild(f1); menuOption1Container.classList.remove('hidden'); hasVisOpts=true;}else if(menuOption1Container){menuOption1Container.classList.add('hidden'); if(menuOption1ChoicesEl)menuOption1ChoicesEl.innerHTML='';}
        if(menuOption2Container&&menuOption2TitleEl&&menuOption2ChoicesEl&&itemData.option2_title&&itemData.option2_choices?.length>0){ menuOption2TitleEl.textContent=itemData.option2_title; menuOption2ChoicesEl.innerHTML=''; const f2=document.createDocumentFragment(); itemData.option2_choices.forEach((c,i)=>f2.appendChild(createOptRadio('option2',c,c,i))); menuOption2ChoicesEl.appendChild(f2); menuOption2Container.classList.remove('hidden'); hasVisOpts=true;}else if(menuOption2Container){menuOption2Container.classList.add('hidden'); if(menuOption2ChoicesEl)menuOption2ChoicesEl.innerHTML='';}
        if(menuOptionsSection)menuOptionsSection.style.display=hasVisOpts?'block':'none';
        
        // Reset notes and main "Add to Cart" button state
        if (itemNotesTextarea) itemNotesTextarea.value = '';
        handleSizeSelectionChange(); // Update main add to cart button state

        menuDetailsContainer.style.display = 'block';
        highlightActiveFilmStripItem(globalIndex);

        if (itemData.categoryName !== currentCategory) {
            currentCategory = itemData.categoryName;
            document.querySelectorAll('.category-bar .category-item').forEach(c => c.classList.remove('selected'));
            const catEl = Array.from(document.querySelectorAll('.category-bar .category-item')).find(el => el.dataset.category === currentCategory);
            if (catEl) {
                catEl.classList.add('selected');
                catEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
    }
    
    // IMPROVED: Function to handle changes in size selection
    function handleSizeSelectionChange() {
        if (!mainAddToCartButton || !selectedPriceOnButton) return;
        const selectedRadio = menuPriceOptionsContainer?.querySelector('input[name="itemSizeOption"]:checked');
        if (selectedRadio) {
            mainAddToCartButton.disabled = false;
            const price = parseFloat(selectedRadio.dataset.price);
            selectedPriceOnButton.textContent = `- ${price.toLocaleString()} ฿`;
            selectedPriceOnButton.classList.remove('hidden');
        } else {
            mainAddToCartButton.disabled = true;
            selectedPriceOnButton.classList.add('hidden');
            selectedPriceOnButton.textContent = '';
        }
    }


    function displayMenuItems(category) {
        if (!bottomMenu) { console.error("Bottom menu element not found."); return; }
        bottomMenu.innerHTML = '';
        if (!menuData || menuData.length === 0) { bottomMenu.innerHTML = '<p style="text-align:center;color:var(--color-text-secondary);grid-column:1 / -1;">ไม่มีข้อมูลเมนู</p>'; return; }

        const filteredItemsForGrid = menuData.filter(item => Array.isArray(item.category) && item.category.includes(category));
        if (filteredItemsForGrid.length === 0) { bottomMenu.innerHTML = `<p style="text-align:center;color:var(--color-text-secondary);grid-column:1 / -1;">ไม่มีเมนูในหมวดหมู่ "${category}"</p>`; return;}

        const frag = document.createDocumentFragment();
        filteredItemsForGrid.forEach((item) => {
            const div = document.createElement('div'); div.className = 'menu-item'; div.dataset.itemId = item.id;
            const img = document.createElement('img'); img.src = item.src||'placeholder.jpg'; img.alt = item.alt||item.name||'Menu item'; img.loading='lazy'; img.onerror=function(){this.onerror=null;this.src='placeholder.jpg';this.alt=`${item.name||'Menu item'} (Image unavailable)`;};
            div.appendChild(img);
            div.onclick = () => {
                const clickedItemId = item.id;
                const globalIdx = globalFilmStripItems.findIndex(fsItem => fsItem.id === clickedItemId);
                if (globalIdx !== -1) {
                    onFilmStripItemClick(globalIdx);
                }
            };
            frag.appendChild(div);
        });
        bottomMenu.appendChild(frag);
    }
    function showPreviousItem() {
        if (globalFilmStripItems.length <= 1 || currentGlobalFilmStripIndex < 0) return;
        let prevIndex = (currentGlobalFilmStripIndex - 1 + globalFilmStripItems.length) % globalFilmStripItems.length;
        showItemDetailsByGlobalIndex(prevIndex, 'prev');
    }
    function showNextItem() {
        if (globalFilmStripItems.length <= 1 || currentGlobalFilmStripIndex < 0) return;
        let nextIndex = (currentGlobalFilmStripIndex + 1) % globalFilmStripItems.length;
        showItemDetailsByGlobalIndex(nextIndex, 'next');
    }

    function populateCategoryBar() {
        if (!categoryBarEl) { console.error("Category bar element not found."); return; }
        const sortedCats = getSortedCategories();
        if (!sortedCats || sortedCats.length === 0) { console.warn("No categories fetched or available."); categoryBarEl.innerHTML = '<p style="color:var(--color-text-secondary);padding:10px;white-space:normal;">ไม่มีหมวดหมู่ให้แสดง</p>'; return; }
        categoryBarEl.innerHTML = '';
        const categoryIcons = { "จานหลัก":"fas fa-utensils", "เฮลท์ตี้ โบวล์":"fas fa-seedling", "ทานเล่น":"fas fa-cookie-bite", "สลัด":"fas fa-leaf", "ทะเล":"fas fa-fish", "ของหวาน":"fas fa-ice-cream", "เครื่องดื่ม":"fas fa-coffee", "ซุป":"fas fa-mug-hot", "default":"fas fa-tag" };
        const frag = document.createDocumentFragment();
        sortedCats.forEach(category => {
            const div = document.createElement('div'); div.className = 'category-item'; div.dataset.category = category;
            const icon = categoryIcons[category] || categoryIcons["default"];
            div.innerHTML = `<i class="${icon}"></i><span>${category}</span>`;
            div.onclick = handleCategoryClick; frag.appendChild(div);
        });
        categoryBarEl.appendChild(frag);
    }
    function handleCategoryClick(event) {
        const clicked = event.currentTarget, selCat = clicked.dataset.category;
        document.querySelectorAll('.category-bar .category-item').forEach(c => c.classList.remove('selected'));
        clicked.classList.add('selected');
        currentCategory = selCat;

        const firstItemGlobalIndexOfCategory = globalFilmStripItems.findIndex(item => item.categoryName === selCat);
        if (firstItemGlobalIndexOfCategory !== -1) {
            showItemDetailsByGlobalIndex(firstItemGlobalIndexOfCategory, 'none');
        } else {
            if(menuDetailsContainer) menuDetailsContainer.style.display = 'none';
            highlightActiveFilmStripItem(-1);
        }
        displayMenuItems(selCat);
        clicked.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        if (imageContainer) {
            const imageContainerTop = imageContainer.getBoundingClientRect().top + window.pageYOffset - (categoryBarEl && !categoryBarEl.classList.contains('hidden-by-scroll') ? categoryBarEl.offsetHeight : 0);
            window.scrollTo({ top: imageContainerTop - 10, behavior: 'smooth' });
        }
    }
    
    function closeAllPopupsExcept(exceptPopup = null) {
        const popups = [cartPopup, myFoodPopup, languagePopup, receiptModal, tableSelectModal];
        popups.forEach(p => {
            if (p && p !== exceptPopup) {
                p.classList.remove('open');
            }
        });
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        tableNumberDisplay?.addEventListener('click', openTableSelectModal);
        tableSelectCloseBtn?.addEventListener('click', closeTableSelectModal);
        tableSelectModal?.addEventListener('click', (e) => { if (e.target === tableSelectModal) closeTableSelectModal(); });
        tablePromptNotification?.addEventListener('click', hideTablePromptNotification);
        tablePromptNotification?.addEventListener('touchstart', hideTablePromptNotification, { passive: true });
        
        // Listener for the main "Add to Cart" button
        mainAddToCartButton?.addEventListener('click', handleMainAddToCart);

        // Listener for price/size radio button changes (delegated to container)
        menuPriceOptionsContainer?.addEventListener('change', (event) => {
            if (event.target.type === 'radio' && event.target.name === 'itemSizeOption') {
                handleSizeSelectionChange();
            }
        });
        
        cartIconContainer?.addEventListener('click', () => { closeAllPopupsExcept(cartPopup); cartPopup?.classList.toggle('open'); if (cartPopup?.classList.contains('open')) renderCart(); });
        cartCloseBtn?.addEventListener('click', () => cartPopup?.classList.remove('open'));
        
        myFoodIconContainer?.addEventListener('click', () => { closeAllPopupsExcept(myFoodPopup); myFoodPopup?.classList.toggle('open'); if (myFoodPopup?.classList.contains('open')) renderOrderedItems(); });
        myFoodCloseBtn?.addEventListener('click', () => myFoodPopup?.classList.remove('open'));
        
        callStaffIconContainer?.addEventListener('click', () => { closeAllPopupsExcept(); handleCallStaff(); });

        translateIconContainer?.addEventListener('click', () => { closeAllPopupsExcept(languagePopup); languagePopup?.classList.toggle('open'); if(languagePopup?.classList.contains('open')) populateLanguageOptions(); });
        languageCloseBtn?.addEventListener('click', () => languagePopup?.classList.remove('open'));


        if (imageContainer) {
            imageContainer.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; isSwiping = true; imageContainer.style.cursor = 'grabbing'; } }, { passive: true });
            imageContainer.addEventListener('touchmove', (e) => { if (isSwiping && e.touches.length === 1) touchEndX = e.touches[0].clientX; }, { passive: true });
            imageContainer.addEventListener('touchend', (e) => { if (!isSwiping || e.changedTouches.length !== 1) { isSwiping = false; imageContainer.style.cursor = 'grab'; return; } touchEndX = e.changedTouches[0].clientX; const dX = touchEndX - touchStartX; if (Math.abs(dX) > swipeThreshold) { if (dX > 0) showPreviousItem(); else showNextItem(); } isSwiping = false; touchStartX = 0; touchEndX = 0; imageContainer.style.cursor = 'grab'; });
            let isDrag = false, dragX = 0;
            imageContainer.addEventListener('mousedown', (e) => { if (e.target !== mainFoodImage && e.target !== imageContainer) return; isDrag = true; dragX = e.clientX; imageContainer.style.cursor = 'grabbing'; e.preventDefault(); });
            window.addEventListener('mousemove', (e) => { if (!isDrag) return; });
            window.addEventListener('mouseup', (e) => { if (!isDrag) return; isDrag = false; const endX = e.clientX, dX = endX - dragX; imageContainer.style.cursor = 'grab'; if (Math.abs(dX) > swipeThreshold) { if (dX > 0) showPreviousItem(); else showNextItem(); }});
            imageContainer.addEventListener('mouseleave', () => { if (isDrag) imageContainer.style.cursor = 'grab'; });
        }
        orderButton?.addEventListener('click', handleOrderSubmission);
        myFoodCheckoutButton?.addEventListener('click', async () => {
            if (!handleGenerateReceipt()) return;
            const origBtn = myFoodCheckoutButton.innerHTML; let photoOK=false, textOK=false; myFoodCheckoutButton.disabled=true; myFoodCheckoutButton.innerHTML=`<i class="fas fa-spinner fa-spin"></i> กำลังเตรียม...`;
            try {
                const canvas = await generateReceiptCanvas();
                if(canvas){ myFoodCheckoutButton.innerHTML=`<i class="fas fa-spinner fa-spin"></i> กำลังส่งรูป...`; photoOK = await sendTelegramPhoto(canvas, `🧾 ใบสรุปยอด *โต๊ะ ${selectedTableNumber}*`); if(!photoOK) alert("⚠️ เกิดข้อผิดพลาดในการส่งรูปภาพใบเสร็จ"); } else { alert("⚠️ ไม่สามารถสร้างรูปภาพใบเสร็จสำหรับส่งได้"); }
                myFoodCheckoutButton.innerHTML=`<i class="fas fa-spinner fa-spin"></i> กำลังส่งข้อความ...`; textOK = await sendCheckoutTextSummaryToTelegram(); if(!textOK) alert("⚠️ เกิดข้อผิดพลาดในการส่งข้อความสรุปยอด");
            } catch(e) { console.error("Checkout Error:",e); alert(`🚨 เกิดข้อผิดพลาดโดยรวม: ${e.message}`);}
            finally { myFoodCheckoutButton.disabled=false; myFoodCheckoutButton.innerHTML=origBtn; if(photoOK&&textOK) alert(`✅ เรียกเก็บเงินโต๊ะ ${selectedTableNumber} สำเร็จ (ส่งรูปและข้อความแล้ว)`); }
        });
        closeReceiptBtn?.addEventListener('click', () => receiptModal?.classList.remove('open'));
        saveReceiptBtn?.addEventListener('click', saveReceiptAsImage);
        receiptModal?.addEventListener('click', (e) => { if (e.target === receiptModal) receiptModal.classList.remove('open'); });

        window.addEventListener('scroll', function() {
            if (!categoryBarEl) return;
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const categoryBarHeight = categoryBarEl.offsetHeight;
            const googleBanner = document.querySelector('.goog-te-banner-frame');

            // Adjust scroll detection if Google Banner is visible
            const bannerOffset = googleBanner && googleBanner.offsetHeight > 0 ? googleBanner.offsetHeight : 0;
            
            if (scrollTop > lastScrollTop && scrollTop > (categoryBarHeight / 2) + bannerOffset ) { 
                categoryBarEl.classList.add('hidden-by-scroll');
            } else if (scrollTop < lastScrollTop) { 
                categoryBarEl.classList.remove('hidden-by-scroll');
            }
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;

            if (tablePromptNotification && tablePromptNotification.classList.contains('show')) {
                if (categoryBarEl.classList.contains('hidden-by-scroll')) {
                    tablePromptNotification.classList.add('category-bar-is-hidden');
                } else {
                    tablePromptNotification.classList.remove('category-bar-is-hidden');
                }
            }
        }, false);

        console.log("Event listeners setup complete.");
    }

    // --- Action Handlers (Telegram, Order, Receipt etc. - Kept as is, assuming no direct changes needed for film strip) ---
    function getTelegramToken() { try { return atob(tPart1)+atob(tPart2)+atob(tPart3)+atob(tPart4); } catch(e){ console.error("Token Decode Error:", e); return null;} }
    async function sendTelegramMessage(msgTxt, btnEl = null, loadTxt = 'กำลังส่ง...') {
        if (!selectedTableNumber && btnEl !== myFoodCheckoutButton) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ'); openTableSelectModal(); return false; }
        if (!selectedTableNumber && btnEl === myFoodCheckoutButton) return false;
        const token = getTelegramToken(); if (!token) { alert("🚨 ข้อผิดพลาด: Token ไม่ถูกต้อง"); return false; }
        let origBtnCnt='', isLoading=false;
        if(btnEl){ if(btnEl.classList.contains('loading')) { console.log("Action already in progress."); return false; } origBtnCnt=btnEl.innerHTML; btnEl.disabled=true; btnEl.classList.add('loading'); btnEl.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${loadTxt}`; isLoading=true;}
        const apiUrl=`https://api.telegram.org/bot${token}/sendMessage`, payload={chat_id:CHAT_ID, text:msgTxt, parse_mode:'Markdown'};
        try {
            const resp = await fetch(apiUrl, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); let res = await resp.json();
            if(!res.ok){ console.warn(`Markdown failed (${res.description}), attempting plain text.`); const plainP={chat_id:CHAT_ID,text:msgTxt}; const plainR = await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(plainP)}); res=await plainR.json(); if(!res.ok) throw new Error(res.description || result.description || 'Unknown Telegram API error');}
            return true;
        } catch(e){ console.error('Error sending Telegram message:',e); if(btnEl !== null) { alert(`🚨 เกิดข้อผิดพลาดในการสื่อสาร (${selectedTableNumber?TABLE_NUMBER_PREFIX+selectedTableNumber:'โต๊ะที่ไม่ได้เลือก'}): ${e.message}.\nกรุณาลองใหม่อีกครั้ง หรือแจ้งพนักงาน`);} return false;}
        finally { if(isLoading&&btnEl){ btnEl.disabled=false; btnEl.classList.remove('loading'); btnEl.innerHTML=origBtnCnt;}}
    }
    async function generateReceiptCanvas() {
        if (!receiptContent || typeof html2canvas==='undefined') { console.error("html2canvas library not found or receiptContent element missing."); return null; }
        const scroll=receiptContent.scrollTop, styles={maxH:receiptContent.style.maxHeight, ovY:receiptContent.style.overflowY};
        receiptContent.style.maxHeight='none'; receiptContent.style.overflowY='visible';
        await new Promise(r=>requestAnimationFrame(r)); await new Promise(r=>setTimeout(r,50));
        const opts={useCORS:true, scale:window.devicePixelRatio*1.5, backgroundColor:'#ffffff', logging:false, scrollY:-scroll, height:receiptContent.scrollHeight, width:receiptContent.scrollWidth};
        try { console.log("Generating receipt canvas..."); const canvas = await html2canvas(receiptContent, opts); console.log("Canvas generated."); return canvas; }
        catch(e){ console.error("Error generating receipt canvas with html2canvas:",e); return null; }
        finally { receiptContent.style.maxHeight=styles.maxH; receiptContent.style.overflowY=styles.ovY; receiptContent.scrollTop=scroll; console.log("Restored receipt content styles.");}
    }
    async function sendTelegramPhoto(canvas, caption='') {
        if(!canvas){console.error("sendTelegramPhoto: No canvas."); return false;} const token=getTelegramToken(); if(!token || !selectedTableNumber){console.error("Token/Table invalid for photo.");return false;}
        const apiUrl=`https://api.telegram.org/bot${token}/sendPhoto`;
        try {
            const blob = await new Promise((res,rej)=>{ canvas.toBlob(b=>{if(b){console.log("Blob success.");res(b);}else{console.error('Blob fail.');rej(new Error('Blob fail'))}},'image/png',0.9);});
            console.log("Blob size:", blob.size);
            const fd=new FormData(); fd.append('chat_id',CHAT_ID); fd.append('photo',blob,`receipt_table_${selectedTableNumber}_${Date.now()}.png`);
            if(caption){fd.append('caption',caption);fd.append('parse_mode','Markdown');}
            console.log(`Sending Telegram photo for table ${selectedTableNumber}...`);
            const resp = await fetch(apiUrl, {method:'POST', body:fd}); const res = await resp.json(); console.log("Telegram photo response:", res);
            if(!res.ok) throw new Error(`[${res.error_code}] ${res.description}` || 'Unknown Telegram API error sending photo'); console.log("Telegram photo sent."); return true;
        } catch(e){ console.error('Error sending Telegram photo:',e); return false; }
    }
    async function handleCallStaff() {
        if (!selectedTableNumber) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ'); openTableSelectModal(); return; }
        let msg = `🚨 *!! เรียกพนักงาน !!* 🚨\n`; msg+=`------------------------------------\n`; msg+=`โต๊ะ: *${selectedTableNumber}* ต้องการความช่วยเหลือ\n`; msg+=`------------------------------------\n`; const {time} = getCurrentLocalDateTimeStrings(); msg+=`_(เวลา: ${time})_`;
        const success = await sendTelegramMessage(msg, callStaffIconContainer, '');
        if (success) alert('✅ เรียกพนักงานบริการให้เรียบร้อยค่ะ กรุณารอสักครู่ 💁‍♀️');
    }
    async function handleOrderSubmission() {
        if(cartItems.length===0){alert('ตระกร้าสินค้าของคุณว่างเปล่า');return;} if(!selectedTableNumber){alert('กรุณาเลือกโต๊ะก่อนสั่งอาหาร');openTableSelectModal();return;}
        let orderMsg = `*โต๊ะ ${selectedTableNumber} - รายการสั่งซื้อใหม่* ✨\n`; orderMsg+=`------------------------------------\n`; let total=0;
        cartItems.forEach((item,idx)=>{ const itemPrice = item.price||0; const itemQuantity = item.quantity||0; const lineTotal=itemPrice*itemQuantity; 
            orderMsg+=`*${idx+1}. ${item.name||'N/A'}* (${item.size||'N/A'})`; 
            if(item.selectedOption1||item.selectedOption2||item.note){
                orderMsg+=`\n`; 
                if(item.selectedOption1) orderMsg+=`   + ${item.selectedOption1}\n`; 
                if(item.selectedOption2) orderMsg+=`   + ${item.selectedOption2}\n`;
                if(item.note) orderMsg+=`   📝 _${item.note}_\n`; // Add note here
                orderMsg+=`   `;
            } else {
                orderMsg+=`\n   `;
            } 
            orderMsg+=`(จำนวน: ${itemQuantity} x ${itemPrice.toLocaleString()} = *${lineTotal.toLocaleString()}*)\n\n`; 
            total+=lineTotal;
        });
        orderMsg+=`------------------------------------\n`; orderMsg+=`*ยอดรวม: ${total.toLocaleString()}*\n`; const{date,time}=getCurrentLocalDateTimeStrings(); orderMsg+=`_(สั่งเมื่อ: ${date} ${time})_`;
        const success = await sendTelegramMessage(orderMsg,orderButton,'กำลังสั่ง...');
        if(success){
            alert(`ส่งรายการสั่งซื้อจาก ${TABLE_NUMBER_PREFIX}${selectedTableNumber} สำเร็จ!`);
            // Add note to orderedItems as well
            cartItems.forEach(ci=>{ 
                const exIdx=orderedItems.findIndex(oi=>oi.id===ci.id&&oi.size===ci.size&&oi.selectedOption1===ci.selectedOption1&&oi.selectedOption2===ci.selectedOption2 && oi.note === ci.note); // Note can also differentiate here if needed
                if(exIdx>-1) orderedItems[exIdx].quantity+=ci.quantity; 
                else orderedItems.push({...ci});
            });
            cartItems=[]; saveCartToLocalStorage();saveOrderedItemsToLocalStorage();renderCart();updateCartIconCount();renderOrderedItems();updateMyFoodIconCount();
            if(cartPopup)cartPopup.classList.remove('open');
        }
    }
    function handleGenerateReceipt() {
        if(orderedItems.length===0){alert('ยังไม่มีรายการอาหารที่สั่งสำหรับสรุปยอด');return false;} if(!selectedTableNumber){alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ');openTableSelectModal();return false;}
        if(!receiptModal || !receiptContent || !receiptItemsListEl || !receiptGrandTotal || !receiptQrImage || !receiptRestaurantName || !receiptTableInfo || !receiptDateTime){ console.error("Receipt modal elements not found."); alert("เกิดข้อผิดพลาดในการแสดงใบสรุปยอด"); return false; }
        receiptRestaurantName.textContent=RESTAURANT_NAME; receiptTableInfo.textContent=`${TABLE_NUMBER_PREFIX}${selectedTableNumber}`; const{date,time}=getCurrentLocalDateTimeStrings(); receiptDateTime.textContent=`วันที่: ${date} เวลา: ${time}`;
        receiptItemsListEl.innerHTML=''; let grandTotal=0; const frag=document.createDocumentFragment();
        orderedItems.forEach(item=>{ const itemPrice = item.price||0; const itemQuantity = item.quantity||0; const lineTotal=itemPrice*itemQuantity; grandTotal+=lineTotal; 
            let optsHtml=''; 
            if(item.selectedOption1||item.selectedOption2||item.note){
                optsHtml+='<div class="receipt-item-options">';
                if(item.selectedOption1)optsHtml+=`<span>+ ${item.selectedOption1}</span>`;
                if(item.selectedOption2)optsHtml+=`<span>+ ${item.selectedOption2}</span>`;
                if(item.note) optsHtml += `<span style="font-style:italic; color: var(--color-info);">หมายเหตุ: ${item.note}</span>`;
                optsHtml+='</div>';
            } 
            const el=document.createElement('div');el.className='receipt-item'; el.innerHTML=`<span class="receipt-item-name">${item.name||'N/A'} (${item.size||'N/A'})</span><span class="receipt-item-qty">${itemQuantity}x</span><span class="receipt-item-price">${itemPrice.toLocaleString()}</span><span class="receipt-item-total">${lineTotal.toLocaleString()}</span>${optsHtml}`; frag.appendChild(el);});
        receiptItemsListEl.appendChild(frag); receiptGrandTotal.innerHTML=`ยอดรวมสุทธิ: ${grandTotal.toLocaleString()}<span class="total-label-eng">(Total)</span>`;
        receiptQrImage.src=QR_CODE_IMAGE_URL; receiptQrImage.alt="QR Code สำหรับชำระเงิน"; receiptQrImage.onerror=()=>{receiptQrImage.onerror=null;console.error("Failed to load QR code image from:",QR_CODE_IMAGE_URL);receiptQrImage.alt="QR Code ไม่สามารถแสดงได้";};
        closeAllPopupsExcept(receiptModal); 
        receiptModal.classList.add('open'); 
        if(receiptContent)receiptContent.scrollTop=0; 
        console.log("Receipt generated successfully."); return true;
    }
    async function saveReceiptAsImage() {
        const btn=document.getElementById('save-receipt-btn'), origBtn=btn?btn.innerHTML:''; if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> กำลังสร้าง...';}
        const canvas = await generateReceiptCanvas();
        if(!canvas){alert("เกิดข้อผิดพลาด: ไม่สามารถสร้างรูปภาพใบเสร็จได้"); if(btn){btn.disabled=false;btn.innerHTML=origBtn;} return;}
        try{ const link=document.createElement('a'),now=new Date(),ts=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`; link.download=`ใบสรุปยอด_${TABLE_NUMBER_PREFIX.trim()}${selectedTableNumber}_${ts}.png`; link.href=canvas.toDataURL('image/png'); document.body.appendChild(link);link.click();document.body.removeChild(link); console.log("Receipt image download initiated.");}
        catch(e){console.error("Error creating download link:",e);alert("เกิดข้อผิดพลาดในการเตรียมไฟล์สำหรับบันทึก");}
        finally{if(btn){btn.disabled=false;btn.innerHTML=origBtn;}}
    }
    async function sendCheckoutTextSummaryToTelegram() {
        if(orderedItems.length===0||!selectedTableNumber){console.warn("sendCheckoutTextSummaryToTelegram called unexpectedly."); return false;}
        let msg = `💰 *!! เรียกชำระเงิน !!* 💰\n`; msg+=`------------------------------------\n`; msg+=`โต๊ะ: *${selectedTableNumber}*\n`; msg+=`------------------------------------\n`; let total=0;
        orderedItems.forEach((item,idx)=>{ const itemPrice = item.price||0; const itemQuantity = item.quantity||0; const lineTotal=itemPrice*itemQuantity; 
            let itemLine=`*${idx+1}. ${item.name||'N/A'}* (${item.size||'N/A'})`; 
            if(item.selectedOption1||item.selectedOption2||item.note){
                itemLine+=`\n`;
                if(item.selectedOption1)itemLine+=`   + ${item.selectedOption1}\n`;
                if(item.selectedOption2)itemLine+=`   + ${item.selectedOption2}\n`;
                if(item.note) itemLine+=`   📝 _${item.note}_\n`; // Add note here
                itemLine+=`   `;
            } else {
                itemLine+=`\n   `;
            }
            itemLine+=`(จำนวน: ${itemQuantity} x ${itemPrice.toLocaleString()} = *${lineTotal.toLocaleString()}*)\n`; 
            msg+=itemLine; total+=lineTotal;});
        msg+=`------------------------------------\n`; msg+=`*ยอดรวมที่สั่งแล้ว: ${total.toLocaleString()}*\n`; const {time} = getCurrentLocalDateTimeStrings(); msg+=`_(เวลาเรียกชำระเงิน: ${time})_`;
        console.log("Sending checkout text summary..."); const success = await sendTelegramMessage(msg, null, '');
        if(success) console.log("Checkout text summary sent."); else console.error("Failed to send checkout text summary."); return success;
    }

    // --- Initial Application Load ---
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM Content Loaded. Initializing Application...");
        
        // Attempt to initialize Google Translate if the script is already loaded
        if (typeof google !== 'undefined' && google.translate) {
            googleTranslateElementInit();
        } else {
             // If not, the async script will call it via its 'cb' parameter
            console.log("Google Translate script not yet loaded, will init via callback.");
        }
        updateLanguageIndicator(); // Check cookie on load, even before GT fully inits

        const dataLoaded = await fetchMenuData();
        selectedTableNumber = loadSelectedTable(); updateTableDisplay(selectedTableNumber); populateTableList(MAX_TABLE_NUMBER);
        if (!selectedTableNumber) { showTablePromptNotification(); document.title = `เมนูอาหาร - ${RESTAURANT_NAME}`; }
        else { document.title = `${RESTAURANT_NAME} - ${TABLE_NUMBER_PREFIX}${selectedTableNumber}`; }
        loadCartFromLocalStorage(); loadOrderedItemsFromLocalStorage();

        if (dataLoaded) {
            populateCategoryBar();
            initializeGlobalFilmStripItems();
            populateFilmStrip();
        } else {
            if(categoryBarEl) categoryBarEl.innerHTML='<p style="color: red; padding: 10px; white-space: normal;">⚠ ไม่สามารถโหลดหมวดหมู่ได้</p>';
            if(filmStripItemsContainer) filmStripItemsContainer.innerHTML = '<p style="color:red;padding:5px;">⚠ ไม่สามารถโหลดภาพตัวอย่างได้</p>';
            if(bottomMenu) bottomMenu.innerHTML='';
            if(menuDetailsContainer) menuDetailsContainer.style.display='none';
        }

        renderCart(); updateCartIconCount(); renderOrderedItems(); updateMyFoodIconCount();

        if (dataLoaded && globalFilmStripItems.length > 0) {
            const sortedCats = getSortedCategories();
            const firstCategoryName = sortedCats.length > 0 ? sortedCats[0] : (allCategories.length > 0 ? allCategories[0] : null);

            if (firstCategoryName) {
                document.querySelectorAll('.category-bar .category-item').forEach(ci => ci.classList.remove('selected'));
                const firstCatEl = Array.from(document.querySelectorAll('.category-bar .category-item')).find(el => el.dataset.category === firstCategoryName);
                if (firstCatEl) firstCatEl.classList.add('selected');

                const firstItemInSelectedCategoryIndex = globalFilmStripItems.findIndex(item => item.categoryName === firstCategoryName);
                currentCategory = firstCategoryName;

                if (firstItemInSelectedCategoryIndex !== -1) {
                    currentGlobalFilmStripIndex = firstItemInSelectedCategoryIndex;
                    showItemDetailsByGlobalIndex(currentGlobalFilmStripIndex, 'none');
                } else {
                    currentGlobalFilmStripIndex = 0;
                    showItemDetailsByGlobalIndex(0, 'none');
                     if(globalFilmStripItems[0]) currentCategory = globalFilmStripItems[0].categoryName;
                }
                displayMenuItems(currentCategory);
            } else {
                 currentGlobalFilmStripIndex = 0;
                 showItemDetailsByGlobalIndex(0, 'none');
                 if(globalFilmStripItems[0] && menuDetailsContainer) menuDetailsContainer.style.display = 'block';
                 else if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
                 if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align:center;">ไม่มีเมนู</p>';
            }
        } else if (dataLoaded && globalFilmStripItems.length === 0) {
            if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
            if (filmStripItemsContainer) filmStripItemsContainer.innerHTML = '<p style="color:var(--color-text-secondary);padding:5px;">ไม่มีภาพตัวอย่าง</p>';
            if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align:center;">ไม่มีเมนู</p>';
        }

        setupEventListeners();
        if (tablePromptNotification && tablePromptNotification.classList.contains('show')) {
            if (categoryBarEl && categoryBarEl.classList.contains('hidden-by-scroll')) {
                tablePromptNotification.classList.add('category-bar-is-hidden');
            } else {
                tablePromptNotification.classList.remove('category-bar-is-hidden');
            }
        }
        console.log("Initialization complete.");
    });

</script>
</body>
</html>
