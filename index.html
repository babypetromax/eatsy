<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Dynamically set title later -->
    <title>เมนูอาหาร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        :root {
            /* Theme Colors */
            --color-darkest: #333D29;
            --color-dark-green: #414833;
            --color-medium-green: #656D4A;
            --color-light-green: #A4AC86; /* Used for Order Button */
            --color-lightest-green: #C2C5AA;
            --color-light-beige: #B6AD90; /* Used for Cart Header */
            --color-medium-beige: #A68A64; /* Color for Price and Checkout Button */
            --color-text-primary: #343A40;
            --color-text-secondary: #6C757D;
            --color-background: #F8F9FA;
            --color-white: #FFFFFF;
            --color-white-transparent: rgba(255, 255, 255, 0.9); /* Cart background */
            --color-footer-transparent: rgba(248, 249, 250, 0.9); /* Cart footer background */
            --color-border: #dee2e6;
            --color-danger: #dc3545; /* Red for remove/delete actions */
            --color-info: #17a2b8; /* Info color for prompts */
            --color-modal-bg: rgba(0, 0, 0, 0.6);
            /* Transitions */
            --transition-speed-fast: 0.2s;
            --transition-speed-medium: 0.3s;
            --transition-speed-slow: 0.5s;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', 'Inter', sans-serif; /* Added Sarabun for Thai */
            margin: 0; padding: 0;
            background-color: var(--color-background); color: var(--color-text-primary);
            overscroll-behavior-y: contain;
            padding-bottom: 225px; /* Adjusted space for floating icons (55*3 + 10*2 + 20) */
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 10px; }

        /* --- Top Section --- */
        .top-section {
            width: calc(100% + 20px); margin-bottom: 15px; position: relative;
            margin-left: -10px; margin-right: -10px;
        }
        .image-container {
            width: 100%; aspect-ratio: 5 / 4; overflow: hidden;
            background-color: #e0e0e0; position: relative; cursor: grab;
        }
        .image-container:active { cursor: grabbing; }
        .main-food-image {
            width: 100%; height: 100%; object-fit: cover; object-position: center;
            display: block;
        }

        /* --- Swipe Animation Classes --- */
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-container.slide-out-left .main-food-image { animation: slideOutLeft var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-right .main-food-image { animation: slideInRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-out-right .main-food-image { animation: slideOutRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-left .main-food-image { animation: slideInLeft var(--transition-speed-medium) ease-out forwards; }

        /* --- Menu Details --- */
        #menu-details {
            padding: 15px 10px; background-color: var(--color-white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); display: none;
             margin-left: 10px; margin-right: 10px;
             width: calc(100% - 20px); border-radius: 0 0 10px 10px;
        }
        .menu-name-container { margin-bottom: 5px; }
        #menu-name { font-size: 28px; font-weight: bold; /* Adjusted size */ text-transform: uppercase; margin: 0; color: var(--color-darkest); line-height: 1.2; }
        #menu-description { font-size: 14px; margin: 0 0 10px 0; color: var(--color-medium-green); line-height: 1.5; }
        #menu-price { font-size: 18px; /* Adjusted size */ font-weight: bold; margin: 0; color: var(--color-medium-beige); display: flex; align-items: center; flex-wrap: wrap; gap: 5px 0; }
        .price-item { display: inline-flex; align-items: center; margin-right: 10px; }
        .price-label { font-size: 0.8em; font-weight: normal; color: var(--color-text-secondary); margin-right: 4px; }
        .price-value { margin-right: 5px; }
        .add-to-cart-button {
            background-color: var(--color-medium-green); color: var(--color-white); border: none; border-radius: 50%;
            width: 24px; height: 24px; font-size: 16px; font-weight: bold; line-height: 24px; text-align: center;
            cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            padding: 0; flex-shrink: 0;
        }
        .add-to-cart-button:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        .price-separator { margin: 0 8px; font-weight: normal; color: #adb5bd; }
        .hidden { display: none !important; }

        /* --- Category Bar --- */
        .category-bar {
            width: 100%; overflow-x: auto; overflow-y: hidden; white-space: nowrap; background-color: var(--color-white);
            padding: 12px 5px; display: flex; align-items: center; flex-shrink: 0; box-sizing: border-box;
            border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }
        .category-item {
            display: flex; flex-direction: column; align-items: center; padding: 8px 15px; margin: 0 5px;
            background-color: transparent; color: var(--color-text-secondary); border-radius: 8px; cursor: pointer;
            flex-shrink: 0; font-size: 0.85em; text-align: center;
            transition: background-color var(--transition-speed-medium) ease, color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
            border-bottom: 2px solid transparent;
        }
        .category-item.selected { color: var(--color-dark-green); font-weight: bold; border-bottom: 2px solid var(--color-medium-green); background-color: #E9ECEF; }
        .category-item i { font-size: 1.4em; margin-bottom: 4px; }
        .category-item span { font-size: 0.75em; white-space: normal; line-height: 1.2; }
        .category-item:hover:not(.selected) { color: #495057; background-color: #F1F3F4; transform: translateY(-2px); }

        /* --- Pinterest-Style Menu Grid --- */
        .bottom-menu {
            width: 100%; padding-top: 10px; column-count: 2;
            column-gap: 10px; contain: layout paint;
        }
        .menu-item {
            display: inline-block; width: 100%; margin-bottom: 10px; border-radius: 10px; overflow: hidden;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform var(--transition-speed-fast) ease-in-out, box-shadow var(--transition-speed-fast) ease-in-out, filter var(--transition-speed-fast) ease-in-out;
            break-inside: avoid;
        }
        .menu-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.05); }
        .menu-item img { width: 100%; height: auto; display: block; }

        /* --- Floating Call Staff Icon --- */
        #call-staff-icon-container {
            position: fixed;
            bottom: 150px; /* Positioned above My Food (85px + 55px height + 10px gap) */
            right: 20px;
            background-color: var(--color-medium-green); /* Consistent theme */
            color: var(--color-white);
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px; /* Match My Food icon size */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1002; /* Higher than My Food and Cart */
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
        }
        #call-staff-icon-container:hover {
            background-color: var(--color-dark-green); /* Consistent hover effect */
            transform: scale(1.1);
        }
        /* Optional: Spinner style for loading state */
        #call-staff-icon-container .fa-spinner {
            font-size: 24px; /* Slightly larger spinner */
        }

        /* --- Floating My Food Icon --- */
        #my-food-icon-container {
            position: fixed; bottom: 85px; right: 20px;
            background-color: var(--color-medium-green); color: var(--color-white);
            width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 22px; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1001; /* Ensure Call Staff is above */
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
        }
        #my-food-icon-container:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        #my-food-item-count {
            position: absolute; top: -5px; right: -5px; background-color: var(--color-danger); color: white;
            border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; line-height: 22px; border: 1px solid white;
            transition: transform var(--transition-speed-fast) ease;
        }
        #my-food-icon-container.updated #my-food-item-count { transform: scale(1.3); }

        /* --- Floating Cart Icon --- */
        #cart-icon-container {
            position: fixed; bottom: 20px; right: 20px; background-color: var(--color-medium-green); color: var(--color-white);
            width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Ensure My Food & Call Staff are above */
            transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
        }
        #cart-icon-container:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        #cart-item-count {
            position: absolute; top: -5px; right: -5px; background-color: var(--color-danger); color: white;
            border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; line-height: 22px; border: 1px solid white;
            transition: transform var(--transition-speed-fast) ease;
        }
        #cart-icon-container.updated #cart-item-count { transform: scale(1.3); }

        /* --- Cart Popup --- */
        #cart-popup {
            position: fixed;
            /* Adjusted bottom to accommodate the new Call Staff button */
            bottom: 215px; /* 150px (CallStaff bottom) + 55px (CallStaff height) + 10px gap */
            right: 20px; width: 90%; max-width: 380px;
            background-color: var(--color-white-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 998; display: none; flex-direction: column;
            max-height: 45vh; overflow: hidden;
            opacity: 0; transform: translateY(20px) scale(0.95);
            transition: opacity var(--transition-speed-medium) ease-out, transform var(--transition-speed-medium) ease-out, bottom var(--transition-speed-medium) ease-out; /* Added bottom transition */
            pointer-events: none;
        }
        #cart-popup.open {
            display: flex; opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
        }
        .cart-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            background-color: rgba(182, 173, 144, 0.8); border-bottom: 1px solid var(--color-border);
            border-radius: 10px 10px 0 0; flex-shrink: 0;
        }
        .cart-header h3 { margin: 0; font-size: 1.1em; color: var(--color-darkest); }
        .cart-close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-text-secondary); }
        #cart-items-list { padding: 5px 15px; overflow-y: auto; flex-grow: 1; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-details { flex-grow: 1; margin-right: 10px; }
        .cart-item-name { font-weight: bold; color: var(--color-dark-green); }
        .cart-item-price { color: var(--color-medium-beige); font-size: 0.9em; }
        .cart-item-controls { display: flex; align-items: center; flex-shrink: 0; }
        .cart-quantity-btn {
            background-color: #e9ecef; color: var(--color-text-secondary); border: 1px solid var(--color-border);
            border-radius: 4px; width: 25px; height: 25px; font-size: 16px; cursor: pointer;
            margin: 0 5px; line-height: 23px; text-align: center; transition: background-color var(--transition-speed-fast) ease;
        }
        .cart-quantity-btn:hover { background-color: #ced4da; }
        .cart-item-quantity { min-width: 20px; text-align: center; font-weight: bold; }
         .cart-remove-btn { background: none; border: none; color: var(--color-danger); font-size: 16px; cursor: pointer; margin-left: 10px; transition: color var(--transition-speed-fast) ease; }
         .cart-remove-btn:hover { color: #a0232f; }
        .cart-footer {
            padding: 15px; border-top: 1px solid var(--color-border); background-color: var(--color-footer-transparent);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 0 0 10px 10px; flex-shrink: 0;
        }
        .cart-total { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
        .cart-actions { display: flex; justify-content: center; gap: 10px; }
        .cart-action-btn {
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-size: 0.9em; transition: opacity 0.2s ease; flex-grow: 1; margin: 0;
        }
        .cart-action-btn:hover { opacity: 0.85; }
        .order-btn { background-color: var(--color-light-green); color: var(--color-darkest); }
        .checkout-btn { background-color: var(--color-medium-beige); color: var(--color-white); }
        .cart-empty-message { text-align: center; color: var(--color-text-secondary); padding: 20px; }

        /* --- My Food Popup --- */
        #my-food-popup {
            position: fixed;
            /* Adjusted bottom to accommodate the new Call Staff button */
            bottom: 150px; /* Same as Call Staff bottom */
            right: 20px; width: 90%; max-width: 380px;
            background-color: var(--color-white-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 999; display: none; flex-direction: column;
            max-height: 50vh; overflow: hidden;
            opacity: 0; transform: translateY(20px) scale(0.95);
            transition: opacity var(--transition-speed-medium) ease-out, transform var(--transition-speed-medium) ease-out, bottom var(--transition-speed-medium) ease-out; /* Added bottom transition */
            pointer-events: none;
        }
        #my-food-popup.open {
            display: flex; opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
        }
        .my-food-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            background-color: rgba(164, 172, 134, 0.8); border-bottom: 1px solid var(--color-border);
            border-radius: 10px 10px 0 0; flex-shrink: 0;
        }
        .my-food-header h3 { margin: 0; font-size: 1.1em; color: var(--color-darkest); }
        .my-food-close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-text-secondary); }
        #my-food-items-list { padding: 5px 15px; overflow-y: auto; flex-grow: 1; }
        .ordered-item {
            padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ordered-item:last-child { border-bottom: none; }
        .ordered-item-details { flex-grow: 1; margin-right: 10px; }
        .ordered-item-name { font-weight: bold; color: var(--color-dark-green); }
        .ordered-item-info { color: var(--color-medium-beige); font-size: 0.9em; }
        .ordered-item-total { font-weight: bold; color: var(--color-medium-beige); flex-shrink: 0;}

        .my-food-footer {
            padding: 15px; border-top: 1px solid var(--color-border); background-color: var(--color-footer-transparent);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 0 0 10px 10px; flex-shrink: 0;
        }
        .my-food-actions { display: flex; justify-content: center; gap: 10px; }
        .my-food-empty-message { text-align: center; color: var(--color-text-secondary); padding: 20px; }

        /* --- Table Number Display (Interactive) --- */
        #table-number-display {
            position: fixed; bottom: 10px; left: 10px; z-index: 1002;
            background-color: var(--color-medium-green); color: var(--color-white);
            font-family: 'Sarabun', 'Inter', sans-serif; font-size: 0.9rem; font-weight: bold;
            padding: 8px 15px; border-radius: 9999px; /* Capsule shape */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer; /* Make it clickable */
            transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            user-select: none; /* Prevent text selection */
        }
        #table-number-display:hover {
            background-color: var(--color-dark-green);
            transform: scale(1.05);
        }
        #table-number-display .table-icon { /* Optional icon */
             margin-right: 5px;
        }
        #table-number-display .placeholder-text {
             font-style: italic;
             opacity: 0.8;
         }


        /* --- Table Selection Modal --- */
        #table-select-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-modal-bg);
            display: none; /* Hidden by default */
            justify-content: center; align-items: center; z-index: 1050;
            opacity: 0; transition: opacity var(--transition-speed-medium) ease;
        }
        #table-select-modal.open {
            display: flex; opacity: 1;
        }
        .table-select-content {
            background-color: var(--color-white); border-radius: 10px;
            padding: 20px; max-width: 90%; width: 300px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: scale(0.95); transition: transform var(--transition-speed-medium) ease;
        }
        #table-select-modal.open .table-select-content {
            transform: scale(1);
        }
        .table-select-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid var(--color-border); padding-bottom: 10px;
        }
        .table-select-header h4 { margin: 0; font-size: 1.2em; color: var(--color-darkest); }
        .table-select-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; }
        #table-list {
            max-height: 60vh; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px; padding: 5px;
        }
        .table-list-item {
            padding: 10px; border: 1px solid var(--color-border); border-radius: 5px;
            text-align: center; font-weight: bold; cursor: pointer;
            background-color: var(--color-background);
            transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }
        .table-list-item:hover {
            background-color: var(--color-lightest-green);
            color: var(--color-darkest);
            transform: scale(1.05);
        }
        .table-list-item.selected {
             background-color: var(--color-medium-green);
             color: var(--color-white);
             border-color: var(--color-dark-green);
         }

        /* --- First Load Prompt Notification --- */
        #table-prompt-notification {
            position: fixed;
            top: -100px; /* Start hidden above */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-info);
            color: var(--color-white);
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 1100;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: top var(--transition-speed-medium) ease-out, opacity var(--transition-speed-medium) ease-out;
        }
        #table-prompt-notification.show {
            top: 0;
            opacity: 1;
        }


        /* --- Responsive Adjustments --- */
        @media (min-width: 640px) {
             .bottom-menu { column-count: 3; }
             .container { padding: 0 20px; }
             #menu-name { font-size: 32px; }
             #menu-price { font-size: 20px; }
             .price-label { font-size: 0.8em; }
             .add-to-cart-button { width: 28px; height: 28px; line-height: 28px; font-size: 18px; }

             .top-section {
                 width: calc(100% + 40px);
                 margin-left: -20px; margin-right: -20px;
             }
             #menu-details {
                 margin-left: 20px; margin-right: 20px;
                 width: calc(100% - 40px);
             }
             #table-number-display {
                 font-size: 1rem; bottom: 15px; left: 15px; padding: 10px 20px;
             }
             #table-prompt-notification { font-size: 1em; }
        }
        @media (min-width: 768px) { .bottom-menu { column-count: 4; } }
        @media (min-width: 1024px) { .bottom-menu { column-count: 5; } }
        @media (min-width: 1280px) { .bottom-menu { column-count: 6; } }

    </style>
</head>
<body>
    <!-- Table Number Display (Clickable Trigger) -->
    <div id="table-number-display" title="เลือกหมายเลขโต๊ะ">
        <span id="table-number-text"><span class="placeholder-text">เลือกโต๊ะ</span></span>
    </div>

    <!-- Table Selection Modal -->
    <div id="table-select-modal">
        <div class="table-select-content">
            <div class="table-select-header">
                <h4>เลือกหมายเลขโต๊ะ</h4>
                <button class="table-select-close-btn" title="ปิด">&times;</button>
            </div>
            <div id="table-list">
                <!-- Table numbers will be populated here by JS -->
            </div>
        </div>
    </div>

    <!-- First Load Table Prompt Notification -->
    <div id="table-prompt-notification">
        <i class="fas fa-info-circle"></i> กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ
    </div>

    <div class="container">
        <!-- Top Section: Image and Details -->
        <div class="top-section">
             <div class="image-container" id="image-swipe-area">
                 <img id="main-food-image" class="main-food-image" src="https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Salad Bowl">
             </div>
             <div id="menu-details">
                 <div class="menu-name-container">
                     <h2 id="menu-name">ชื่อเมนู</h2>
                 </div>
                 <p id="menu-description">คำอธิบายเมนูอาหาร</p>
                 <p id="menu-price">
                     <span class="price-item hidden">
                         <span class="price-label" id="label-small">เล็ก:</span>
                         <span class="price-value" id="price-small">฿0</span>
                         <button class="add-to-cart-button" data-size="Small" title="เพิ่มขนาดเล็กลงตระกร้า">+</button>
                     </span>
                      <span class="price-separator hidden" id="price-sep-small">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-normal">ปกติ:</span>
                         <span class="price-value" id="price-normal">฿0</span>
                         <button class="add-to-cart-button" data-size="Normal" title="เพิ่มขนาดปกติลงตระกร้า">+</button>
                     </span>
                     <span class="price-separator hidden" id="price-sep">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-extra">พิเศษ:</span>
                         <span class="price-value" id="price-extra">฿0</span>
                         <button class="add-to-cart-button" data-size="Extra" title="เพิ่มขนาดพิเศษลงตระกร้า">+</button>
                     </span>
                     <span class="price-separator hidden" id="price-sep-family">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-family">ครอบครัว:</span>
                         <span class="price-value" id="price-family">฿0</span>
                         <button class="add-to-cart-button" data-size="Family" title="เพิ่มขนาดครอบครัวลงตระกร้า">+</button>
                     </span>
                 </p>
             </div>
        </div>

        <!-- Category Bar -->
        <div class="category-bar">
            <div class="category-item" data-category="จานหลัก"> <i class="fas fa-utensils"></i> <span>จานหลัก</span> </div>
            <div class="category-item" data-category="เฮลท์ตี้ โบวล์"> <i class="fas fa-seedling"></i> <span>เฮลท์ตี้ โบวล์</span> </div>
            <div class="category-item" data-category="ทานเล่น"> <i class="fas fa-cookie-bite"></i> <span>ทานเล่น</span> </div>
            <div class="category-item" data-category="สลัด"> <i class="fas fa-leaf"></i> <span>สลัด</span> </div>
            <div class="category-item" data-category="ทะเล"> <i class="fas fa-fish"></i> <span>ทะเล</span> </div>
            <div class="category-item" data-category="ของหวาน"> <i class="fas fa-ice-cream"></i> <span>ของหวาน</span> </div>
            <div class="category-item" data-category="เครื่องดื่ม"> <i class="fas fa-coffee"></i> <span>เครื่องดื่ม</span> </div>
         </div>

        <!-- Menu Grid -->
        <div class="bottom-menu">
            <!-- Menu items will be populated here by JS -->
        </div>

    </div> <!-- End .container -->

    <!-- Floating Call Staff Icon -->
    <div id="call-staff-icon-container" title="เรียกพนักงาน">
        <i class="fas fa-bell"></i>
    </div>

    <!-- Floating My Food Icon -->
    <div id="my-food-icon-container" title="เปิด/ปิด รายการอาหารของฉัน">
        <i class="fas fa-receipt"></i>
        <span id="my-food-item-count" class="hidden">0</span>
    </div>
    <!-- Floating Cart Icon -->
    <div id="cart-icon-container" title="เปิด/ปิด ตระกร้า">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-item-count" class="hidden">0</span>
    </div>

    <!-- My Food Popup -->
    <div id="my-food-popup">
        <div class="my-food-header">
            <h3>รายการอาหารที่สั่งแล้ว</h3>
            <button class="my-food-close-btn" title="ปิดรายการ">&times;</button>
        </div>
        <div id="my-food-items-list">
            <p class="my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>
        </div>
        <div class="my-food-footer">
            <div class="my-food-actions">
                <button class="cart-action-btn checkout-btn" id="my-food-checkout-button">ชำระเงิน</button>
            </div>
        </div>
    </div>

    <!-- Cart Popup -->
    <div id="cart-popup">
        <div class="cart-header">
            <h3>ตระกร้าสินค้า</h3>
            <button class="cart-close-btn" title="ปิดตระกร้า">&times;</button>
        </div>
        <div id="cart-items-list">
            <p class="cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>รวมทั้งหมด:</span>
                <span id="cart-total-price">฿0</span>
            </div>
            <div class="cart-actions">
                <button class="cart-action-btn order-btn" id="order-button">สั่งรายการอาหาร</button>
            </div>
        </div>
    </div>

<script>
        // ========================================================================
        // START: Configuration
        // ========================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwf4yKdxYjS1-I9NgcmW5f5RE1Hf87bioGHmbFI4HexutOzdofb9FLkB1ErzyLOzhlo/exec"; // <-- URL ของคุณ
        const TABLE_NUMBER_PREFIX = "โต๊ะ ";
        const MAX_TABLE_NUMBER = 30;
        const TABLE_SELECT_PROMPT_MESSAGE = "กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ";
        const TABLE_STORAGE_KEY = 'selectedTableData';
        const TABLE_EXPIRY_HOURS = 6;

        // Local storage keys for cart and ordered items
        const CART_LOCAL_STORAGE_KEY = 'menuCartData_v115_db'; // <-- อาจเปลี่ยนเลขเวอร์ชันถ้าต้องการล้างข้อมูลเก่า
        const ORDERED_ITEMS_LOCAL_STORAGE_KEY = 'menuOrderedItemsData_v115_db'; // <-- อาจเปลี่ยนเลขเวอร์ชัน

        // ========================================================================
        // START: Telegram Configuration (Obfuscated - Still INSECURE CLIENT-SIDE)
        // ========================================================================
        const tPart1 = 'NzA0ODk5NzkxODpB';
        const tPart2 = 'QUhZdDVqQk9HM1E2';
        const tPart3 = 'N2JwenRJbl9SR3BE';
        const tPart4 = 'Q2NYMHlBVVlWQQ==';
        const CHAT_ID = '-1002634956608';
        // ========================================================================
        // END: Telegram Configuration
        // ========================================================================

        // --- Global Data Variables ---
        let menuData = []; // Will be populated by fetch
        let allCategories = []; // Will store unique categories from fetch

        // --- State Variables ---
        let cartItems = [];
        let orderedItems = [];
        let selectedTableNumber = null;
        let currentDisplayedItemId = null;
        let currentCategory = null;
        let currentFilteredItems = [];
        let currentIndex = -1;

        // --- Swipe Detection Variables ---
        let touchStartX = 0;
        let touchEndX = 0;
        let isSwiping = false;
        const swipeThreshold = 50;

        // --- DOM Elements (Cached) ---
        const tableNumberDisplay = document.getElementById('table-number-display');
        const tableNumberText = document.getElementById('table-number-text');
        const tableSelectModal = document.getElementById('table-select-modal');
        const tableListContainer = document.getElementById('table-list');
        const tableSelectCloseBtn = tableSelectModal?.querySelector('.table-select-close-btn');
        const tablePromptNotification = document.getElementById('table-prompt-notification');
        const mainFoodImage = document.getElementById('main-food-image');
        const imageContainer = document.getElementById('image-swipe-area');
        const bottomMenu = document.querySelector('.bottom-menu');
        // Note: categoryItems querySelectorAll removed, will get dynamically generated ones later
        const menuDetailsContainer = document.getElementById('menu-details');
        const menuNameElement = document.getElementById('menu-name');
        const menuDescriptionElement = document.getElementById('menu-description');
        const menuPriceContainer = document.getElementById('menu-price');
        const priceElementsCache = { // Cache elements for price display
            'Small': { label: document.getElementById('label-small'), value: document.getElementById('price-small'), button: menuPriceContainer?.querySelector('button[data-size="Small"]'), separator: document.getElementById('price-sep-small') },
            'Normal': { label: document.getElementById('label-normal'), value: document.getElementById('price-normal'), button: menuPriceContainer?.querySelector('button[data-size="Normal"]'), separator: null },
            'Extra': { label: document.getElementById('label-extra'), value: document.getElementById('price-extra'), button: menuPriceContainer?.querySelector('button[data-size="Extra"]'), separator: document.getElementById('price-sep') },
            'Family': { label: document.getElementById('label-family'), value: document.getElementById('price-family'), button: menuPriceContainer?.querySelector('button[data-size="Family"]'), separator: document.getElementById('price-sep-family') }
        };
        const cartIconContainer = document.getElementById('cart-icon-container');
        const cartItemCountBadge = document.getElementById('cart-item-count');
        const cartPopup = document.getElementById('cart-popup');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalPriceElement = document.getElementById('cart-total-price');
        const cartCloseBtn = cartPopup?.querySelector('.cart-close-btn');
        const orderButton = document.getElementById('order-button');
        const myFoodIconContainer = document.getElementById('my-food-icon-container');
        const myFoodItemCountBadge = document.getElementById('my-food-item-count');
        const myFoodPopup = document.getElementById('my-food-popup');
        const myFoodItemsList = document.getElementById('my-food-items-list');
        const myFoodCloseBtn = myFoodPopup?.querySelector('.my-food-close-btn');
        const myFoodCheckoutButton = document.getElementById('my-food-checkout-button');
        const callStaffIconContainer = document.getElementById('call-staff-icon-container');

        // --- Utility Functions ---
        function getCurrentDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getExpiryTimestamp(hours) {
            return Date.now() + hours * 60 * 60 * 1000;
        }

        // --- Table Selection Logic ---
        function openTableSelectModal() {
            if (tableSelectModal) {
                const currentTable = selectedTableNumber;
                const listItems = tableListContainer?.querySelectorAll('.table-list-item');
                listItems?.forEach(item => {
                    item.classList.toggle('selected', item.dataset.table === currentTable);
                });
                tableSelectModal.classList.add('open');
            }
        }

        function closeTableSelectModal() {
            if (tableSelectModal) tableSelectModal.classList.remove('open');
        }

        function populateTableList(maxTables) {
            if (!tableListContainer) return;
            tableListContainer.innerHTML = '';
            for (let i = 1; i <= maxTables; i++) {
                const tableNum = String(i);
                const listItem = document.createElement('div');
                listItem.classList.add('table-list-item');
                listItem.textContent = tableNum;
                listItem.dataset.table = tableNum;
                listItem.addEventListener('click', () => selectTable(tableNum));
                tableListContainer.appendChild(listItem);
            }
        }

        function selectTable(tableNum) {
            selectedTableNumber = tableNum;
            updateTableDisplay(tableNum);
            saveSelectedTable(tableNum);
            closeTableSelectModal();
            document.title = `เมนูอาหาร - ${TABLE_NUMBER_PREFIX}${tableNum}`;
            hideTablePromptNotification();
        }

        function updateTableDisplay(tableNum) {
            if (tableNumberText) {
                if (tableNum) {
                    tableNumberText.innerHTML = `<i class="fas fa-chair table-icon"></i>${TABLE_NUMBER_PREFIX}${tableNum}`;
                    tableNumberText.classList.remove('placeholder-text');
                } else {
                    tableNumberText.innerHTML = `<span class="placeholder-text">เลือกโต๊ะ</span>`;
                    tableNumberText.classList.add('placeholder-text');
                    document.title = 'เมนูอาหาร - เลือกโต๊ะ';
                }
            }
        }

        function saveSelectedTable(tableNum) {
            const expiry = getExpiryTimestamp(TABLE_EXPIRY_HOURS);
            const data = { tableNumber: tableNum, expiry: expiry };
            try {
                localStorage.setItem(TABLE_STORAGE_KEY, JSON.stringify(data));
            } catch (error) { console.error("LS Error (Save Table):", error); }
        }

        function loadSelectedTable() {
            try {
                const storedData = localStorage.getItem(TABLE_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && parsedData.tableNumber && parsedData.expiry && Date.now() < parsedData.expiry) {
                        return parsedData.tableNumber;
                    } else { localStorage.removeItem(TABLE_STORAGE_KEY); }
                }
            } catch (error) { console.error("LS Error (Load Table):", error); localStorage.removeItem(TABLE_STORAGE_KEY); }
            return null;
        }

        function showTablePromptNotification() { if (tablePromptNotification) tablePromptNotification.classList.add('show'); }
        function hideTablePromptNotification() { if (tablePromptNotification) tablePromptNotification.classList.remove('show'); }

        // --- Fetch Menu Data from Google Sheet ---
        async function fetchMenuData() {
            console.log("Fetching menu data from Google Sheet...");
            const loadingIndicator = document.createElement('div'); // Simple text indicator
             loadingIndicator.textContent = 'กำลังโหลดเมนู...';
             loadingIndicator.style.textAlign = 'center';
             loadingIndicator.style.padding = '20px';
             loadingIndicator.style.color = 'var(--color-text-secondary)';
             const container = document.querySelector('.container');
             const categoryBarElement = document.querySelector('.category-bar');
             if (container && categoryBarElement) container.insertBefore(loadingIndicator, categoryBarElement);


            try {
                const response = await fetch(GOOGLE_SCRIPT_URL); // Using the global const
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                }
                 // Check content type BEFORE parsing
                const contentType = response.headers.get("content-type");
                 if (!contentType || !contentType.includes("application/json")) {
                    const textResponse = await response.text(); // Get text for debugging
                     console.error("Non-JSON response received:", textResponse);
                     throw new Error(`Expected JSON, but got ${contentType}. Response: ${textResponse.substring(0, 100)}...`);
                 }

                const data = await response.json();

                if (data.error) { throw new Error(`Script error: ${data.message}`); }
                if (!data || !Array.isArray(data.menuData) || !Array.isArray(data.categories)) { throw new Error("Invalid data structure received from script."); }

                console.log("Menu data fetched successfully:", data.menuData.length, "items,", data.categories.length, "categories.");
                menuData = data.menuData;
                allCategories = data.categories;
                 if (loadingIndicator) loadingIndicator.remove(); // Remove indicator on success
                return true;

            } catch (error) {
                console.error('Error fetching or processing menu data:', error);
                 if (loadingIndicator) loadingIndicator.remove(); // Remove indicator on error
                // Display specific error message
                 const errorDiv = document.createElement('div');
                 errorDiv.innerHTML = `<p style="color: red; text-align: center; padding: 20px; background-color: #ffebee; border: 1px solid red; border-radius: 5px;">
                    ❌ เกิดข้อผิดพลาดในการโหลดข้อมูลเมนู:<br><small>${error.message}</small><br>โปรดลองรีเฟรชหน้า หรือติดต่อพนักงาน</p>`;
                 if (container && categoryBarElement) {
                     container.insertBefore(errorDiv, categoryBarElement);
                 } else if (container) {
                     container.prepend(errorDiv);
                 }
                 // Clear data to prevent partial display issues
                menuData = [];
                allCategories = [];
                return false;
            }
        }

        // --- Local Storage Functions (Cart & Ordered Items) ---
        function saveCartToLocalStorage() {
            const cartData = { date: getCurrentDateString(), items: cartItems };
            try { localStorage.setItem(CART_LOCAL_STORAGE_KEY, JSON.stringify(cartData)); }
            catch (error) { console.error("LS Error (Save Cart):", error); }
        }

        function loadCartFromLocalStorage() {
            cartItems = [];
            try {
                const storedData = localStorage.getItem(CART_LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && Array.isArray(parsedData.items)) { cartItems = parsedData.items; }
                    else { localStorage.removeItem(CART_LOCAL_STORAGE_KEY); }
                }
            } catch (error) { console.error("LS Error (Load Cart):", error); localStorage.removeItem(CART_LOCAL_STORAGE_KEY); }
        }

        function saveOrderedItemsToLocalStorage() {
            const orderedData = { date: getCurrentDateString(), items: orderedItems };
            try { localStorage.setItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY, JSON.stringify(orderedData)); }
            catch (error) { console.error("LS Error (Save Ordered):", error); }
        }

        function loadOrderedItemsFromLocalStorage() {
            orderedItems = [];
            try {
                const storedData = localStorage.getItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && Array.isArray(parsedData.items)) { orderedItems = parsedData.items; }
                    else { localStorage.removeItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY); }
                }
            } catch (error) { console.error("LS Error (Load Ordered):", error); localStorage.removeItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY); }
        }

        // --- Cart Update Functions ---
        function addToCart(itemId, size) {
            const product = menuData.find(item => item.id === itemId);
            if (!product || typeof product.prices !== 'object') { console.error("Product not found:", itemId); return; }
            const price = product.prices[size];
            if (price === null || price === undefined || isNaN(price)) { console.error("Invalid price for", itemId, size, product.prices); return; }

            const cartItemId = `${itemId}-${size}`;
            const existingItemIndex = cartItems.findIndex(item => item.cartId === cartItemId);

            if (existingItemIndex > -1) { cartItems[existingItemIndex].quantity++; }
            else { cartItems.push({ cartId: cartItemId, id: product.id, name: product.name, price: price, size: size, quantity: 1 }); }

            saveCartToLocalStorage();
            renderCart();
            updateCartIconCount();
            if (cartIconContainer) { cartIconContainer.classList.add('updated'); setTimeout(() => { cartIconContainer?.classList.remove('updated'); }, 300); }
        }

        function updateQuantity(cartId, change) {
            const itemIndex = cartItems.findIndex(item => item.cartId === cartId);
            if (itemIndex > -1) {
                cartItems[itemIndex].quantity += change;
                if (cartItems[itemIndex].quantity <= 0) { cartItems.splice(itemIndex, 1); }
                saveCartToLocalStorage();
                renderCart();
                updateCartIconCount();
            }
        }

        function removeFromCart(cartId) {
             const itemIndex = cartItems.findIndex(item => item.cartId === cartId);
             if (itemIndex > -1) {
                 cartItems.splice(itemIndex, 1);
                 saveCartToLocalStorage();
                 renderCart();
                 updateCartIconCount();
             }
        }

        // --- Rendering Functions ---
        function renderCart() {
            if (!cartItemsList || !cartTotalPriceElement) return;
            cartItemsList.innerHTML = '';
            let totalPrice = 0;
            if (cartItems.length === 0) {
                cartItemsList.innerHTML = '<p class="cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>';
            } else {
                cartItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-item');
                    const itemPrice = item.price || 0;
                    const itemQuantity = item.quantity || 0;
                    const itemTotalPrice = itemPrice * itemQuantity;
                    totalPrice += itemTotalPrice;
                    itemElement.innerHTML = `
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name || 'N/A'} (${item.size || 'N/A'})</div>
                            <div class="cart-item-price">฿${itemPrice.toLocaleString()} x ${itemQuantity} = ฿${itemTotalPrice.toLocaleString()}</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="cart-quantity-btn decrease-qty" data-cartid="${item.cartId}" aria-label="ลดจำนวน">-</button>
                            <span class="cart-item-quantity">${itemQuantity}</span>
                            <button class="cart-quantity-btn increase-qty" data-cartid="${item.cartId}" aria-label="เพิ่มจำนวน">+</button>
                            <button class="cart-remove-btn" data-cartid="${item.cartId}" title="ลบรายการนี้" aria-label="ลบรายการนี้"><i class="fas fa-trash-alt"></i></button>
                        </div>`;
                    itemElement.querySelector('.decrease-qty')?.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.cartid, -1));
                    itemElement.querySelector('.increase-qty')?.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.cartid, 1));
                    itemElement.querySelector('.cart-remove-btn')?.addEventListener('click', (e) => removeFromCart(e.currentTarget.dataset.cartid));
                    cartItemsList.appendChild(itemElement);
                });
            }
             cartTotalPriceElement.textContent = `฿${totalPrice.toLocaleString()}`;
             // Enable/disable order button based on cart content and table selection
             if (orderButton) {
                 orderButton.disabled = !(cartItems.length > 0 && selectedTableNumber);
                 orderButton.title = (cartItems.length === 0) ? "ตระกร้าว่างเปล่า" : (!selectedTableNumber ? "กรุณาเลือกโต๊ะก่อน" : "สั่งรายการอาหาร");
             }
        }

        function updateCartIconCount() {
            if (!cartItemCountBadge) return;
            const totalQuantity = cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
            cartItemCountBadge.textContent = totalQuantity;
            cartItemCountBadge.classList.toggle('hidden', totalQuantity === 0);
        }

        function renderOrderedItems() {
            if (!myFoodItemsList || !myFoodCheckoutButton) return;
            myFoodItemsList.innerHTML = '';
             let hasOrderedItems = orderedItems.length > 0;

            if (!hasOrderedItems) {
                myFoodItemsList.innerHTML = '<p class="my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>';
            } else {
                let grandOrderedTotal = 0;
                orderedItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('ordered-item');
                    const itemPrice = item.price || 0;
                    const itemQuantity = item.quantity || 0;
                    const itemTotalPrice = itemPrice * itemQuantity;
                    grandOrderedTotal += itemTotalPrice;
                    itemElement.innerHTML = `
                        <div class="ordered-item-details">
                            <div class="ordered-item-name">${item.name || 'N/A'} (${item.size || 'N/A'})</div>
                            <div class="ordered-item-info">จำนวน: ${itemQuantity} (฿${itemPrice.toLocaleString()}/ชิ้น)</div>
                        </div>
                        <div class="ordered-item-total">
                           ฿${itemTotalPrice.toLocaleString()}
                        </div>`;
                    myFoodItemsList.appendChild(itemElement);
                });
                 // Optionally display total ordered amount
                 const totalDiv = document.createElement('div');
                 totalDiv.style.textAlign = 'right';
                 totalDiv.style.fontWeight = 'bold';
                 totalDiv.style.marginTop = '10px';
                 totalDiv.style.paddingTop = '10px';
                 totalDiv.style.borderTop = '1px solid var(--color-border)';
                 totalDiv.textContent = `ยอดรวมที่สั่งแล้ว: ฿${grandOrderedTotal.toLocaleString()}`;
                 myFoodItemsList.appendChild(totalDiv);
            }
             // Show/hide checkout button based on ordered items and table selection
             myFoodCheckoutButton.style.display = (hasOrderedItems && selectedTableNumber) ? 'block' : 'none';
             myFoodCheckoutButton.title = (!hasOrderedItems) ? "ไม่มีรายการที่สั่ง" : (!selectedTableNumber ? "กรุณาเลือกโต๊ะก่อน" : "เรียกชำระเงิน");
        }

        function updateMyFoodIconCount() {
             if (!myFoodItemCountBadge) return;
             const totalQuantity = orderedItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
             myFoodItemCountBadge.textContent = totalQuantity;
             myFoodItemCountBadge.classList.toggle('hidden', totalQuantity === 0);
             if (totalQuantity > 0 && myFoodIconContainer) {
                 myFoodIconContainer.classList.add('updated');
                 setTimeout(() => { myFoodIconContainer?.classList.remove('updated'); }, 300);
             }
         }

        function showItemDetails(index, direction = 'none') {
            // Ensure all required elements exist
            if (!menuDetailsContainer || !mainFoodImage || !menuNameElement || !menuDescriptionElement || !menuPriceContainer || !imageContainer) {
                console.error("Missing essential elements for showItemDetails.");
                return;
            }
            if (index < 0 || index >= currentFilteredItems.length) {
                 // Optionally hide details if index is invalid or list is empty
                 menuDetailsContainer.style.display = 'none';
                 mainFoodImage.src = ''; // Clear image
                 mainFoodImage.alt = '';
                 currentDisplayedItemId = null;
                 currentIndex = -1;
                 console.log("No item to display or index out of bounds.");
                 return;
            }

            currentIndex = index;
            const itemData = currentFilteredItems[currentIndex];
             if (!itemData) { // Double check itemData exists
                 console.error("Item data not found at index:", index);
                 menuDetailsContainer.style.display = 'none';
                 return;
             }
            currentDisplayedItemId = itemData.id;

            const newImageSrc = itemData.dataImageSrc || itemData.src || 'placeholder.jpg'; // Add placeholder fallback
            const currentImageSrc = mainFoodImage.getAttribute('src');

            const updateImageElement = (src, alt) => {
                mainFoodImage.src = src;
                 mainFoodImage.alt = alt || itemData.name || 'Menu item image'; // Better alt text fallback
                 mainFoodImage.onerror = () => { // Handle image loading errors
                     console.warn(`Image failed to load: ${src}. Using placeholder.`);
                     mainFoodImage.src = 'placeholder.jpg'; // Path to your placeholder
                     mainFoodImage.alt = `${itemData.name || 'Menu item'} (Image unavailable)`;
                 };
            };

            // Handle image transition/update
            imageContainer.classList.remove('slide-out-left', 'slide-in-right', 'slide-out-right', 'slide-in-left'); // Reset animations
            if (direction !== 'none' && currentImageSrc && currentImageSrc !== newImageSrc && currentImageSrc !== 'placeholder.jpg') {
                let outClass = direction === 'next' ? 'slide-out-left' : 'slide-out-right';
                let inClass = direction === 'next' ? 'slide-in-right' : 'slide-in-left';

                 // Use requestAnimationFrame for smoother animation triggering
                 requestAnimationFrame(() => {
                    imageContainer.classList.add(outClass);
                     // Use 'animationend' event for reliability
                     const handleOutAnimationEnd = (event) => {
                         // Ensure the event is for the image container itself if needed
                         if (event.target !== imageContainer) return;

                         imageContainer.removeEventListener('animationend', handleOutAnimationEnd);
                         imageContainer.classList.remove(outClass);
                         updateImageElement(newImageSrc, itemData.alt);

                         requestAnimationFrame(() => {
                             imageContainer.classList.add(inClass);
                             const handleInAnimationEnd = (eventInner) => {
                                 if (eventInner.target !== imageContainer) return;
                                 imageContainer.removeEventListener('animationend', handleInAnimationEnd);
                                 imageContainer.classList.remove(inClass);
                             };
                             imageContainer.addEventListener('animationend', handleInAnimationEnd, { once: true }); // Use once: true
                         });
                     };
                     imageContainer.addEventListener('animationend', handleOutAnimationEnd, { once: true }); // Use once: true
                 });
            } else {
                 // No animation needed, just update
                 updateImageElement(newImageSrc, itemData.alt);
            }

            // Update Text Details
            menuNameElement.textContent = itemData.name || 'ชื่อเมนู';
            menuDescriptionElement.textContent = itemData.description || 'ไม่มีคำอธิบาย';

            // Update Prices
            const prices = itemData.prices || {};
            const displayOrder = ['Small', 'Normal', 'Extra', 'Family'];
            let firstVisibleFound = false;

             // Hide all price items and separators initially
             displayOrder.forEach(size => {
                 const cache = priceElementsCache[size];
                 if (cache) {
                     cache.label?.closest('.price-item')?.classList.add('hidden');
                     if (cache.separator) cache.separator.classList.add('hidden');
                     // Ensure all separators are hidden
                     if (size === 'Extra' && priceElementsCache['Small']?.separator) priceElementsCache['Small'].separator.classList.add('hidden'); // The small one
                     if (size === 'Family' && priceElementsCache['Extra']?.separator) priceElementsCache['Extra'].separator.classList.add('hidden'); // The normal/extra one
                 }
             });

            // Show relevant prices and determine separator visibility
             displayOrder.forEach(size => {
                 const cache = priceElementsCache[size];
                 if (cache && cache.label && cache.value && cache.button) {
                     const priceValue = prices[size];
                     const parentSpan = cache.label.closest('.price-item');
                     if (parentSpan) {
                         if (priceValue !== null && priceValue !== undefined && !isNaN(priceValue)) {
                             cache.value.textContent = `฿${Number(priceValue).toLocaleString()}`; // Format price
                             parentSpan.classList.remove('hidden');

                             // Show separator *before* this item if it's not the first visible one
                             if (firstVisibleFound) {
                                 if (size === 'Normal' && priceElementsCache['Small']?.separator) priceElementsCache['Small'].separator.classList.remove('hidden');
                                 else if (size === 'Extra' && priceElementsCache['Extra']?.separator) priceElementsCache['Extra'].separator.classList.remove('hidden');
                                 else if (size === 'Family' && priceElementsCache['Family']?.separator) priceElementsCache['Family'].separator.classList.remove('hidden');
                             }
                             firstVisibleFound = true; // Mark that we found the first visible item
                         }
                     }
                 }
             });

            menuDetailsContainer.style.display = 'block'; // Show the details container
        }

        function displayMenuItems(category) {
            if (!bottomMenu) { console.error("Bottom menu element not found."); return; }
            bottomMenu.innerHTML = ''; // Clear previous items
            currentCategory = category;
             // Ensure menuData is populated
             if (!menuData || menuData.length === 0) {
                 console.warn("menuData is empty, cannot display items for category:", category);
                 bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีข้อมูลเมนู</p>';
                 if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
                 currentFilteredItems = [];
                 currentDisplayedItemId = null; currentIndex = -1;
                 return;
             }

            currentFilteredItems = menuData.filter(item => Array.isArray(item.category) && item.category.includes(category));

            if (currentFilteredItems.length === 0) {
                 bottomMenu.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูในหมวดหมู่ "${category}"</p>`;
                 if(menuDetailsContainer) menuDetailsContainer.style.display = 'none';
                 currentDisplayedItemId = null; currentIndex = -1;
                 return;
            }

            // Use DocumentFragment for performance when adding multiple items
            const fragment = document.createDocumentFragment();
            currentFilteredItems.forEach((item, index) => {
                const menuItemDiv = document.createElement('div');
                menuItemDiv.classList.add('menu-item');
                menuItemDiv.dataset.itemId = item.id;
                menuItemDiv.dataset.index = index;

                const img = document.createElement('img');
                img.src = item.src || 'placeholder.jpg'; // Fallback src
                img.alt = item.alt || item.name || 'Menu item'; // Fallback alt
                img.loading = 'lazy';
                 img.onerror = function() { // Handle image errors for thumbnails too
                     this.src='placeholder.jpg';
                     this.alt = `${item.name || 'Menu item'} (Image unavailable)`;
                };

                menuItemDiv.appendChild(img);
                 menuItemDiv.addEventListener('click', () => { // Add listener directly
                     // Use closure to capture the correct index
                     const clickedIndex = parseInt(menuItemDiv.dataset.index, 10);
                     if (!isNaN(clickedIndex) && clickedIndex >= 0 && clickedIndex < currentFilteredItems.length) {
                         showItemDetails(clickedIndex);
                         // Smooth scroll to top might be jarring, consider alternatives or remove
                         requestAnimationFrame(() => {
                             window.scrollTo({ top: 0, behavior: 'smooth' });
                         });
                     } else { console.error("Invalid index on menu item click:", menuItemDiv.dataset.index); }
                 });
                fragment.appendChild(menuItemDiv);
            });
            bottomMenu.appendChild(fragment); // Append all items at once

            // Show details of the first item after rendering the grid
            if (currentFilteredItems.length > 0) {
                showItemDetails(0);
            } else { // Should be caught above, but as a safeguard
                if(menuDetailsContainer) menuDetailsContainer.style.display = 'none';
                currentDisplayedItemId = null; currentIndex = -1;
            }
        }

        function showPreviousItem() {
            if (currentFilteredItems.length <= 1 || currentIndex < 0) return;
            let newIndex = (currentIndex - 1 + currentFilteredItems.length) % currentFilteredItems.length;
            showItemDetails(newIndex, 'prev');
        }

        function showNextItem() {
            if (currentFilteredItems.length <= 1 || currentIndex < 0) return;
            let newIndex = (currentIndex + 1) % currentFilteredItems.length;
            showItemDetails(newIndex, 'next');
        }

        // --- Populate Category Bar Dynamically --- [NEW FUNCTION]
         function populateCategoryBar() {
            const categoryBar = document.querySelector('.category-bar');
            if (!categoryBar || !allCategories || allCategories.length === 0) {
                console.warn("Category bar element not found or no categories fetched.");
                if (categoryBar) categoryBar.innerHTML = '<p style="color: var(--color-text-secondary); padding: 10px;">ไม่มีหมวดหมู่</p>';
                return;
            }

            categoryBar.innerHTML = ''; // Clear existing static categories

            // --- Icon Mapping (Customize as needed) ---
            // *** สำคัญ: แก้ไข/เพิ่มการจับคู่ ไอคอน <=> ชื่อหมวดหมู่ ตรงนี้ให้ตรงกับใน Google Sheet ***
             const categoryIcons = {
                 "จานหลัก": "fas fa-utensils",
                 "เฮลท์ตี้ โบวล์": "fas fa-seedling",
                 "ทานเล่น": "fas fa-cookie-bite",
                 "สลัด": "fas fa-leaf",
                 "ทะเล": "fas fa-fish",
                 "ของหวาน": "fas fa-ice-cream",
                 "เครื่องดื่ม": "fas fa-coffee",
                 "ซุป": "fas fa-mug-hot", // << ตัวอย่าง: เพิ่ม mapping ถ้ามีหมวดหมู่นี้
                 // เพิ่ม mapping อื่นๆ ตามต้องการ
                 "default": "fas fa-question-circle" // ไอคอนเริ่มต้น ถ้าไม่พบ mapping
             };
            // --- End Icon Mapping ---

            const fragment = document.createDocumentFragment();
            allCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('category-item');
                categoryDiv.dataset.category = category; // Use dataset for category name

                const iconClass = categoryIcons[category] || categoryIcons["default"];
                categoryDiv.innerHTML = `
                    <i class="${iconClass}"></i>
                    <span>${category}</span>
                `;

                categoryDiv.addEventListener('click', handleCategoryClick); // Add listener
                fragment.appendChild(categoryDiv);
            });
             categoryBar.appendChild(fragment); // Add all categories at once
         }

        // --- Handle Category Click (For dynamic categories) --- [NEW FUNCTION]
         function handleCategoryClick(event) {
             const clickedItem = event.currentTarget;
             const selectedCategory = clickedItem.dataset.category;

             // Visually select the clicked item
             const allDynamicCategoryItems = document.querySelectorAll('.category-bar .category-item');
             allDynamicCategoryItems.forEach(cat => cat.classList.remove('selected'));
             clickedItem.classList.add('selected');

             // Update the displayed menu items
             displayMenuItems(selectedCategory);

             // Note: showItemDetails(0) is called within displayMenuItems if items exist
         }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            // Table Selection
            tableNumberDisplay?.addEventListener('click', openTableSelectModal);
            tableSelectCloseBtn?.addEventListener('click', closeTableSelectModal);
            tableSelectModal?.addEventListener('click', (e) => { if (e.target === tableSelectModal) closeTableSelectModal(); });
            tablePromptNotification?.addEventListener('click', hideTablePromptNotification);
            tablePromptNotification?.addEventListener('touchstart', hideTablePromptNotification, { passive: true });

            // Add to Cart Buttons (in Menu Details) - Delegated listener
             menuPriceContainer?.addEventListener('click', (e) => {
                 if (e.target && e.target.classList.contains('add-to-cart-button')) {
                     const size = e.target.dataset.size;
                     if (currentDisplayedItemId && size) {
                         addToCart(currentDisplayedItemId, size);
                     } else { console.warn("Cannot add to cart. Missing item ID or size."); }
                 }
             });

            // --- REMOVED STATIC CATEGORY LISTENERS ---
            // The listeners for categories are now added dynamically in populateCategoryBar

            // Cart Icon & Popup
            cartIconContainer?.addEventListener('click', () => {
                myFoodPopup?.classList.remove('open'); // Close other popups
                cartPopup?.classList.toggle('open');
                if (cartPopup?.classList.contains('open')) renderCart();
            });
            cartCloseBtn?.addEventListener('click', () => cartPopup?.classList.remove('open'));

            // My Food Icon & Popup
            myFoodIconContainer?.addEventListener('click', () => {
                cartPopup?.classList.remove('open'); // Close other popups
                myFoodPopup?.classList.toggle('open');
                if (myFoodPopup?.classList.contains('open')) renderOrderedItems();
            });
            myFoodCloseBtn?.addEventListener('click', () => myFoodPopup?.classList.remove('open'));

            // Call Staff Icon
            callStaffIconContainer?.addEventListener('click', () => {
                cartPopup?.classList.remove('open');
                myFoodPopup?.classList.remove('open');
                handleCallStaff();
            });

            // Image Swipe Listeners
            if (imageContainer) {
                imageContainer.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; isSwiping = true; } }, { passive: true });
                imageContainer.addEventListener('touchmove', (e) => { if (isSwiping && e.touches.length === 1) touchEndX = e.touches[0].clientX; }, { passive: true });
                imageContainer.addEventListener('touchend', (e) => {
                    if (!isSwiping || e.changedTouches.length !== 1) { isSwiping = false; return; }
                    touchEndX = e.changedTouches[0].clientX;
                    const deltaX = touchEndX - touchStartX;
                    if (Math.abs(deltaX) > swipeThreshold) { if (deltaX > 0) showPreviousItem(); else showNextItem(); }
                    isSwiping = false; touchStartX = 0; touchEndX = 0;
                });
                // Add Mouse Drag support for Desktops (Optional but nice)
                 let isDragging = false;
                 let dragStartX = 0;
                 imageContainer.addEventListener('mousedown', (e) => {
                     isDragging = true;
                     dragStartX = e.clientX;
                     imageContainer.style.cursor = 'grabbing'; // Change cursor
                 });
                 imageContainer.addEventListener('mousemove', (e) => {
                     if (!isDragging) return;
                     // Optional: Add visual feedback during drag if needed
                 });
                 imageContainer.addEventListener('mouseup', (e) => {
                     if (!isDragging) return;
                     isDragging = false;
                     const dragEndX = e.clientX;
                     const deltaX = dragEndX - dragStartX;
                     imageContainer.style.cursor = 'grab'; // Restore cursor
                     if (Math.abs(deltaX) > swipeThreshold) { if (deltaX > 0) showPreviousItem(); else showNextItem(); }
                 });
                 imageContainer.addEventListener('mouseleave', () => { // Reset if mouse leaves while dragging
                     if (isDragging) {
                         isDragging = false;
                         imageContainer.style.cursor = 'grab';
                     }
                 });
            }

            // Order Button (in Cart)
            orderButton?.addEventListener('click', handleOrderSubmission);

            // Checkout Button (in My Food)
            myFoodCheckoutButton?.addEventListener('click', handleCheckout);
            console.log("Event listeners setup complete.");
        }

        // --- Action Handlers (Telegram, Order, Checkout) ---
        // Function to decode the token (slightly safer than global vars)
        function getTelegramToken() {
            try { return atob(tPart1) + atob(tPart2) + atob(tPart3) + atob(tPart4); }
            catch (e) { console.error("Error decoding token:", e); return null; }
        }

        async function sendTelegramMessage(messageText, buttonElement = null, loadingText = 'กำลังส่ง...') {
            if (!selectedTableNumber) {
                alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ');
                openTableSelectModal();
                return false; // Indicate failure
            }

            const token = getTelegramToken();
            if (!token) { alert("🚨 ข้อผิดพลาด: Token ไม่ถูกต้อง"); return false; }

             // Disable button and show loading state if provided
            let originalButtonText = '';
            if (buttonElement) {
                if (buttonElement.disabled) { console.log("Action already in progress."); return false; } // Prevent double submit
                 originalButtonText = buttonElement.textContent;
                 buttonElement.disabled = true;
                 buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
             }

            const telegramApiUrl = `https://api.telegram.org/bot${token}/sendMessage`;
            const payload = { chat_id: CHAT_ID, text: messageText, parse_mode: 'Markdown' };

            try {
                console.log("Sending Telegram message:", payload);
                const response = await fetch(telegramApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                console.log("Telegram response:", result);

                if (!result.ok) {
                    throw new Error(result.description || 'Unknown Telegram API error');
                }
                return true; // Indicate success
            } catch (error) {
                console.error('Error sending Telegram message:', error);
                alert(`🚨 เกิดข้อผิดพลาดในการสื่อสาร (${TABLE_NUMBER_PREFIX}${selectedTableNumber}): ${error.message}. กรุณาลองใหม่อีกครั้ง`);
                return false; // Indicate failure
            } finally {
                 // Re-enable button if provided
                 if (buttonElement) {
                     buttonElement.disabled = false;
                     buttonElement.innerHTML = originalButtonText; // Restore original content (might need adjustment if original had icon)
                 }
            }
        }

        async function handleCallStaff() {
            let callStaffMessage = `🚨 *!! เรียกพนักงาน !!* 🚨\n`;
            callStaffMessage += `------------------------------------\n`;
            callStaffMessage += `โต๊ะ: *${selectedTableNumber}* ต้องการความช่วยเหลือ\n`;
            callStaffMessage += `------------------------------------\n`;
            callStaffMessage += `_(เวลา: ${new Date().toLocaleString('th-TH', { timeStyle: 'medium' })})_`;

            const success = await sendTelegramMessage(callStaffMessage, callStaffIconContainer, ''); // No text for icon button loading

             if (success) {
                 alert('✅ เรียกพนักงานบริการให้เรียบร้อยค่ะ กรุณารอสักครู่ 💁‍♀️');
             }
             // Reset icon if sendTelegramMessage didn't (e.g., error before fetch)
             if (callStaffIconContainer && !callStaffIconContainer.querySelector('.fa-bell')) {
                callStaffIconContainer.innerHTML = '<i class="fas fa-bell"></i>';
             }
        }

        async function handleOrderSubmission() {
             if (cartItems.length === 0) { alert('ตระกร้าสินค้าของคุณว่างเปล่า'); return; }

            // --- Construct Order Message ---
            let orderMessage = `*โต๊ะ ${selectedTableNumber} - รายการสั่งซื้อใหม่* ✨\n`;
            orderMessage += `------------------------------------\n`;
            let total = 0;
            cartItems.forEach((item, index) => {
                const itemPrice = item.price || 0;
                const itemQuantity = item.quantity || 0;
                const lineTotal = itemPrice * itemQuantity;
                orderMessage += `*${index + 1}. ${item.name || 'N/A'}* (${item.size || 'N/A'})\n`;
                orderMessage += `   (จำนวน: ${itemQuantity} x ฿${itemPrice.toLocaleString()} = *฿${lineTotal.toLocaleString()}*)\n\n`;
                total += lineTotal;
            });
            orderMessage += `------------------------------------\n`;
            orderMessage += `*ยอดรวม: ฿${total.toLocaleString()}*\n`;
            orderMessage += `_(สั่งเมื่อ: ${new Date().toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'medium' })})_`;

            // --- Send Message and Process Result ---
             const success = await sendTelegramMessage(orderMessage, orderButton, 'กำลังสั่ง...');

            if (success) {
                alert(`ส่งรายการสั่งซื้อจาก ${TABLE_NUMBER_PREFIX}${selectedTableNumber} สำเร็จ!`);

                // Move items from cart to ordered list
                cartItems.forEach(cartItem => {
                    const existingIndex = orderedItems.findIndex(orderedItem => orderedItem.cartId === cartItem.cartId);
                    if (existingIndex > -1) {
                        orderedItems[existingIndex].quantity += cartItem.quantity;
                    } else {
                        orderedItems.push({ ...cartItem });
                    }
                });
                cartItems = []; // Clear cart

                saveCartToLocalStorage();
                saveOrderedItemsToLocalStorage();
                renderCart(); // Update cart UI (now empty)
                updateCartIconCount();
                updateMyFoodIconCount(); // Update ordered items badge
                if (cartPopup) cartPopup.classList.remove('open'); // Close cart popup
             }
             // Re-enable button if needed (sendTelegramMessage handles this now)
             // if (orderButton) orderButton.disabled = false; // Redundant if using buttonElement in sendTelegramMessage
         }

        async function handleCheckout() { // Changed to async for potential future API calls
             if (orderedItems.length === 0) { alert('ยังไม่มีรายการอาหารที่สั่งสำหรับชำระเงิน'); return; }

             // --- Construct Checkout Message ---
             let checkoutMessage = `💰 *!! เรียกชำระเงิน !!* 💰\n`;
             checkoutMessage += `------------------------------------\n`;
             checkoutMessage += `โต๊ะ: *${selectedTableNumber}*\n`;
              checkoutMessage += `------------------------------------\n`;
             let orderedTotal = 0;
             orderedItems.forEach((item, index) => {
                 const itemPrice = item.price || 0;
                 const itemQuantity = item.quantity || 0;
                 const lineTotal = itemPrice * itemQuantity;
                 checkoutMessage += `*${index + 1}. ${item.name || 'N/A'}* (${item.size || 'N/A'}) - ${itemQuantity} x ฿${itemPrice.toLocaleString()} = *฿${lineTotal.toLocaleString()}*\n`;
                 orderedTotal += lineTotal;
             });
             checkoutMessage += `------------------------------------\n`;
             checkoutMessage += `*ยอดรวมที่สั่งแล้ว: ฿${orderedTotal.toLocaleString()}*\n`;
             checkoutMessage += `_(เวลาเรียกชำระเงิน: ${new Date().toLocaleString('th-TH', { timeStyle: 'medium' })})_`;

              // --- Send Message ---
             const success = await sendTelegramMessage(checkoutMessage, myFoodCheckoutButton, 'กำลังเรียก...');

             if (success) {
                 alert(`✅ เรียกพนักงานเพื่อชำระเงินสำหรับ ${TABLE_NUMBER_PREFIX}${selectedTableNumber} เรียบร้อยแล้วค่ะ`);
                 // Optionally clear orderedItems here or leave them until payment is confirmed
                 // orderedItems = [];
                 // saveOrderedItemsToLocalStorage();
                 // renderOrderedItems();
                 // updateMyFoodIconCount();
                 if (myFoodPopup) myFoodPopup.classList.remove('open'); // Close popup
             }
              // Re-enable button if needed (sendTelegramMessage handles this now)
             // if (myFoodCheckoutButton) myFoodCheckoutButton.disabled = false; // Redundant
         }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => { // <-- Made async
            console.log("DOM Content Loaded. Initializing...");

            // 1. Fetch menu data FIRST and wait for it
            const dataLoaded = await fetchMenuData(); // <-- Call fetchMenuData

            // 2. Load table number AFTER data fetch attempt (can proceed even if fetch fails)
            selectedTableNumber = loadSelectedTable();
            updateTableDisplay(selectedTableNumber);
            populateTableList(MAX_TABLE_NUMBER);
            if (!selectedTableNumber) showTablePromptNotification();
            else document.title = `เมนูอาหาร - ${TABLE_NUMBER_PREFIX}${selectedTableNumber}`;

            // 3. Load local data AFTER data fetch attempt
            loadCartFromLocalStorage();
            loadOrderedItemsFromLocalStorage();

            // 4. Populate dynamic categories only IF data loaded successfully
            if (dataLoaded) {
                populateCategoryBar(); // <-- Populate categories dynamically
            } else {
                // Handle UI when categories fail to load (e.g., show error in category bar)
                 const categoryBarElement = document.querySelector('.category-bar');
                 if (categoryBarElement) categoryBarElement.innerHTML = '<p style="color: red; padding: 10px;">⚠ ไม่สามารถโหลดหมวดหมู่ได้</p>';
                 if (bottomMenu) bottomMenu.innerHTML = ''; // Clear bottom menu as well
                 if (menuDetailsContainer) menuDetailsContainer.style.display = 'none'; // Hide details
            }

            // 5. Render UI based on loaded local data (cart, ordered items)
            renderCart(); // Render even if data fetch failed (cart might exist)
            updateCartIconCount();
            renderOrderedItems();
            updateMyFoodIconCount();

            // 6. Display initial category/menu IF data loaded successfully
            if (dataLoaded && allCategories.length > 0) {
                 const categoryItemsDynamic = document.querySelectorAll('.category-bar .category-item');
                 if (categoryItemsDynamic.length > 0) {
                     const initialCategoryElement = categoryItemsDynamic[0];
                     const initialCategory = initialCategoryElement.dataset.category;
                     initialCategoryElement.classList.add('selected'); // Select the first one
                     displayMenuItems(initialCategory); // Display items for the first category
                 } else {
                     // This case shouldn't happen if allCategories has items, but good to handle
                     if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">ไม่มีเมนูให้แสดง</p>';
                     if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
                 }
            } else if (dataLoaded && allCategories.length === 0) {
                 // Data loaded, but script returned no categories
                 console.warn("Data loaded, but no categories found.");
                 if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">ไม่มีเมนูให้แสดง</p>';
                 if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
            }
            // Note: If !dataLoaded, error message is already shown by fetchMenuData

            // 7. Setup all other event listeners (needs to run regardless of data fetch success)
            setupEventListeners();

            console.log("Initialization complete.");
        });

    </script>
</body>
</html>
