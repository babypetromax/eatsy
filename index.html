<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เมนูอาหาร</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles --- */
        :root {
            /* Theme Colors */
            --color-darkest: #333D29;
            --color-dark-green: #414833;
            --color-medium-green: #656D4A;
            --color-light-green: #A4AC86; /* Used for Order Button */
            --color-lightest-green: #C2C5AA;
            --color-light-beige: #B6AD90; /* Used for Cart Header */
            --color-medium-beige: #A68A64; /* Color for Price and Checkout Button */
            --color-text-primary: #343A40;
            --color-text-secondary: #6C757D;
            --color-background: #F8F9FA;
            --color-white: #FFFFFF;
            --color-white-transparent: rgba(255, 255, 255, 0.9); /* Cart background */
            --color-footer-transparent: rgba(248, 249, 250, 0.9); /* Cart footer background */
            --color-border: #dee2e6;
            --color-danger: #dc3545; /* Red for remove/delete actions */
            --color-info: #17a2b8; /* Info color for prompts */
            --color-modal-bg: rgba(0, 0, 0, 0.6);
            /* Transitions */
            --transition-speed-fast: 0.2s;
            --transition-speed-medium: 0.3s;
            --transition-speed-slow: 0.5s;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--color-background); color: var(--color-text-primary);
            overscroll-behavior-y: contain;
            padding-bottom: 225px; /* Adjusted space for floating icons */
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 10px; }

        /* --- Top Section --- */
        .top-section {
            width: calc(100% + 20px); margin-bottom: 15px; position: relative;
            margin-left: -10px; margin-right: -10px;
        }
        .image-container {
            width: 100%; aspect-ratio: 5 / 4; overflow: hidden;
            background-color: #e0e0e0; position: relative; cursor: grab;
        }
        .image-container:active { cursor: grabbing; }
        .main-food-image {
            width: 100%; height: 100%; object-fit: cover; object-position: center;
            display: block;
        }

        /* --- Swipe Animation Classes --- */
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-container.slide-out-left .main-food-image { animation: slideOutLeft var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-right .main-food-image { animation: slideInRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-out-right .main-food-image { animation: slideOutRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-left .main-food-image { animation: slideInLeft var(--transition-speed-medium) ease-out forwards; }

        /* --- Menu Details --- */
        #menu-details {
            padding: 15px 10px; background-color: var(--color-white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); display: none;
             margin-left: 10px; margin-right: 10px;
             width: calc(100% - 20px); border-radius: 0 0 10px 10px;
        }
        .menu-name-container { margin-bottom: 5px; }
        #menu-name { font-size: 28px; font-weight: bold; text-transform: uppercase; margin: 0; color: var(--color-darkest); line-height: 1.2; }
        #menu-description { font-size: 14px; margin: 0 0 10px 0; color: var(--color-medium-green); line-height: 1.5; }
        #menu-price { font-size: 18px; font-weight: bold; margin: 0; color: var(--color-medium-beige); display: flex; align-items: center; flex-wrap: wrap; gap: 5px 0; }
        .price-item { display: inline-flex; align-items: center; margin-right: 10px; }
        .price-label { font-size: 0.8em; font-weight: normal; color: var(--color-text-secondary); margin-right: 4px; }
        .price-value { margin-right: 5px; }
        .add-to-cart-button {
            background-color: var(--color-medium-green); color: var(--color-white); border: none; border-radius: 50%;
            width: 24px; height: 24px; font-size: 16px; font-weight: bold; line-height: 24px; text-align: center;
            cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            padding: 0; flex-shrink: 0;
        }
        .add-to-cart-button:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        .price-separator { margin: 0 8px; font-weight: normal; color: #adb5bd; }
        .hidden { display: none !important; }

        /* --- Category Bar --- */
        .category-bar {
            width: 100%; overflow-x: auto; overflow-y: hidden; white-space: nowrap; background-color: var(--color-white);
            padding: 12px 5px; display: flex; align-items: center; flex-shrink: 0; box-sizing: border-box;
            border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }
        .category-item {
            display: flex; flex-direction: column; align-items: center; padding: 8px 15px; margin: 0 5px;
            background-color: transparent; color: var(--color-text-secondary); border-radius: 8px; cursor: pointer;
            flex-shrink: 0; font-size: 0.85em; text-align: center;
            transition: background-color var(--transition-speed-medium) ease, color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
            border-bottom: 2px solid transparent;
        }
        .category-item.selected { color: var(--color-dark-green); font-weight: bold; border-bottom: 2px solid var(--color-medium-green); background-color: #E9ECEF; }
        .category-item i { font-size: 1.4em; margin-bottom: 4px; }
        .category-item span { font-size: 0.75em; white-space: normal; line-height: 1.2; }
        .category-item:hover:not(.selected) { color: #495057; background-color: #F1F3F4; transform: translateY(-2px); }

        /* --- Pinterest-Style Menu Grid --- */
        .bottom-menu {
            width: 100%; padding-top: 10px; column-count: 2;
            column-gap: 10px; contain: layout paint;
        }
        .menu-item {
            display: inline-block; width: 100%; margin-bottom: 10px; border-radius: 10px; overflow: hidden;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform var(--transition-speed-fast) ease-in-out, box-shadow var(--transition-speed-fast) ease-in-out, filter var(--transition-speed-fast) ease-in-out;
            break-inside: avoid;
        }
        .menu-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.05); }
        /* --- Add explicit width and height for images --- */
        .menu-item img {
            width: 100%;
            height: auto; /* Maintain aspect ratio, but consider setting fixed height if possible */
            display: block;
            aspect-ratio: attr(width) / attr(height); /* Helps reserve space if browser supports it */
        }

        /* --- Floating Icons --- */
        .floating-icon {
             position: fixed; right: 20px;
             background-color: var(--color-medium-green); color: var(--color-white);
             width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
             cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
             transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease;
             z-index: 1000;
             border: none; /* Ensure buttons don't have default borders */
             padding: 0; /* Ensure buttons don't have default padding */
         }
         .floating-icon:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
         .floating-icon .badge {
             position: absolute; top: -5px; right: -5px; background-color: var(--color-danger); color: white;
             border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold;
             display: flex; justify-content: center; align-items: center; line-height: 22px; border: 1px solid white;
             transition: transform var(--transition-speed-fast) ease;
         }
         .floating-icon.updated .badge { transform: scale(1.3); }
         /* Ensure disabled state is visually clear */
        .floating-icon:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--color-medium-green); /* Keep base color or slightly greyed out */
            transform: none; /* Disable hover transform */
        }
        .floating-icon:disabled:hover {
             background-color: var(--color-medium-green); /* Prevent hover color change when disabled */
             transform: none;
         }


         #call-staff-icon-container { bottom: 150px; z-index: 1002; font-size: 22px; }
         #my-food-icon-container { bottom: 85px; z-index: 1001; font-size: 22px; }
         #cart-icon-container { bottom: 20px; z-index: 1000; font-size: 24px; }

        /* Spinner for loading state on icons */
         .floating-icon .fa-spinner { font-size: 24px; }

        /* --- Popups (Cart & My Food) --- */
        .popup-container {
            position: fixed; right: 20px; width: 90%; max-width: 380px;
            background-color: var(--color-white-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none; flex-direction: column; overflow: hidden;
            opacity: 0; transform: translateY(20px) scale(0.95);
            transition: opacity var(--transition-speed-medium) ease-out, transform var(--transition-speed-medium) ease-out, bottom var(--transition-speed-medium) ease-out;
            pointer-events: none;
        }
        .popup-container.open { display: flex; opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

        #cart-popup { bottom: 215px; max-height: 45vh; z-index: 998; }
        #my-food-popup { bottom: 150px; max-height: 50vh; z-index: 999; }

        .popup-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--color-border); border-radius: 10px 10px 0 0; flex-shrink: 0;
        }
        .popup-header h3 { margin: 0; font-size: 1.1em; color: var(--color-darkest); }
        .popup-close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; }

        #cart-popup .popup-header { background-color: rgba(182, 173, 144, 0.8); } /* Specific header color */
        #my-food-popup .popup-header { background-color: rgba(164, 172, 134, 0.8); } /* Specific header color */

        .popup-items-list { padding: 5px 15px; overflow-y: auto; flex-grow: 1; }
        .popup-empty-message { text-align: center; color: var(--color-text-secondary); padding: 20px; }

        /* Cart Item Specific Styles */
        .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-details { flex-grow: 1; margin-right: 10px; }
        .cart-item-name { font-weight: bold; color: var(--color-dark-green); }
        .cart-item-price { color: var(--color-medium-beige); font-size: 0.9em; }
        .cart-item-controls { display: flex; align-items: center; flex-shrink: 0; }
        .cart-quantity-btn {
            background-color: #e9ecef; color: var(--color-text-secondary); border: 1px solid var(--color-border);
            border-radius: 4px; width: 25px; height: 25px; font-size: 16px; cursor: pointer;
            margin: 0 5px; line-height: 23px; text-align: center; transition: background-color var(--transition-speed-fast) ease;
        }
        .cart-quantity-btn:hover { background-color: #ced4da; }
        .cart-item-quantity { min-width: 20px; text-align: center; font-weight: bold; }
         .cart-remove-btn { background: none; border: none; color: var(--color-danger); font-size: 16px; cursor: pointer; margin-left: 10px; transition: color var(--transition-speed-fast) ease; padding: 0; }
         .cart-remove-btn:hover { color: #a0232f; }

         /* Ordered Item Specific Styles */
        .ordered-item {
            padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ordered-item:last-child { border-bottom: none; }
        .ordered-item-details { flex-grow: 1; margin-right: 10px; }
        .ordered-item-name { font-weight: bold; color: var(--color-dark-green); }
        .ordered-item-info { color: var(--color-medium-beige); font-size: 0.9em; }
        .ordered-item-total { font-weight: bold; color: var(--color-medium-beige); flex-shrink: 0;}
        #ordered-grand-total { text-align: right; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--color-border);}


        /* Popup Footer */
        .popup-footer {
            padding: 15px; border-top: 1px solid var(--color-border); background-color: var(--color-footer-transparent);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 0 0 10px 10px; flex-shrink: 0;
        }
        .cart-total { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
        .popup-actions { display: flex; justify-content: center; gap: 10px; }
        .popup-action-btn {
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-size: 0.9em; transition: opacity 0.2s ease, background-color 0.2s ease; flex-grow: 1; margin: 0;
        }
        .popup-action-btn:hover:not(:disabled) { opacity: 0.85; }
        .popup-action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .order-btn { background-color: var(--color-light-green); color: var(--color-darkest); }
        .checkout-btn { background-color: var(--color-medium-beige); color: var(--color-white); }

        /* --- Table Number Display (Interactive) --- */
        #table-number-display {
            position: fixed; bottom: 10px; left: 10px; z-index: 1002;
            background-color: var(--color-medium-green); color: var(--color-white);
            font-family: 'Sarabun', 'Inter', sans-serif; font-size: 0.9rem; font-weight: bold;
            padding: 8px 15px; border-radius: 9999px; /* Capsule shape */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            user-select: none;
        }
        #table-number-display:hover { background-color: var(--color-dark-green); transform: scale(1.05); }
        #table-number-display .table-icon { margin-right: 5px; }
        #table-number-display .placeholder-text { font-style: italic; opacity: 0.8; }


        /* --- Table Selection Modal --- */
        #table-select-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-modal-bg);
            display: none; justify-content: center; align-items: center; z-index: 1050;
            opacity: 0; transition: opacity var(--transition-speed-medium) ease;
        }
        #table-select-modal.open { display: flex; opacity: 1; }
        .table-select-content {
            background-color: var(--color-white); border-radius: 10px;
            padding: 20px; max-width: 90%; width: 300px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: scale(0.95); transition: transform var(--transition-speed-medium) ease;
        }
        #table-select-modal.open .table-select-content { transform: scale(1); }
        .table-select-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid var(--color-border); padding-bottom: 10px;
        }
        .table-select-header h4 { margin: 0; font-size: 1.2em; color: var(--color-darkest); }
        .table-select-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; padding: 0; }
        #table-list {
            max-height: 60vh; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px; padding: 5px;
        }
        .table-list-item {
            padding: 10px; border: 1px solid var(--color-border); border-radius: 5px;
            text-align: center; font-weight: bold; cursor: pointer;
            background-color: var(--color-background);
            transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }
        .table-list-item:hover {
            background-color: var(--color-lightest-green); color: var(--color-darkest); transform: scale(1.05);
        }
        .table-list-item.selected {
             background-color: var(--color-medium-green); color: var(--color-white); border-color: var(--color-dark-green);
         }

        /* --- First Load Prompt Notification --- */
        #table-prompt-notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--color-info); color: var(--color-white);
            padding: 10px 20px; border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 1100;
            font-size: 0.9em; font-weight: bold; text-align: center;
            opacity: 0; transition: top var(--transition-speed-medium) ease-out, opacity var(--transition-speed-medium) ease-out;
        }
        #table-prompt-notification.show { top: 0; opacity: 1; }


        /* --- Responsive Adjustments --- */
        @media (min-width: 640px) {
             .bottom-menu { column-count: 3; }
             .container { padding: 0 20px; }
             #menu-name { font-size: 32px; }
             #menu-price { font-size: 20px; }
             .price-label { font-size: 0.8em; }
             .add-to-cart-button { width: 28px; height: 28px; line-height: 28px; font-size: 18px; }
             .top-section { width: calc(100% + 40px); margin-left: -20px; margin-right: -20px; }
             #menu-details { margin-left: 20px; margin-right: 20px; width: calc(100% - 40px); }
             #table-number-display { font-size: 1rem; bottom: 15px; left: 15px; padding: 10px 20px; }
             #table-prompt-notification { font-size: 1em; }
        }
        @media (min-width: 768px) { .bottom-menu { column-count: 4; } }
        @media (min-width: 1024px) { .bottom-menu { column-count: 5; } }
        @media (min-width: 1280px) { .bottom-menu { column-count: 6; } }

    </style>
</head>
<body>
    <div id="table-number-display" title="เลือกหมายเลขโต๊ะ" role="button" aria-haspopup="true" aria-controls="table-select-modal">
        <span id="table-number-text"><span class="placeholder-text">เลือกโต๊ะ</span></span>
    </div>

    <div id="table-select-modal" role="dialog" aria-modal="true" aria-labelledby="table-select-title">
        <div class="table-select-content">
            <div class="table-select-header">
                <h4 id="table-select-title">เลือกหมายเลขโต๊ะ</h4>
                <button class="table-select-close-btn" title="ปิด" aria-label="ปิดหน้าต่างเลือกโต๊ะ">×</button>
            </div>
            <div id="table-list">
                <p>กำลังโหลดรายการโต๊ะ...</p>
            </div>
        </div>
    </div>

    <div id="table-prompt-notification" role="alert">
        <i class="fas fa-info-circle"></i> กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ
    </div>

    <main class="container">
        <section class="top-section" aria-labelledby="menu-name">
             <div class="image-container" id="image-swipe-area">
                 <img id="main-food-image" class="main-food-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="กำลังโหลดรูปภาพเมนู...">
             </div>
             <div id="menu-details">
                 <div class="menu-name-container">
                     <h2 id="menu-name">ชื่อเมนู</h2>
                 </div>
                 <p id="menu-description">คำอธิบายเมนูอาหาร</p>
                 <p id="menu-price">
                     <span class="price-item hidden">
                         <span class="price-label" id="label-small">เล็ก:</span>
                         <span class="price-value" id="price-small">฿0</span>
                         <button class="add-to-cart-button" data-size="Small" title="เพิ่มขนาดเล็กลงตระกร้า" aria-label="เพิ่มขนาดเล็กลงตระกร้า">+</button>
                     </span>
                      <span class="price-separator hidden" id="price-sep-small">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-normal">ปกติ:</span>
                         <span class="price-value" id="price-normal">฿0</span>
                         <button class="add-to-cart-button" data-size="Normal" title="เพิ่มขนาดปกติลงตระกร้า" aria-label="เพิ่มขนาดปกติลงตระกร้า">+</button>
                     </span>
                     <span class="price-separator hidden" id="price-sep">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-extra">พิเศษ:</span>
                         <span class="price-value" id="price-extra">฿0</span>
                         <button class="add-to-cart-button" data-size="Extra" title="เพิ่มขนาดพิเศษลงตระกร้า" aria-label="เพิ่มขนาดพิเศษลงตระกร้า">+</button>
                     </span>
                     <span class="price-separator hidden" id="price-sep-family">|</span>
                     <span class="price-item hidden">
                         <span class="price-label" id="label-family">ครอบครัว:</span>
                         <span class="price-value" id="price-family">฿0</span>
                         <button class="add-to-cart-button" data-size="Family" title="เพิ่มขนาดครอบครัวลงตระกร้า" aria-label="เพิ่มขนาดครอบครัวลงตระกร้า">+</button>
                     </span>
                 </p>
             </div>
        </section>

        <nav class="category-bar" aria-label="หมวดหมู่เมนูอาหาร">
             <p>กำลังโหลดหมวดหมู่...</p>
         </nav>

        <section class="bottom-menu" aria-live="polite">
            <p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">กำลังโหลดรายการอาหาร...</p>
        </section>

    </main> <button id="call-staff-icon-container" class="floating-icon" title="เรียกพนักงาน" aria-label="เรียกพนักงาน">
        <i class="fas fa-bell"></i>
    </button>

    <button id="my-food-icon-container" class="floating-icon" title="เปิด/ปิด รายการอาหารของฉัน" aria-label="เปิด/ปิด รายการอาหารของฉัน" aria-haspopup="true" aria-controls="my-food-popup" aria-expanded="false">
        <i class="fas fa-receipt"></i>
        <span id="my-food-item-count" class="badge hidden" aria-label="จำนวนรายการอาหารที่สั่งแล้ว">0</span>
    </button>

    <button id="cart-icon-container" class="floating-icon" title="เปิด/ปิด ตระกร้า" aria-label="เปิด/ปิด ตระกร้าสินค้า" aria-haspopup="true" aria-controls="cart-popup" aria-expanded="false">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-item-count" class="badge hidden" aria-label="จำนวนรายการในตระกร้า">0</span>
    </button>

    <div id="my-food-popup" class="popup-container" role="dialog" aria-modal="true" aria-labelledby="my-food-title">
        <div class="popup-header my-food-header">
            <h3 id="my-food-title">รายการอาหารที่สั่งแล้ว</h3>
            <button class="popup-close-btn my-food-close-btn" title="ปิดรายการ" aria-label="ปิดหน้าต่างรายการอาหารที่สั่งแล้ว">×</button>
        </div>
        <div id="my-food-items-list" class="popup-items-list">
            <p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>
            </div>
        <div id="ordered-grand-total" class="hidden">ยอดรวมที่สั่งแล้ว: ฿0</div>
        <div class="popup-footer my-food-footer">
            <div class="popup-actions my-food-actions">
                <button class="popup-action-btn checkout-btn" id="my-food-checkout-button" disabled>ชำระเงิน</button>
            </div>
        </div>
    </div>

    <div id="cart-popup" class="popup-container" role="dialog" aria-modal="true" aria-labelledby="cart-title">
        <div class="popup-header cart-header">
            <h3 id="cart-title">ตระกร้าสินค้า</h3>
            <button class="popup-close-btn cart-close-btn" title="ปิดตระกร้า" aria-label="ปิดหน้าต่างตระกร้าสินค้า">×</button>
        </div>
        <div id="cart-items-list" class="popup-items-list">
            <p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>
            </div>
        <div class="popup-footer cart-footer">
            <div class="cart-total">
                <span>รวมทั้งหมด:</span>
                <span id="cart-total-price">฿0</span>
            </div>
            <div class="popup-actions cart-actions">
                <button class="popup-action-btn order-btn" id="order-button" disabled>สั่งรายการอาหาร</button>
            </div>
        </div>
    </div>

<script>
    // ========================================================================
    // CONFIGURATION
    // ========================================================================
    const CONFIG = {
        // *** URL สคริปต์สำหรับดึงข้อมูลเมนู ***
        GET_MENU_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyNfhlMBqeE0HORA2Y16l0ui8-YgBgjMYTuiBhx9Rb1liYR6nejvQAOWoWHnVaZ6Xil/exec", // <-- URL สำหรับ getMenu

        // *** URL สคริปต์สำหรับส่ง Actions (Order, Call Staff, Checkout) ไป Telegram ***
        ACTION_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwBy05X2eyH3e9RM-C3LBLNbyH_mLibpDWBeETa_nIkBvs3n6d2OPqRFKq7VzgANVu1/exec", // <-- URL สำหรับ Actions

        TABLE_NUMBER_PREFIX: "โต๊ะ ",
        MAX_TABLE_NUMBER: 30,
        TABLE_SELECT_PROMPT_MESSAGE: "กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ",
        PLACEHOLDER_IMAGE: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
        STORAGE_KEYS: {
            TABLE: 'selectedTableData_v116',
            CART: 'menuCartData_v116_db',
            ORDERED: 'menuOrderedItemsData_v116_db'
        },
        EXPIRY_HOURS: {
            TABLE: 6
        },
        ANIMATION_SPEED_MS: 300,
        SWIPE_THRESHOLD_PX: 50,
        CATEGORY_ICONS: {
             "จานหลัก": "fas fa-utensils",
             "เฮลท์ตี้ โบวล์": "fas fa-seedling",
             "ทานเล่น": "fas fa-cookie-bite",
             "สลัด": "fas fa-leaf",
             "ทะเล": "fas fa-fish",
             "ของหวาน": "fas fa-ice-cream",
             "เครื่องดื่ม": "fas fa-coffee",
             "ซุป": "fas fa-mug-hot",
             "default": "fas fa-question-circle"
         }
    };

    // ========================================================================
    // GLOBAL STATE VARIABLES
    // ========================================================================
    let menuData = [];
    let allCategories = [];
    let cartItems = [];
    let orderedItems = [];
    let selectedTableNumber = null;
    let currentDisplayedItemId = null;
    let currentCategory = null;
    let currentFilteredItems = [];
    let currentDisplayIndex = -1;
    let isApiLoading = {
        menu: false,
        order: false,
        callStaff: false,
        checkout: false
    };

    // ========================================================================
    // DOM ELEMENT CACHING
    // ========================================================================
    const DOMElements = {
        tableNumberDisplay: document.getElementById('table-number-display'),
        tableNumberText: document.getElementById('table-number-text'),
        tableSelectModal: document.getElementById('table-select-modal'),
        tableListContainer: document.getElementById('table-list'),
        tableSelectCloseBtn: document.querySelector('#table-select-modal .table-select-close-btn'),
        tablePromptNotification: document.getElementById('table-prompt-notification'),
        mainFoodImage: document.getElementById('main-food-image'),
        imageContainer: document.getElementById('image-swipe-area'),
        bottomMenuContainer: document.querySelector('.bottom-menu'),
        categoryBarContainer: document.querySelector('.category-bar'),
        menuDetailsContainer: document.getElementById('menu-details'),
        menuNameElement: document.getElementById('menu-name'),
        menuDescriptionElement: document.getElementById('menu-description'),
        menuPriceContainer: document.getElementById('menu-price'),
        cartIcon: document.getElementById('cart-icon-container'),
        cartItemCountBadge: document.getElementById('cart-item-count'),
        cartPopup: document.getElementById('cart-popup'),
        cartItemsList: document.getElementById('cart-items-list'),
        cartTotalPriceElement: document.getElementById('cart-total-price'),
        cartCloseBtn: document.querySelector('#cart-popup .cart-close-btn'),
        orderButton: document.getElementById('order-button'),
        myFoodIcon: document.getElementById('my-food-icon-container'),
        myFoodItemCountBadge: document.getElementById('my-food-item-count'),
        myFoodPopup: document.getElementById('my-food-popup'),
        myFoodItemsList: document.getElementById('my-food-items-list'),
        myFoodCloseBtn: document.querySelector('#my-food-popup .my-food-close-btn'),
        myFoodCheckoutButton: document.getElementById('my-food-checkout-button'),
        callStaffIcon: document.getElementById('call-staff-icon-container'),
        orderedGrandTotal: document.getElementById('ordered-grand-total'),
        priceElementsCache: {}
    };

    function setupPriceElementCache() {
         const sizes = ['Small', 'Normal', 'Extra', 'Family'];
         sizes.forEach(size => {
             const lowerSize = size.toLowerCase();
             const button = DOMElements.menuPriceContainer?.querySelector(`button[data-size="${size}"]`);
             DOMElements.priceElementsCache[size] = {
                 label: document.getElementById(`label-${lowerSize}`),
                 value: document.getElementById(`price-${lowerSize}`),
                 button: button,
                 separator: document.getElementById(`price-sep-${lowerSize}`) || (size === 'Extra' ? document.getElementById('price-sep') : null),
                 parentSpan: button?.closest('.price-item')
             };
         });
    }

    // ========================================================================
    // UTILITY FUNCTIONS
    // ========================================================================
    function getCurrentDateString() { /* ... code ... */ return `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`; }
    function getExpiryTimestamp(hours) { return Date.now() + hours * 60 * 60 * 1000; }
    function formatPrice(price) { if (price === null || price === undefined || isNaN(price)) return 'N/A'; return `฿${Number(price).toLocaleString()}`; }

    function setLoadingState(elementType, action, isLoading) {
        isApiLoading[action] = isLoading;
        let element;
        switch (elementType) {
            case 'button': element = (action === 'order') ? DOMElements.orderButton : DOMElements.myFoodCheckoutButton; break;
            case 'icon': element = DOMElements.callStaffIcon; break;
        }
        if (!element) return;
        if (isLoading) {
            element.disabled = true;
            if (!element.dataset.originalContent) element.dataset.originalContent = element.innerHTML;
            element.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            if (elementType === 'button') element.innerHTML += (action === 'order' ? ' กำลังสั่ง...' : ' กำลังเรียก...');
        } else {
            if (element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                delete element.dataset.originalContent;
            }
            if (action === 'order') updateOrderButtonState();
            if (action === 'checkout') updateCheckoutButtonState();
            if (action === 'callStaff') updateCallStaffButtonState();
        }
    }
    function updateCallStaffButtonState() { if (DOMElements.callStaffIcon) DOMElements.callStaffIcon.disabled = isApiLoading.callStaff; }

    // ========================================================================
    // API SERVICE FUNCTION (MODIFIED FOR MULTIPLE URLS)
    // ========================================================================
    async function callBackendApi(action, payload = {}, method = 'POST', targetUrl) { // <-- Added targetUrl parameter
        // Use the provided targetUrl
        if (!targetUrl) {
            console.error("Target URL is missing in callBackendApi call.");
            alert("🚨 ข้อผิดพลาด: การตั้งค่าสคริปต์ไม่ถูกต้อง (URL Missing)");
            return { success: false, message: "Target URL not provided" };
        }

        // Construct the final URL. Action is always appended for simplicity with GAS doGet/doPost parameter handling.
        const url = `${targetUrl}?action=${action}`;

        const options = {
            method: method,
            headers: {},
            // redirect: 'follow', // Default fetch behavior handles redirects
        };

        // Only add Content-Type and body for POST requests
        if (method === 'POST') {
            options.headers['Content-Type'] = 'application/json';
            // Send payload as is. The action is in the URL query parameter.
            options.body = JSON.stringify(payload);
        }

        try {
            console.log(`Calling backend: ${method} ${url}`, method === 'POST' ? options.body : ''); // Log payload for POST
            const response = await fetch(url, options);

            // Check for non-JSON responses or failed fetch
            if (!response.ok) {
                 let errorText = `HTTP error ${response.status}: ${response.statusText}`;
                 let serverResponseMessage = '';
                 try {
                     serverResponseMessage = await response.text();
                     errorText += `\nServer Response: ${serverResponseMessage.substring(0, 200)}...`;
                 } catch (e) { console.warn("Could not read error response body:", e); }
                 console.error(`Backend API Error (${action} at ${targetUrl}): ${errorText}`);
                 alert(`🚨 เกิดข้อผิดพลาด (${response.status}) ในการติดต่อเซิร์ฟเวอร์ (${action}). โปรดลองใหม่อีกครั้ง หรือแจ้งพนักงาน.\n${serverResponseMessage.substring(0,100)}`);
                 return { success: false, message: `HTTP error ${response.status}` };
            }

             // Attempt to parse JSON
             let result;
             try {
                 const contentType = response.headers.get("content-type");
                 if (!contentType || !contentType.includes("application/json")) {
                     const textResponse = await response.text();
                     console.warn(`Non-JSON response received from action '${action}' at ${targetUrl}. Status: ${response.status}. Body:`, textResponse);
                     throw new Error(`Expected JSON, but got ${contentType || 'unknown'}. Response: ${textResponse.substring(0, 100)}...`);
                 }
                 result = await response.json();
             } catch (parseError) {
                 console.error(`Error parsing JSON response for action '${action}' at ${targetUrl}:`, parseError);
                 alert(`🚨 เกิดข้อผิดพลาดในการประมวลผลข้อมูลตอบกลับจากเซิร์ฟเวอร์ (${action}).`);
                 return { success: false, message: `JSON Parse Error: ${parseError.message}` };
             }

            console.log(`Backend response for action '${action}' from ${targetUrl}:`, result);
            if (typeof result.success !== 'boolean') {
                console.warn(`Backend response for '${action}' missing or invalid 'success' flag.`, result);
            }
            return result;

        } catch (networkError) {
            console.error(`Network or fetch error calling backend API for action '${action}' at ${targetUrl}:`, networkError);
             alert(`🚨 เกิดข้อผิดพลาดในการเชื่อมต่อ (${action}). โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต หรือติดต่อพนักงาน.`);
            return { success: false, message: `Network Error: ${networkError.message}` };
        }
    }

    // ========================================================================
    // FETCH MENU DATA FUNCTION (MODIFIED)
    // ========================================================================
    async function fetchMenuData() {
        console.log("Fetching menu data from Google Sheet...");
        setLoadingState(null, 'menu', true);
        if (DOMElements.categoryBarContainer) DOMElements.categoryBarContainer.innerHTML = '<p>กำลังโหลดหมวดหมู่...</p>';
        if (DOMElements.bottomMenuContainer) DOMElements.bottomMenuContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">กำลังโหลดรายการอาหาร...</p>';

        // Call API using GET method and the specific URL for menu data
        const result = await callBackendApi('getMenu', null, 'GET', CONFIG.GET_MENU_SCRIPT_URL); // <-- Pass GET_MENU_SCRIPT_URL

        setLoadingState(null, 'menu', false);

        // Process result (same logic as before)
        if (result && result.success && Array.isArray(result.menuData) && Array.isArray(result.categories)) {
            console.log("Menu data fetched successfully:", result.menuData.length, "items,", result.categories.length, "categories.");
            menuData = result.menuData;
            allCategories = result.categories;
            return true;
        } else {
            console.error('Error fetching or processing menu data:', result?.message || 'Invalid data structure or failed request.', result);
            const errorMsg = `❌ เกิดข้อผิดพลาดในการโหลดข้อมูลเมนู: ${result?.message || 'ไม่สามารถเชื่อมต่อหรือข้อมูลไม่ถูกต้อง'}. โปรดลองรีเฟรชหน้า หรือติดต่อพนักงาน`;
            if (DOMElements.categoryBarContainer) DOMElements.categoryBarContainer.innerHTML = `<p style="color: red; padding: 10px;">${errorMsg}</p>`;
            if (DOMElements.bottomMenuContainer) DOMElements.bottomMenuContainer.innerHTML = '';
            menuData = [];
            allCategories = [];
            return false;
        }
    }


    // ========================================================================
    // TABLE SELECTION LOGIC (Unchanged)
    // ========================================================================
    function openTableSelectModal() { /* ... code ... */ if (DOMElements.tableSelectModal) { const items = DOMElements.tableListContainer?.querySelectorAll('.table-list-item'); items?.forEach(i => i.classList.toggle('selected', i.dataset.table === selectedTableNumber)); DOMElements.tableSelectModal.classList.add('open'); DOMElements.tableSelectCloseBtn?.focus(); } }
    function closeTableSelectModal() { /* ... code ... */ if (DOMElements.tableSelectModal) { DOMElements.tableSelectModal.classList.remove('open'); DOMElements.tableNumberDisplay?.focus(); } }
    function populateTableList(maxTables) { /* ... code ... */ if (!DOMElements.tableListContainer) return; DOMElements.tableListContainer.innerHTML = ''; const f = document.createDocumentFragment(); for (let i = 1; i <= maxTables; i++) { const n = String(i); const li = document.createElement('div'); li.className = 'table-list-item'; li.textContent = n; li.dataset.table = n; li.setAttribute('role', 'button'); li.tabIndex = 0; li.onclick = () => selectTable(n); li.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') selectTable(n); }; f.appendChild(li); } DOMElements.tableListContainer.appendChild(f); }
    function selectTable(tableNum) { /* ... code ... */ selectedTableNumber = tableNum; updateTableDisplay(tableNum); saveSelectedTable(tableNum); closeTableSelectModal(); document.title = `เมนูอาหาร - ${CONFIG.TABLE_NUMBER_PREFIX}${tableNum}`; hideTablePromptNotification(); updateOrderButtonState(); updateCheckoutButtonState(); }
    function updateTableDisplay(tableNum) { /* ... code ... */ if (DOMElements.tableNumberText) { if (tableNum) { DOMElements.tableNumberText.innerHTML = `<i class="fas fa-chair table-icon"></i>${CONFIG.TABLE_NUMBER_PREFIX}${tableNum}`; DOMElements.tableNumberText.classList.remove('placeholder-text'); document.title = `เมนูอาหาร - ${CONFIG.TABLE_NUMBER_PREFIX}${tableNum}`; } else { DOMElements.tableNumberText.innerHTML = `<span class="placeholder-text">เลือกโต๊ะ</span>`; DOMElements.tableNumberText.classList.add('placeholder-text'); document.title = 'เมนูอาหาร - เลือกโต๊ะ'; } } }
    function saveSelectedTable(tableNum) { /* ... code ... */ try { localStorage.setItem(CONFIG.STORAGE_KEYS.TABLE, JSON.stringify({ tableNumber: tableNum, expiry: getExpiryTimestamp(CONFIG.EXPIRY_HOURS.TABLE) })); } catch (e) { console.error("LS Error (Save Table):", e); } }
    function loadSelectedTable() { /* ... code ... */ try { const d = localStorage.getItem(CONFIG.STORAGE_KEYS.TABLE); if (d) { const p = JSON.parse(d); if (p?.tableNumber && p.expiry && Date.now() < p.expiry) return p.tableNumber; else localStorage.removeItem(CONFIG.STORAGE_KEYS.TABLE); } } catch (e) { console.error("LS Error (Load Table):", e); localStorage.removeItem(CONFIG.STORAGE_KEYS.TABLE); } return null; }
    function showTablePromptNotification() { /* ... code ... */ if (DOMElements.tablePromptNotification) DOMElements.tablePromptNotification.classList.add('show'); }
    function hideTablePromptNotification() { /* ... code ... */ if (DOMElements.tablePromptNotification) DOMElements.tablePromptNotification.classList.remove('show'); }


    // ========================================================================
    // LOCAL STORAGE (Cart & Ordered Items) (Unchanged)
    // ========================================================================
    function saveCartToLocalStorage() { /* ... code ... */ try { localStorage.setItem(CONFIG.STORAGE_KEYS.CART, JSON.stringify({ date: getCurrentDateString(), items: cartItems })); } catch (e) { console.error("LS Error (Save Cart):", e); } }
    function loadCartFromLocalStorage() { /* ... code ... */ cartItems = []; try { const d = localStorage.getItem(CONFIG.STORAGE_KEYS.CART); if (d) { const p = JSON.parse(d); if (p && typeof p === 'object' && Array.isArray(p.items)) { cartItems = p.items.filter(i => i && i.cartId && i.id && i.name && i.size && typeof i.quantity === 'number' && typeof i.price === 'number'); if (cartItems.length !== p.items.length) console.warn("Invalid items removed from loaded cart."); } else { console.warn("Invalid cart data structure. Clearing."); localStorage.removeItem(CONFIG.STORAGE_KEYS.CART); } } } catch (e) { console.error("LS Error (Load Cart):", e); localStorage.removeItem(CONFIG.STORAGE_KEYS.CART); } }
    function saveOrderedItemsToLocalStorage() { /* ... code ... */ try { localStorage.setItem(CONFIG.STORAGE_KEYS.ORDERED, JSON.stringify({ date: getCurrentDateString(), items: orderedItems })); } catch (e) { console.error("LS Error (Save Ordered):", e); } }
    function loadOrderedItemsFromLocalStorage() { /* ... code ... */ orderedItems = []; try { const d = localStorage.getItem(CONFIG.STORAGE_KEYS.ORDERED); if (d) { const p = JSON.parse(d); if (p && typeof p === 'object' && Array.isArray(p.items)) { orderedItems = p.items.filter(i => i && i.cartId && i.id && i.name && i.size && typeof i.quantity === 'number' && typeof i.price === 'number'); if (orderedItems.length !== p.items.length) console.warn("Invalid items removed from loaded ordered items."); } else { console.warn("Invalid ordered items data structure. Clearing."); localStorage.removeItem(CONFIG.STORAGE_KEYS.ORDERED); } } } catch (e) { console.error("LS Error (Load Ordered):", e); localStorage.removeItem(CONFIG.STORAGE_KEYS.ORDERED); } }


    // ========================================================================
    // CART LOGIC (Unchanged)
    // ========================================================================
    function addToCart(itemId, size) { /* ... code ... */ const product = menuData.find(i => i.id === itemId); if (!product?.prices || typeof product.prices !== 'object') { console.error("Product/prices not found:", itemId); alert("ขออภัย ไม่พบข้อมูลราคาสินค้านี้"); return; } const price = product.prices[size]; if (price === null || price === undefined || isNaN(price)) { console.error(`Invalid price for ${itemId}, size ${size}:`, price); alert(`ขออภัย ไม่พบราคาสำหรับขนาด ${size} ของสินค้านี้`); return; } const cartItemId = `${itemId}-${size}`; const idx = cartItems.findIndex(i => i.cartId === cartItemId); if (idx > -1) cartItems[idx].quantity++; else cartItems.push({ cartId: cartItemId, id: product.id, name: product.name, price: price, size: size, quantity: 1 }); saveCartToLocalStorage(); renderCart(); updateCartIcon(); DOMElements.cartIcon?.classList.add('updated'); setTimeout(() => { DOMElements.cartIcon?.classList.remove('updated'); }, CONFIG.ANIMATION_SPEED_MS + 50); }
    function updateQuantity(cartId, change) { /* ... code ... */ const idx = cartItems.findIndex(i => i.cartId === cartId); if (idx > -1) { const newQty = cartItems[idx].quantity + change; if (newQty <= 0) cartItems.splice(idx, 1); else cartItems[idx].quantity = newQty; saveCartToLocalStorage(); renderCart(); updateCartIcon(); } else console.warn("Update quantity for non-existent cart item:", cartId); }
    function removeFromCart(cartId) { /* ... code ... */ const idx = cartItems.findIndex(i => i.cartId === cartId); if (idx > -1) { cartItems.splice(idx, 1); saveCartToLocalStorage(); renderCart(); updateCartIcon(); } else console.warn("Remove non-existent cart item:", cartId); }

    // ========================================================================
    // RENDERING FUNCTIONS (Mostly Unchanged, minor fixes/updates)
    // ========================================================================
     function renderCart() { /* ... code ... */ if (!DOMElements.cartItemsList || !DOMElements.cartTotalPriceElement) return; DOMElements.cartItemsList.innerHTML = ''; let totalPrice = 0; if (cartItems.length === 0) { DOMElements.cartItemsList.innerHTML = '<p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>'; } else { const f = document.createDocumentFragment(); cartItems.forEach(item => { if (!item || typeof item.price !== 'number' || typeof item.quantity !== 'number') { console.warn("Skipping invalid cart item:", item); return; } const el = document.createElement('div'); el.className = 'cart-item'; const itemPrice = item.price; const itemQuantity = item.quantity; const itemTotalPrice = itemPrice * itemQuantity; totalPrice += itemTotalPrice; const safeName = item.name?.replace(/</g, "<")?.replace(/>/g, ">") || 'N/A'; const safeSize = item.size?.replace(/</g, "<")?.replace(/>/g, ">") || 'N/A'; el.innerHTML = `<div class="cart-item-details"><div class="cart-item-name">${safeName} (${safeSize})</div><div class="cart-item-price">${formatPrice(itemPrice)} x ${itemQuantity} = ${formatPrice(itemTotalPrice)}</div></div><div class="cart-item-controls"><button class="cart-quantity-btn decrease-qty" data-cartid="${item.cartId}" aria-label="ลดจำนวน ${safeName} (${safeSize})">-</button><span class="cart-item-quantity" aria-live="polite">${itemQuantity}</span><button class="cart-quantity-btn increase-qty" data-cartid="${item.cartId}" aria-label="เพิ่มจำนวน ${safeName} (${safeSize})">+</button><button class="cart-remove-btn" data-cartid="${item.cartId}" title="ลบรายการนี้" aria-label="ลบ ${safeName} (${safeSize}) ออกจากตระกร้า"><i class="fas fa-trash-alt" aria-hidden="true"></i></button></div>`; el.querySelector('.decrease-qty')?.addEventListener('click', () => updateQuantity(item.cartId, -1)); el.querySelector('.increase-qty')?.addEventListener('click', () => updateQuantity(item.cartId, 1)); el.querySelector('.cart-remove-btn')?.addEventListener('click', () => removeFromCart(item.cartId)); f.appendChild(el); }); DOMElements.cartItemsList.appendChild(f); } DOMElements.cartTotalPriceElement.textContent = formatPrice(totalPrice); updateOrderButtonState(); }
     function updateOrderButtonState() { /* ... code ... */ if (DOMElements.orderButton) { const canOrder = cartItems.length > 0 && selectedTableNumber && !isApiLoading.order; DOMElements.orderButton.disabled = !canOrder; let title = ""; if (isApiLoading.order) title = "กำลังดำเนินการ..."; else if (cartItems.length === 0) title = "ตระกร้าว่างเปล่า"; else if (!selectedTableNumber) title = "กรุณาเลือกโต๊ะก่อน"; else title = "สั่งรายการอาหาร"; DOMElements.orderButton.title = title; } }
     function updateCartIcon() { /* ... code ... */ if (!DOMElements.cartItemCountBadge || !DOMElements.cartIcon) return; const totalQuantity = cartItems.reduce((sum, item) => sum + (item?.quantity || 0), 0); DOMElements.cartItemCountBadge.textContent = totalQuantity; DOMElements.cartItemCountBadge.classList.toggle('hidden', totalQuantity === 0); DOMElements.cartIcon.setAttribute('aria-label', `เปิด/ปิด ตระกร้าสินค้า (${totalQuantity} รายการ)`); }
     function renderOrderedItems() { /* ... code ... */ if (!DOMElements.myFoodItemsList || !DOMElements.myFoodCheckoutButton || !DOMElements.orderedGrandTotal) return; DOMElements.myFoodItemsList.innerHTML = ''; let hasOrderedItems = orderedItems.length > 0; let grandOrderedTotal = 0; if (!hasOrderedItems) { DOMElements.myFoodItemsList.innerHTML = '<p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>'; DOMElements.orderedGrandTotal.classList.add('hidden'); } else { const f = document.createDocumentFragment(); orderedItems.forEach(item => { if (!item || typeof item.price !== 'number' || typeof item.quantity !== 'number') { console.warn("Skipping invalid ordered item:", item); return; } const el = document.createElement('div'); el.className = 'ordered-item'; const itemPrice = item.price; const itemQuantity = item.quantity; const itemTotalPrice = itemPrice * itemQuantity; grandOrderedTotal += itemTotalPrice; const safeName = item.name?.replace(/</g, "<")?.replace(/>/g, ">") || 'N/A'; const safeSize = item.size?.replace(/</g, "<")?.replace(/>/g, ">") || 'N/A'; el.innerHTML = `<div class="ordered-item-details"><div class="ordered-item-name">${safeName} (${safeSize})</div><div class="ordered-item-info">จำนวน: ${itemQuantity} (${formatPrice(itemPrice)}/ชิ้น)</div></div><div class="ordered-item-total">${formatPrice(itemTotalPrice)}</div>`; f.appendChild(el); }); DOMElements.myFoodItemsList.appendChild(f); DOMElements.orderedGrandTotal.textContent = `ยอดรวมที่สั่งแล้ว: ${formatPrice(grandOrderedTotal)}`; DOMElements.orderedGrandTotal.classList.remove('hidden'); } updateCheckoutButtonState(); }
     function updateCheckoutButtonState() { /* ... code ... */ if (DOMElements.myFoodCheckoutButton) { const canCheckout = orderedItems.length > 0 && selectedTableNumber && !isApiLoading.checkout; DOMElements.myFoodCheckoutButton.disabled = !canCheckout; let title = ""; if (isApiLoading.checkout) title = "กำลังดำเนินการ..."; else if (orderedItems.length === 0) title = "ไม่มีรายการที่สั่ง"; else if (!selectedTableNumber) title = "กรุณาเลือกโต๊ะก่อน"; else title = "เรียกชำระเงิน"; DOMElements.myFoodCheckoutButton.title = title; } }
     function updateMyFoodIcon() { /* ... code ... */ if (!DOMElements.myFoodItemCountBadge || !DOMElements.myFoodIcon) return; const totalQuantity = orderedItems.reduce((sum, item) => sum + (item?.quantity || 0), 0); DOMElements.myFoodItemCountBadge.textContent = totalQuantity; DOMElements.myFoodItemCountBadge.classList.toggle('hidden', totalQuantity === 0); DOMElements.myFoodIcon.setAttribute('aria-label', `เปิด/ปิด รายการอาหารของฉัน (${totalQuantity} รายการ)`); }
     function updateImageWithAnimation(newSrc, alt, direction = 'none') { /* ... code ... */ if (!DOMElements.mainFoodImage || !DOMElements.imageContainer) return; const currentImageSrc = DOMElements.mainFoodImage.getAttribute('src'); const placeholderSrc = CONFIG.PLACEHOLDER_IMAGE; const safeAlt = alt?.replace(/"/g, '"') || 'รูปภาพเมนู'; const updateImg = (src) => { DOMElements.mainFoodImage.src = src || placeholderSrc; DOMElements.mainFoodImage.alt = src ? safeAlt : 'ไม่มีรูปภาพ'; DOMElements.mainFoodImage.onerror = null; DOMElements.mainFoodImage.onerror = () => { console.warn(`Image failed: ${src}. Using placeholder.`); if (DOMElements.mainFoodImage.src !== placeholderSrc) DOMElements.mainFoodImage.src = placeholderSrc; DOMElements.mainFoodImage.alt = `${safeAlt} (Image unavailable)`; }; }; DOMElements.imageContainer.classList.remove('slide-out-left', 'slide-in-right', 'slide-out-right', 'slide-in-left'); DOMElements.mainFoodImage.getAnimations().forEach(a => a.cancel()); const needsAnim = direction !== 'none' && currentImageSrc && currentImageSrc !== newSrc && currentImageSrc !== placeholderSrc; if (needsAnim) { let outC = direction === 'next' ? 'slide-out-left' : 'slide-out-right'; let inC = direction === 'next' ? 'slide-in-right' : 'slide-in-left'; const animEndOut = (ev) => { if (ev.animationName !== outC.split(' ')[0]) return; ev.target.classList.remove(outC); updateImg(newSrc); requestAnimationFrame(() => { ev.target.classList.add(inC); ev.target.addEventListener('animationend', function animEndIn(evIn) { if (evIn.animationName !== inC.split(' ')[0]) return; evIn.target.classList.remove(inC); }, { once: true }); }); }; DOMElements.imageContainer.addEventListener('animationend', animEndOut, { once: true }); requestAnimationFrame(() => { DOMElements.imageContainer.classList.add(outC); }); } else { updateImg(newSrc); } }
     function updateTextDetails(itemData) { /* ... code ... */ if (!DOMElements.menuNameElement || !DOMElements.menuDescriptionElement) return; DOMElements.menuNameElement.textContent = itemData?.name || 'ชื่อเมนู'; DOMElements.menuDescriptionElement.textContent = itemData?.description || 'ไม่มีคำอธิบาย'; }
     function updatePriceDetails(prices) { /* ... code ... */ if (!DOMElements.menuPriceContainer || !DOMElements.priceElementsCache) return; const displayOrder = ['Small', 'Normal', 'Extra', 'Family']; let firstVisible = false; displayOrder.forEach(s => { const c = DOMElements.priceElementsCache[s]; c?.parentSpan?.classList.add('hidden'); if (c?.separator) c.separator.classList.add('hidden'); }); displayOrder.forEach(s => { const c = DOMElements.priceElementsCache[s]; const priceVal = prices?.[s]; if (c?.parentSpan && priceVal !== null && priceVal !== undefined && !isNaN(priceVal)) { c.value.textContent = formatPrice(priceVal); c.parentSpan.classList.remove('hidden'); const labelTxt = c.label?.textContent || s; const itemNm = DOMElements.menuNameElement?.textContent || ''; c.button?.setAttribute('aria-label', `เพิ่ม ${itemNm} ${labelTxt} ${formatPrice(priceVal)} ลงตระกร้า`); if (firstVisible && c.separator) c.separator.classList.remove('hidden'); firstVisible = true; } }); }
     function showItemDetails(index, direction = 'none') { /* ... code ... */ if (!DOMElements.menuDetailsContainer) { console.error("Missing menu details."); return; } const isValid = index >= 0 && index < currentFilteredItems.length; if (!isValid || currentFilteredItems.length === 0) { DOMElements.menuDetailsContainer.style.display = 'none'; updateImageWithAnimation(null, ''); updateTextDetails({}); updatePriceDetails({}); currentDisplayedItemId = null; currentDisplayIndex = -1; console.log("Hiding details: No item/invalid index."); return; } currentDisplayIndex = index; const item = currentFilteredItems[currentDisplayIndex]; if (!item) { console.error("Item data missing at index:", index); DOMElements.menuDetailsContainer.style.display = 'none'; return; } currentDisplayedItemId = item.id; const imgSrc = item.dataImageSrc || item.src || null; console.log('Showing Item:', item.id, item.name); console.log('Main Image URL:', imgSrc); console.log('Item Prices:', item.prices); updateImageWithAnimation(imgSrc, item.alt || item.name, direction); updateTextDetails(item); updatePriceDetails(item.prices); DOMElements.menuDetailsContainer.style.display = 'block'; }
     function displayMenuItems(category) { /* ... code ... */ if (!DOMElements.bottomMenuContainer) { console.error("Bottom menu container not found."); return; } DOMElements.bottomMenuContainer.innerHTML = ''; currentCategory = category; if (!menuData || menuData.length === 0) { console.warn("menuData empty for category:", category); DOMElements.bottomMenuContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีข้อมูลเมนู</p>'; showItemDetails(-1); currentFilteredItems = []; return; } currentFilteredItems = menuData.filter(i => Array.isArray(i.category) && i.category.includes(category)); if (currentFilteredItems.length === 0) { const safeCat = category?.replace(/</g, "<") || 'นี้'; DOMElements.bottomMenuContainer.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูในหมวดหมู่ "${safeCat}"</p>`; showItemDetails(-1); return; } const f = document.createDocumentFragment(); currentFilteredItems.forEach((item, index) => { const div = document.createElement('div'); div.className = 'menu-item'; div.dataset.itemId = item.id; div.dataset.index = index; div.setAttribute('role', 'button'); div.tabIndex = 0; const img = document.createElement('img'); const iSrc = item.src || CONFIG.PLACEHOLDER_IMAGE; img.src = iSrc; img.alt = item.alt || item.name || 'รูปภาพเมนู'; img.loading = 'lazy'; img.onerror = function() { console.warn("Thumbnail failed:", iSrc); this.onerror = null; this.src = CONFIG.PLACEHOLDER_IMAGE; this.alt = `${item.name || 'Menu item'} (Image unavailable)`; }; /* Add width/height attributes here if known */ div.appendChild(img); div.addEventListener('click', handleMenuItemClick); div.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') handleMenuItemClick(e); }); f.appendChild(div); }); DOMElements.bottomMenuContainer.appendChild(f); showItemDetails(0); }
     function handleMenuItemClick(event) { /* ... code ... */ const div = event.currentTarget; if (!div || !div.dataset.index) return; const idx = parseInt(div.dataset.index, 10); if (!isNaN(idx) && idx >= 0 && idx < currentFilteredItems.length) { showItemDetails(idx); setTimeout(() => { if (DOMElements.menuDetailsContainer && DOMElements.menuDetailsContainer.style.display !== 'none') window.scrollTo({ top: 0, behavior: 'smooth' }); }, 100); } else console.error("Invalid index on menu click:", div.dataset.index); }
     function populateCategoryBar() { /* ... code ... */ const container = DOMElements.categoryBarContainer; if (!container) { console.warn("Category bar container missing."); return; } if (!allCategories || allCategories.length === 0) { container.innerHTML = '<p style="color: var(--color-text-secondary); padding: 10px;">ไม่มีหมวดหมู่</p>'; return; } container.innerHTML = ''; const f = document.createDocumentFragment(); allCategories.forEach((cat, idx) => { const div = document.createElement('div'); div.className = 'category-item'; div.dataset.category = cat; div.setAttribute('role', 'tab'); div.tabIndex = idx === 0 ? 0 : -1; div.setAttribute('aria-selected', 'false'); const iconCls = CONFIG.CATEGORY_ICONS[cat] || CONFIG.CATEGORY_ICONS["default"]; const safeCat = cat?.replace(/</g, "<")?.replace(/>/g, ">") || 'N/A'; div.innerHTML = `<i class="${iconCls}" aria-hidden="true"></i><span>${safeCat}</span>`; div.addEventListener('click', handleCategoryClick); f.appendChild(div); }); container.appendChild(f); }
     function handleCategoryClick(event) { /* ... code ... */ const clicked = event.currentTarget; if (clicked.classList.contains('selected')) return; const category = clicked.dataset.category; const allItems = DOMElements.categoryBarContainer.querySelectorAll('.category-item'); allItems.forEach(item => { item.classList.remove('selected'); item.setAttribute('aria-selected', 'false'); item.tabIndex = -1; }); clicked.classList.add('selected'); clicked.setAttribute('aria-selected', 'true'); clicked.tabIndex = 0; displayMenuItems(category); }


    // ========================================================================
    // ACTION HANDLERS (Using Backend API - MODIFIED FOR MULTIPLE URLS)
    // ========================================================================
    async function handleCallStaff() {
        if (isApiLoading.callStaff) { console.log("Call staff in progress."); return; }
        if (!selectedTableNumber) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ'); openTableSelectModal(); return; }

        setLoadingState('icon', 'callStaff', true);
        const payload = { tableNumber: selectedTableNumber };
        // Call the ACTION script URL
        const result = await callBackendApi('callStaff', payload, 'POST', CONFIG.ACTION_SCRIPT_URL);
        setLoadingState('icon', 'callStaff', false);

         if (result && result.success) { // Check result and success property
             alert('✅ เรียกพนักงานบริการให้เรียบร้อยค่ะ กรุณารอสักครู่ 💁‍♀️');
         } else {
             console.error("Call staff failed:", result?.message || "Unknown error");
             // Alert is likely already shown by callBackendApi on error
         }
    }

    async function handleOrderSubmission() {
         if (isApiLoading.order) { console.log("Order submission in progress."); return; }
         if (cartItems.length === 0) { alert('ตระกร้าสินค้าของคุณว่างเปล่า'); return; }
         if (!selectedTableNumber) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนสั่งอาหารค่ะ'); openTableSelectModal(); return; }

         setLoadingState('button', 'order', true);
         const orderPayload = {
             tableNumber: selectedTableNumber,
             items: cartItems.map(item => ({
                 name: item.name, size: item.size, quantity: item.quantity,
                 price: item.price, id: item.id
             }))
         };

         // Call the ACTION script URL
         const result = await callBackendApi('submitOrder', orderPayload, 'POST', CONFIG.ACTION_SCRIPT_URL);

         if (result && result.success) { // Check result and success property
             alert(`ส่งรายการสั่งซื้อจาก ${CONFIG.TABLE_NUMBER_PREFIX}${selectedTableNumber} สำเร็จ!`);
             // Move items, clear cart, update UI
             cartItems.forEach(cartItem => {
                 const idx = orderedItems.findIndex(o => o.cartId === cartItem.cartId);
                 if (idx > -1) orderedItems[idx].quantity += cartItem.quantity;
                 else orderedItems.push({ ...cartItem });
             });
             cartItems = [];
             saveCartToLocalStorage();
             saveOrderedItemsToLocalStorage();
             renderCart(); updateCartIcon(); renderOrderedItems(); updateMyFoodIcon();
             if (DOMElements.cartPopup?.classList.contains('open')) {
                  DOMElements.cartPopup.classList.remove('open');
                  DOMElements.cartIcon.setAttribute('aria-expanded', 'false');
             }
             DOMElements.myFoodIcon?.classList.add('updated');
             setTimeout(() => { DOMElements.myFoodIcon?.classList.remove('updated'); }, CONFIG.ANIMATION_SPEED_MS + 50);
         } else {
             console.error("Order submission failed:", result?.message || "Unknown error");
              // Alert is likely already shown by callBackendApi on error
         }
         setLoadingState('button', 'order', false); // Ensure loading state resets
    }

    async function handleCheckout() {
         if (isApiLoading.checkout) { console.log("Checkout in progress."); return; }
         if (orderedItems.length === 0) { alert('ยังไม่มีรายการอาหารที่สั่งสำหรับชำระเงิน'); return; }
         if (!selectedTableNumber) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนเรียกชำระเงินค่ะ'); openTableSelectModal(); return; }

         setLoadingState('button', 'checkout', true);
         const checkoutPayload = {
             tableNumber: selectedTableNumber,
             orderedItems: orderedItems.map(item => ({
                 name: item.name, size: item.size, quantity: item.quantity, price: item.price
             }))
         };

         // Call the ACTION script URL
         const result = await callBackendApi('checkout', checkoutPayload, 'POST', CONFIG.ACTION_SCRIPT_URL);

         if (result && result.success) { // Check result and success property
             alert(`✅ เรียกพนักงานเพื่อชำระเงินสำหรับ ${CONFIG.TABLE_NUMBER_PREFIX}${selectedTableNumber} เรียบร้อยแล้วค่ะ`);
             // Optional: Clear ordered items or handle post-checkout logic
             if (DOMElements.myFoodPopup?.classList.contains('open')) {
                  DOMElements.myFoodPopup.classList.remove('open');
                  DOMElements.myFoodIcon.setAttribute('aria-expanded', 'false');
             }
         } else {
             console.error("Checkout call failed:", result?.message || "Unknown error");
             // Alert is likely already shown by callBackendApi on error
         }
         setLoadingState('button', 'checkout', false); // Ensure loading state resets
    }


    // ========================================================================
    // EVENT LISTENERS SETUP (Unchanged logic, calls modified handlers)
    // ========================================================================
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        // Table Selection
        DOMElements.tableNumberDisplay?.addEventListener('click', openTableSelectModal);
        DOMElements.tableSelectCloseBtn?.addEventListener('click', closeTableSelectModal);
        DOMElements.tableSelectModal?.addEventListener('click', (e) => { if (e.target === DOMElements.tableSelectModal) closeTableSelectModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && DOMElements.tableSelectModal?.classList.contains('open')) closeTableSelectModal(); });
        DOMElements.tablePromptNotification?.addEventListener('click', hideTablePromptNotification);
        DOMElements.tablePromptNotification?.addEventListener('touchstart', hideTablePromptNotification, { passive: true });
        // Add to Cart (Delegated)
         DOMElements.menuPriceContainer?.addEventListener('click', (e) => { const btn = e.target.closest('.add-to-cart-button'); if (btn) { const size = btn.dataset.size; if (currentDisplayedItemId && size) addToCart(currentDisplayedItemId, size); else console.warn("Cannot add to cart. Missing ID/size.", { currentDisplayedItemId, size }); } });
        // Category Bar (Listeners added dynamically)
        // Cart Popup
        DOMElements.cartIcon?.addEventListener('click', () => { DOMElements.myFoodPopup?.classList.remove('open'); DOMElements.myFoodIcon?.setAttribute('aria-expanded', 'false'); const isOpen = DOMElements.cartPopup?.classList.toggle('open'); DOMElements.cartIcon?.setAttribute('aria-expanded', String(isOpen)); if (isOpen) renderCart(); DOMElements.cartCloseBtn?.focus(); });
        DOMElements.cartCloseBtn?.addEventListener('click', () => { DOMElements.cartPopup?.classList.remove('open'); DOMElements.cartIcon?.setAttribute('aria-expanded', 'false'); DOMElements.cartIcon?.focus(); });
        // My Food Popup
        DOMElements.myFoodIcon?.addEventListener('click', () => { DOMElements.cartPopup?.classList.remove('open'); DOMElements.cartIcon?.setAttribute('aria-expanded', 'false'); const isOpen = DOMElements.myFoodPopup?.classList.toggle('open'); DOMElements.myFoodIcon?.setAttribute('aria-expanded', String(isOpen)); if (isOpen) renderOrderedItems(); DOMElements.myFoodCloseBtn?.focus(); });
        DOMElements.myFoodCloseBtn?.addEventListener('click', () => { DOMElements.myFoodPopup?.classList.remove('open'); DOMElements.myFoodIcon?.setAttribute('aria-expanded', 'false'); DOMElements.myFoodIcon?.focus(); });
        // Action Buttons
        DOMElements.callStaffIcon?.addEventListener('click', handleCallStaff);
        DOMElements.orderButton?.addEventListener('click', handleOrderSubmission);
        DOMElements.myFoodCheckoutButton?.addEventListener('click', handleCheckout);
        // Swipe Gestures
        setupSwipeListeners();
        console.log("Event listeners setup complete.");
    }

    // --- Swipe Logic (Unchanged) ---
    function setupSwipeListeners() { /* ... code ... */ if (!DOMElements.imageContainer) return; let touchStartX = 0, touchEndX = 0, isSwiping = false, isDragging = false, dragStartX = 0; DOMElements.imageContainer.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; isSwiping = true; } }, { passive: true }); DOMElements.imageContainer.addEventListener('touchmove', (e) => { if (isSwiping && e.touches.length === 1) touchEndX = e.touches[0].clientX; }, { passive: true }); DOMElements.imageContainer.addEventListener('touchend', (e) => { if (!isSwiping || e.changedTouches.length !== 1) { isSwiping = false; return; } touchEndX = e.changedTouches[0].clientX; handleSwipeAction(touchStartX, touchEndX); isSwiping = false; touchStartX = 0; touchEndX = 0; }); DOMElements.imageContainer.addEventListener('mousedown', (e) => { if (e.button !== 0) return; isDragging = true; dragStartX = e.clientX; DOMElements.imageContainer.style.cursor = 'grabbing'; e.preventDefault(); }); document.addEventListener('mousemove', (e) => { if (!isDragging) return; }); document.addEventListener('mouseup', (e) => { if (!isDragging || e.button !== 0) return; isDragging = false; const dragEndX = e.clientX; DOMElements.imageContainer.style.cursor = 'grab'; handleSwipeAction(dragStartX, dragEndX); dragStartX = 0; }); document.addEventListener('mouseleave', (e) => { if (isDragging && !e.relatedTarget && !e.toElement) { isDragging = false; DOMElements.imageContainer.style.cursor = 'grab'; dragStartX = 0; } }); }
    function handleSwipeAction(startX, endX) { /* ... code ... */ const deltaX = endX - startX; if (Math.abs(deltaX) > CONFIG.SWIPE_THRESHOLD_PX) { if (deltaX > 0) showPreviousItem(); else showNextItem(); } }
    function showPreviousItem() { /* ... code ... */ if (currentFilteredItems.length <= 1 || currentDisplayIndex < 0) return; let newIndex = (currentDisplayIndex - 1 + currentFilteredItems.length) % currentFilteredItems.length; showItemDetails(newIndex, 'prev'); }
    function showNextItem() { /* ... code ... */ if (currentFilteredItems.length <= 1 || currentDisplayIndex < 0) return; let newIndex = (currentDisplayIndex + 1) % currentFilteredItems.length; showItemDetails(newIndex, 'next'); }


    // ========================================================================
    // INITIALIZATION (Unchanged)
    // ========================================================================
    async function initializeApp() {
        console.log("DOM Content Loaded. Initializing App...");
         setupPriceElementCache();
        selectedTableNumber = loadSelectedTable();
        updateTableDisplay(selectedTableNumber);
        populateTableList(CONFIG.MAX_TABLE_NUMBER);
        if (!selectedTableNumber) showTablePromptNotification();
        // else document.title = `เมนูอาหาร - ${CONFIG.TABLE_NUMBER_PREFIX}${selectedTableNumber}`; // Already set in updateTableDisplay

        loadCartFromLocalStorage();
        loadOrderedItemsFromLocalStorage();
        renderCart(); updateCartIcon(); renderOrderedItems(); updateMyFoodIcon();

        const dataLoaded = await fetchMenuData(); // Calls modified fetchMenuData

        if (dataLoaded) {
            console.log('Categories Received:', allCategories);
            populateCategoryBar();
             const firstCategoryElement = DOMElements.categoryBarContainer?.querySelector('.category-item');
             if (firstCategoryElement) {
                  handleCategoryClick({ currentTarget: firstCategoryElement });
             } else if (allCategories.length === 0) {
                  console.warn("Data loaded, but no categories found.");
                  if(DOMElements.bottomMenuContainer) DOMElements.bottomMenuContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูให้แสดง</p>';
                  showItemDetails(-1);
             }
        } else {
            showItemDetails(-1);
        }
        setupEventListeners(); // Calls modified handlers via event listeners
        console.log("App Initialization complete.");
    }

    // --- Start the application ---
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initializeApp); }
    else { initializeApp(); }

</script>
</body>
</html>
