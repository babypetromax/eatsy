
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เมนูอาหาร - [Eatsy ปลวกแดง]</title>
    <meta name="description" content="เมนูอาหารร้าน Eatsy Healthy Food and Bar ปลวกแดง Healthy Bowl ! อาหารสุขภาพ, อาหารทะเลสุด, สลัดเลิศๆ, อัปเดตล่าสุด ดูเมนูและสั่งออนไลน์ได้เลย ราคาล่าสุด สั่งเดลิเวอรี่ออนไลน์ได้เลย!">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#656D4A">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- Base Styles --- */
        :root {
            /* Theme Colors */
            --color-darkest: #333D29;
            --color-dark-green: #414833;
            --color-medium-green: #656D4A;
            --color-light-green: #A4AC86; /* Used for Order Button */
            --color-lightest-green: #C2C5AA;
            --color-light-beige: #B6AD90; /* Used for Cart Header */
            --color-medium-beige: #A68A64; /* Color for Price and Checkout Button */
            --color-text-primary: #343A40;
            --color-text-secondary: #6C757D;
            --color-background: #F8F9FA;
            --color-white: #FFFFFF;
            --color-white-transparent: rgba(255, 255, 255, 0.9); /* Cart background */
            --color-footer-transparent: rgba(248, 249, 250, 0.9); /* Cart footer background */
            --color-border: #dee2e6;
            --color-danger: #dc3545; /* Red for remove/delete actions */
            --color-info: #17a2b8; /* Info color for prompts */
            --color-modal-bg: rgba(0, 0, 0, 0.6);
            /* Transitions */
            --transition-speed-fast: 0.2s;
            --transition-speed-medium: 0.3s;
            --transition-speed-slow: 0.5s;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--color-background); color: var(--color-text-primary);
            overscroll-behavior-y: contain;
            padding-bottom: 225px; /* Space for floating icons */
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 10px; }

        /* --- Top Section --- */
        .top-section { width: calc(100% + 20px); margin-bottom: 15px; position: relative; margin-left: -10px; margin-right: -10px; }
        .image-container { width: 100%; aspect-ratio: 8 / 9; overflow: hidden; background-color: #e0e0e0; position: relative; cursor: grab; }
        .image-container:active { cursor: grabbing; }
        .main-food-image { width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; }

        /* --- Swipe Animation Classes --- */
        @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-container.slide-out-left { animation: slideOutLeft var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-right { animation: slideInRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-out-right { animation: slideOutRight var(--transition-speed-medium) ease-out forwards; }
        .image-container.slide-in-left { animation: slideInLeft var(--transition-speed-medium) ease-out forwards; }

        /* --- Menu Details --- */
        #menu-details { padding: 15px 10px; background-color: var(--color-white); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); display: none; margin-left: 10px; margin-right: 10px; width: calc(100% - 20px); border-radius: 0 0 10px 10px; }
        .menu-name-container { margin-bottom: 5px; }
        #menu-name { font-size: 28px; font-weight: bold; text-transform: uppercase; margin: 0; color: var(--color-darkest); line-height: 1.2; }
        #menu-description { font-size: 14px; margin: 0 0 10px 0; color: var(--color-medium-green); line-height: 1.5; }
        #menu-price { font-size: 18px; font-weight: bold; margin: 0; color: var(--color-medium-beige); display: flex; align-items: center; flex-wrap: wrap; gap: 5px 0; }
        .price-item { display: inline-flex; align-items: center; margin-right: 10px; }
        .price-label { font-size: 0.8em; font-weight: normal; color: var(--color-text-secondary); margin-right: 4px; }
        .price-value { margin-right: 5px; }
        .add-to-cart-button { background-color: var(--color-medium-green); color: var(--color-white); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; font-weight: bold; line-height: 24px; text-align: center; cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease; padding: 0; flex-shrink: 0; }
        .add-to-cart-button:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        .price-separator { margin: 0 8px; font-weight: normal; color: #adb5bd; }
        .hidden { display: none !important; }

        /* --- Menu Options Styling --- */
        .menu-options-section { border-top: 1px solid var(--color-border); padding-top: 15px; }
        .menu-options-container { margin-bottom: 10px; }
        .option-title { font-size: 0.95em; font-weight: bold; color: var(--color-dark-green); margin: 0 0 8px 0; display: block; }
        .option-choices { display: flex; flex-wrap: wrap; gap: 8px; }
        .option-choice-label { display: inline-flex; align-items: center; background-color: #e9ecef; color: var(--color-text-secondary); padding: 6px 12px; border-radius: 15px; cursor: pointer; transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease; font-size: 0.85em; border: 1px solid transparent; user-select: none; }
        .option-choice-label input[type="radio"] { appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 0; height: 0; opacity: 0; position: absolute; margin: 0; padding: 0; }
        .option-choice-label:has(input[type="radio"]:checked) { background-color: var(--color-medium-green); color: var(--color-white); font-weight: bold; border: 1px solid var(--color-dark-green); }
        .option-choice-label:not(:has(input[type="radio"]:checked)):hover { background-color: #ced4da; }
        /* Options in Cart/Ordered List */
        .list-item-options { font-size: 0.8em; color: var(--color-text-secondary); margin-top: 3px; margin-left: 10px; line-height: 1.3; }
        .list-item-options span { display: block; margin-bottom: 2px; }
        /* Options in Receipt List */
        .receipt-item-options { font-size: 0.8em; color: var(--color-text-secondary); grid-column: 1 / -1; padding-left: 15px; margin-top: -5px; margin-bottom: 5px; line-height: 1.4; }
        .receipt-item-options span { display: block; }

        /* --- Category Bar --- */
        .category-bar { width: 100%; overflow-x: auto; overflow-y: hidden; white-space: nowrap; background-color: var(--color-white); padding: 12px 5px; display: flex; align-items: center; flex-shrink: 0; box-sizing: border-box; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); -ms-overflow-style: none; scrollbar-width: none; }
        .category-bar::-webkit-scrollbar { display: none; }
        .category-item { display: flex; flex-direction: column; align-items: center; padding: 8px 15px; margin: 0 5px; background-color: transparent; color: var(--color-text-secondary); border-radius: 8px; cursor: pointer; flex-shrink: 0; font-size: 0.85em; text-align: center; transition: background-color var(--transition-speed-medium) ease, color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease; border-bottom: 2px solid transparent; user-select: none; }
        .category-item.selected { color: var(--color-dark-green); font-weight: bold; border-bottom: 2px solid var(--color-medium-green); background-color: #E9ECEF; }
        .category-item i { font-size: 1.4em; margin-bottom: 4px; pointer-events: none; }
        .category-item span { font-size: 0.75em; white-space: normal; line-height: 1.2; pointer-events: none; }
        .category-item:hover:not(.selected) { color: #495057; background-color: #F1F3F4; transform: translateY(-2px); }

        /* --- Pinterest-Style Menu Grid --- */
        .bottom-menu { width: 100%; padding-top: 10px; column-count: 2; column-gap: 10px; contain: layout paint; }
        .menu-item { display: inline-block; width: 100%; margin-bottom: 10px; border-radius: 10px; overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform var(--transition-speed-fast) ease-in-out, box-shadow var(--transition-speed-fast) ease-in-out, filter var(--transition-speed-fast) ease-in-out; break-inside: avoid; position: relative; }
        .menu-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.05); }
        .menu-item img { width: 100%; height: auto; display: block; }

        /* --- Floating Icons --- */
        .floating-icon { position: fixed; right: 20px; background-color: var(--color-medium-green); color: var(--color-white); width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: background-color var(--transition-speed-medium) ease, transform var(--transition-speed-fast) ease; }
        .floating-icon:hover { background-color: var(--color-dark-green); transform: scale(1.1); }
        .icon-badge { position: absolute; top: -5px; right: -5px; background-color: var(--color-danger); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; justify-content: center; align-items: center; line-height: 22px; border: 1px solid white; transition: transform var(--transition-speed-fast) ease; }
        .floating-icon.updated .icon-badge { transform: scale(1.3); }
        #call-staff-icon-container { bottom: 150px; z-index: 1002; font-size: 22px; }
        #my-food-icon-container { bottom: 85px; z-index: 1001; font-size: 22px; }
        #cart-icon-container { bottom: 20px; z-index: 1000; font-size: 24px; }
        #call-staff-icon-container .fa-spinner { font-size: 24px; }

        /* --- Popups (Cart, My Food) --- */
        .popup-base { position: fixed; right: 20px; width: 90%; max-width: 380px; background-color: var(--color-white-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); display: none; flex-direction: column; overflow: hidden; opacity: 0; transform: translateY(20px) scale(0.95); transition: opacity var(--transition-speed-medium) ease-out, transform var(--transition-speed-medium) ease-out, bottom var(--transition-speed-medium) ease-out; pointer-events: none; }
        .popup-base.open { display: flex; opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        #cart-popup { bottom: 215px; max-height: 45vh; z-index: 998; }
        #my-food-popup { bottom: 150px; max-height: 50vh; z-index: 999; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--color-border); border-radius: 10px 10px 0 0; flex-shrink: 0; }
        .popup-header h3 { margin: 0; font-size: 1.1em; color: var(--color-darkest); }
        .popup-close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; }
        .cart-header { background-color: rgba(182, 173, 144, 0.8); } /* Light Beige Transparent */
        .my-food-header { background-color: rgba(164, 172, 134, 0.8); } /* Light Green Transparent */
        .popup-items-list { padding: 5px 15px; overflow-y: auto; flex-grow: 1; }
        /* Base style for items in popups */
        .list-item-base { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .list-item-base:last-child { border-bottom: none; }
        .list-item-details { flex-grow: 1; margin-right: 10px; }
        .list-item-name { font-weight: bold; color: var(--color-dark-green); }
        .list-item-info { color: var(--color-medium-beige); font-size: 0.9em; }
        .list-item-total { font-weight: bold; color: var(--color-medium-beige); flex-shrink: 0;}
        /* Cart specific */
        .cart-item-controls { display: flex; align-items: center; flex-shrink: 0; }
        .cart-quantity-btn { background-color: #e9ecef; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 4px; width: 25px; height: 25px; font-size: 16px; cursor: pointer; margin: 0 5px; line-height: 23px; text-align: center; transition: background-color var(--transition-speed-fast) ease; }
        .cart-quantity-btn:hover { background-color: #ced4da; }
        .cart-item-quantity { min-width: 20px; text-align: center; font-weight: bold; }
        .cart-remove-btn { background: none; border: none; color: var(--color-danger); font-size: 16px; cursor: pointer; margin-left: 10px; transition: color var(--transition-speed-fast) ease; padding: 0 5px;}
        .cart-remove-btn:hover { color: #a0232f; }
        /* Popup Footer */
        .popup-footer { padding: 15px; border-top: 1px solid var(--color-border); background-color: var(--color-footer-transparent); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 0 0 10px 10px; flex-shrink: 0; }
        .popup-actions { display: flex; justify-content: center; gap: 10px; }
        .popup-action-btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: opacity 0.2s ease; flex-grow: 1; margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .popup-action-btn:hover { opacity: 0.85; }
        .popup-action-btn:disabled { background-color: #ccc !important; color: #666 !important; cursor: not-allowed; opacity: 0.7; }
        .popup-action-btn .fa-spinner { font-size: 1em; }
        .order-btn { background-color: var(--color-light-green); color: var(--color-darkest); }
        .my-food-checkout-btn { background-color: var(--color-medium-beige); color: var(--color-white); }
        .popup-empty-message { text-align: center; color: var(--color-text-secondary); padding: 20px; }
        /* My Food specific */
        #my-food-total-display { text-align: right; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; color: var(--color-darkest); }
        /* Order Group Styling in My Food list */
        .order-group-header {
            font-weight: bold; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 0.95em; color: var(--color-darkest); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;
        }
        .order-group-header:first-of-type { margin-top: 0; padding-top: 0; border-top: none; }
        .order-id-display { font-size: 0.9em; color: var(--color-text-secondary); font-weight: normal; }
        .ordered-item-status { font-size: 0.9em; color: var(--color-info); font-weight: normal; margin-left: 10px; }
        .ordered-item-cashier-notes { font-size: 0.85em; color: var(--color-text-secondary); margin-top: 3px; font-weight: normal; display: block; width: 100%; }

        /* --- Table Number Display & Modal --- */
        #table-number-display { position: fixed; bottom: 10px; left: 10px; z-index: 1003; background-color: var(--color-medium-green); color: var(--color-white); font-family: 'Sarabun', 'Inter', sans-serif; font-size: 0.9rem; font-weight: bold; padding: 8px 15px; border-radius: 9999px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease; user-select: none; }
        #table-number-display:hover { background-color: var(--color-dark-green); transform: scale(1.05); }
        #table-number-display .table-icon { margin-right: 5px; }
        #table-number-display .placeholder-text { font-style: italic; opacity: 0.8; }
        #table-select-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-modal-bg); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity var(--transition-speed-medium) ease; }
        #table-select-modal.open { display: flex; opacity: 1; }
        .table-select-content { background-color: var(--color-white); border-radius: 10px; padding: 20px; max-width: 90%; width: 300px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform var(--transition-speed-medium) ease; max-height: 80vh; display: flex; flex-direction: column; }
        #table-select-modal.open .table-select-content { transform: scale(1); }
        .table-select-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--color-border); padding-bottom: 10px; flex-shrink: 0; }
        .table-select-header h4 { margin: 0; font-size: 1.2em; color: var(--color-darkest); }
        .table-select-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary); line-height: 1; padding: 0; }
        #table-list { overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; padding: 5px; flex-grow: 1; }
        .table-list-item { padding: 10px; border: 1px solid var(--color-border); border-radius: 5px; text-align: center; font-weight: bold; cursor: pointer; background-color: var(--color-background); transition: background-color var(--transition-speed-fast) ease, color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease; }
        .table-list-item:hover { background-color: var(--color-lightest-green); color: var(--color-darkest); transform: scale(1.05); }
        .table-list-item.selected { background-color: var(--color-medium-green); color: var(--color-white); border-color: var(--color-dark-green); }

        /* --- First Load Prompt Notification --- */
        #table-prompt-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: var(--color-info); color: var(--color-white); padding: 10px 20px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 1100; font-size: 0.9em; font-weight: bold; text-align: center; opacity: 0; transition: top var(--transition-speed-medium) ease-out, opacity var(--transition-speed-medium) ease-out; }
        #table-prompt-notification.show { top: 0; opacity: 1; }

        /* --- Receipt Modal Styles --- */
        #receipt-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-modal-bg); display: none; justify-content: center; align-items: center; z-index: 1060; opacity: 0; transition: opacity var(--transition-speed-medium) ease; padding: 15px; box-sizing: border-box; }
        #receipt-modal.open { display: flex; opacity: 1; }
        .receipt-modal-content { max-width: 90%; width: 380px; max-height: 90vh; display: flex; flex-direction: column; background-color: var(--color-white); border-radius: 8px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); overflow: hidden; }
        #receipt-content { padding: 25px; overflow-y: auto; font-family: 'Sarabun', 'Courier New', Courier, monospace; color: var(--color-text-primary); flex-grow: 1; }
        .receipt-header { text-align: center; padding-bottom: 15px; margin-bottom: 5px; /* Reduced margin */ }
        .receipt-logo { max-width: 70px; height: auto; margin-bottom: 10px; }
        .receipt-header h3 { font-size: 1.2em; font-weight: bold; color: var(--color-darkest); margin: 0 0 8px 0; }
        .receipt-info { font-size: 0.85em; color: var(--color-text-secondary); line-height: 1.5; margin-bottom: 5px; }
        .receipt-info span { margin: 0 5px; }
        #receipt-order-id { font-size: 0.8em; color: var(--color-text-secondary); margin-bottom: 10px; display: block; } /* Style for Order ID */
        .receipt-title { text-align: center; font-size: 1.1em; /* Slightly smaller */ font-weight: bold; margin: 10px 0 8px 0; color: var(--color-darkest); }
        .receipt-title-hr { border: none; border-top: 1px dashed var(--color-border); margin: 5px auto 10px auto; width: 80%; }
        /* Status/Notes in Receipt */
        #receipt-status-notes-area { text-align: center; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; }
        #receipt-current-status { font-size: 0.9em; font-weight: bold; color: var(--color-info); display: block; margin-bottom: 3px; }
        #receipt-cashier-notes { font-size: 0.85em; color: var(--color-text-secondary); display: block; }
        /* Item Header/List */
        #receipt-items-header { display: grid; grid-template-columns: 1fr minmax(3.5em, auto) minmax(4.5em, auto) minmax(5em, auto); gap: 5px 10px; padding: 8px 0; font-size: 0.8em; font-weight: bold; border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); margin-bottom: 5px; color: var(--color-text-secondary); }
        #receipt-items-header span { display: block; }
        #receipt-items-header .header-item { text-align: left; }
        #receipt-items-header .header-qty { text-align: center; }
        #receipt-items-header .header-price { text-align: right; }
        #receipt-items-header .header-total { text-align: right; }
        #receipt-items-header .secondary-text { font-size: 0.9em; font-weight: normal; opacity: 0.8; }
        #receipt-items-list { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--color-border); }
        .receipt-item { display: grid; grid-template-columns: 1fr minmax(3.5em, auto) minmax(4.5em, auto) minmax(5em, auto); gap: 5px 10px; padding: 8px 0; font-size: 0.9em; align-items: start; }
        .receipt-item-name { font-weight: normal; line-height: 1.4; text-align: left; }
        .receipt-item-qty { text-align: center; font-weight: normal; }
        .receipt-item-price { text-align: right; color: var(--color-text-secondary); }
        .receipt-item-total { text-align: right; font-weight: bold; color: var(--color-dark-green); }
        /* Receipt Total */
        .receipt-total { text-align: right; font-size: 1.15em; font-weight: bold; margin-top: 10px; margin-bottom: 20px; padding-top: 15px; border-top: 1px solid var(--color-text-secondary); border-bottom: 3px double var(--color-darkest); padding-bottom: 5px; color: var(--color-darkest); }
        .receipt-total .total-label-eng { display: block; font-size: 0.7em; font-weight: normal; color: var(--color-text-secondary); margin-top: 2px; }
        /* Receipt QR/Footer */
        .receipt-qr { text-align: center; margin-bottom: 20px; }
        .receipt-qr img { max-width: 295px; height: auto; display: inline-block; border: 1px solid var(--color-border); padding: 6px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .receipt-footer { text-align: center; font-size: 0.85em; color: var(--color-medium-green); padding-top: 15px; border-top: 1px dashed var(--color-border); line-height: 1.5; }
        /* Receipt Actions */
        .receipt-actions { display: flex; justify-content: center; gap: 10px; padding: 15px 20px; background-color: var(--color-background); border-top: 1px solid var(--color-border); flex-shrink: 0; }
        .receipt-close-btn { background-color: var(--color-text-secondary); }
        .receipt-action-btn .fa-download, .receipt-action-btn .fa-times { margin-right: 8px; }

        /* --- Responsive Adjustments --- */
        @media (min-width: 640px) { .container { padding: 0 20px; } .bottom-menu { column-count: 3; } #menu-name { font-size: 32px; } #menu-price { font-size: 20px; } .price-label { font-size: 0.8em; } .add-to-cart-button { width: 28px; height: 28px; line-height: 28px; font-size: 18px; } .top-section { width: calc(100% + 40px); margin-left: -20px; margin-right: -20px; } #menu-details { margin-left: 20px; margin-right: 20px; width: calc(100% - 40px); } #table-number-display { font-size: 1rem; bottom: 15px; left: 15px; padding: 10px 20px; } #table-prompt-notification { font-size: 1em; } .receipt-modal-content { width: 420px; } .receipt-header h3 { font-size: 1.4em; } .receipt-title { font-size: 1.2em; } #receipt-items-header { font-size: 0.85em; } .receipt-item { font-size: 0.95em; } .receipt-total { font-size: 1.2em; } }
        @media (min-width: 768px) { .bottom-menu { column-count: 4; } }
        @media (min-width: 1024px) { .bottom-menu { column-count: 5; } }
        @media (min-width: 1280px) { .bottom-menu { column-count: 6; } }
    </style>
</head>
<body>
    <!-- Table Number Display -->
    <div id="table-number-display" title="เลือกหมายเลขโต๊ะ">
        <span id="table-number-text"><span class="placeholder-text">เลือกโต๊ะ</span></span>
    </div>

    <!-- Table Selection Modal -->
    <div id="table-select-modal">
        <div class="table-select-content">
            <div class="table-select-header">
                <h4>เลือกหมายเลขโต๊ะ</h4>
                <button class="table-select-close-btn" title="ปิด">×</button>
            </div>
            <div id="table-list"></div>
        </div>
    </div>

    <!-- Table Prompt Notification -->
    <div id="table-prompt-notification">
        <i class="fas fa-info-circle"></i> กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ
    </div>

    <div class="container">
        <!-- Top Section: Image and Details -->
        <div class="top-section">
             <div class="image-container" id="image-swipe-area">
                 <img id="main-food-image" class="main-food-image" src="https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Salad Bowl">
             </div>
             <div id="menu-details">
                 <div class="menu-name-container"><h2 id="menu-name">ชื่อเมนู</h2></div>
                 <p id="menu-description">คำอธิบายเมนูอาหาร</p>
                 <p id="menu-price">
                     <span class="price-item hidden"><span class="price-label" id="label-small">เล็ก:</span><span class="price-value" id="price-small">0</span><button class="add-to-cart-button" data-size="Small" title="เพิ่มขนาดเล็กลงตระกร้า">+</button></span>
                      <span class="price-separator hidden" id="price-sep-small">|</span>
                     <span class="price-item hidden"><span class="price-label" id="label-normal">ปกติ:</span><span class="price-value" id="price-normal">0</span><button class="add-to-cart-button" data-size="Normal" title="เพิ่มขนาดปกติลงตระกร้า">+</button></span>
                     <span class="price-separator hidden" id="price-sep">|</span>
                     <span class="price-item hidden"><span class="price-label" id="label-extra">พิเศษ:</span><span class="price-value" id="price-extra">0</span><button class="add-to-cart-button" data-size="Extra" title="เพิ่มขนาดพิเศษลงตระกร้า">+</button></span>
                     <span class="price-separator hidden" id="price-sep-family">|</span>
                     <span class="price-item hidden"><span class="price-label" id="label-family">ครอบครัว:</span><span class="price-value" id="price-family">0</span><button class="add-to-cart-button" data-size="Family" title="เพิ่มขนาดครอบครัวลงตระกร้า">+</button></span>
                 </p>
                 <div id="menu-options-section" class="menu-options-section" style="margin-top: 15px;">
                     <div id="menu-option1-container" class="menu-options-container hidden"><h4 class="option-title" id="option1-title"></h4><div class="option-choices" id="option1-choices"></div></div>
                     <div id="menu-option2-container" class="menu-options-container hidden" style="margin-top: 10px;"><h4 class="option-title" id="option2-title"></h4><div class="option-choices" id="option2-choices"></div></div>
                 </div>
             </div>
        </div>
        <div class="category-bar"></div>
        <div class="bottom-menu"></div>
    </div>

    <!-- Floating Icons -->
    <div id="call-staff-icon-container" class="floating-icon" title="เรียกพนักงาน"><i class="fas fa-bell"></i></div>
    <div id="my-food-icon-container" class="floating-icon" title="เปิด/ปิด รายการอาหารของฉัน"><i class="fas fa-receipt"></i><span id="my-food-item-count" class="icon-badge hidden">0</span></div>
    <div id="cart-icon-container" class="floating-icon" title="เปิด/ปิด ตระกร้า"><i class="fas fa-shopping-cart"></i><span id="cart-item-count" class="icon-badge hidden">0</span></div>

    <!-- My Food Popup -->
    <div id="my-food-popup" class="popup-base">
        <div class="popup-header my-food-header"><h3>รายการอาหารที่สั่งแล้ว</h3><button class="popup-close-btn my-food-close-btn" title="ปิดรายการ">×</button></div>
        <div class="popup-items-list" id="my-food-items-list"><p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p></div>
        <div class="popup-footer my-food-footer">
            <div id="my-food-total-display"></div>
            <div class="popup-actions my-food-actions"><button class="popup-action-btn my-food-checkout-btn" id="my-food-checkout-button">สรุปยอดและเรียกชำระเงิน</button></div>
        </div>
    </div>

    <!-- Cart Popup -->
    <div id="cart-popup" class="popup-base">
        <div class="popup-header cart-header"><h3>ตระกร้าสินค้า</h3><button class="popup-close-btn cart-close-btn" title="ปิดตระกร้า">×</button></div>
        <div class="popup-items-list" id="cart-items-list"><p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p></div>
        <div class="popup-footer cart-footer">
            <div class="popup-actions cart-actions"><button class="popup-action-btn order-btn" id="order-button">สั่งรายการอาหาร</button></div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal">
        <div class="receipt-modal-content">
            <div id="receipt-content">
                <div class="receipt-header">
                    <img src="https://raw.githubusercontent.com/babypetromax/eatsy/main/icons/icon-512x512.png" alt="Logo" class="receipt-logo">
                    <h3 id="receipt-restaurant-name">ชื่อร้าน</h3>
                    <p class="receipt-info"><span id="receipt-table-info">โต๊ะ: -</span> | <span id="receipt-datetime">วันที่: - เวลา: -</span></p>
                    <p id="receipt-order-id">Order ID: -</p> <!-- Added placeholder for Order ID -->
                </div>
                <h4 class="receipt-title">ใบสรุปรายการอาหาร</h4><hr class="receipt-title-hr">
                <div id="receipt-status-notes-area" style="display: none;"> <!-- Initially hidden -->
                     <span id="receipt-current-status">สถานะปัจจุบัน: -</span>
                     <span id="receipt-cashier-notes"></span> <!-- Placeholder for notes -->
                 </div>
                <div id="receipt-items-header"><span class="header-item">รายการ<br><span class="secondary-text">(Item)</span></span><span class="header-qty">จำนวน<br><span class="secondary-text">(Qty)</span></span><span class="header-price">ราคา<br><span class="secondary-text">(Price)</span></span><span class="header-total">รวม<br><span class="secondary-text">(Total)</span></span></div>
                <div id="receipt-items-list"></div>
                <div class="receipt-total" id="receipt-grand-total"></div>
                <div class="receipt-qr"><p style="font-size: 0.9em; margin-bottom: 5px; color: var(--color-text-secondary);">สแกนเพื่อชำระเงิน</p><img id="receipt-qr-image" src="" alt="QR Code Scan to Pay"></div>
                <div class="receipt-footer"><p>สุขภาพดีเริ่มต้นที่นี่ ขอบคุณที่ให้Eatsy เป็นส่วนหนึ่งนะคะ ☀️<br>Good health starts here. Thanks for making us a part of your wellness journey! 😊</p></div>
            </div>
            <div class="receipt-actions">
                <button id="save-receipt-btn" class="popup-action-btn receipt-action-btn"><i class="fas fa-download"></i> บันทึกเป็นรูปภาพ</button>
                <button id="close-receipt-btn" class="popup-action-btn receipt-action-btn receipt-close-btn"><i class="fas fa-times"></i> ปิด</button>
            </div>
        </div>
    </div>

<script>
    // ========================================================================
    // START: Configuration
    // ========================================================================
    // URL for the Google Apps Script handling Orders & Status (doPost, doGet with actions)
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwdScbwdKQMfSnjz1NxSSjZnTigzw46kvZIV0Xv5b4SJeVOMMTrKVF2SZgw0JQcKGli/exec"; // <<< PASTE YOUR NEW WEB APP URL HERE
    const API_ACCESS_TOKEN = "1234"; // <<< PASTE THE SAME TOKEN YOU USED IN GAS

    // URL for the Google Apps Script handling initial Menu Fetch (optional, could be same as above)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHffrMtJPHnCf4NIryF-JUqOg60YO9k-FqCHAAfoqhzMxLI0Ot_rxg_C_87A01Yafh/exec"; // <-- Your Menu Fetch Script URL (if different)

    const RESTAURANT_NAME = "Eatsy Healthy Food and Bar ปลวกแดง";
    const QR_CODE_IMAGE_URL = "https://raw.githubusercontent.com/babypetromax/eatsy/main/icons/qrpamentkbank.jpg";
    const TABLE_NUMBER_PREFIX = "โต๊ะ ";
    const MAX_TABLE_NUMBER = 30;
    const TABLE_SELECT_PROMPT_MESSAGE = "กรุณาเลือกหมายเลขโต๊ะของท่านค่ะ";
    const TABLE_STORAGE_KEY = 'selectedTableData_v123';
    const TABLE_EXPIRY_HOURS = 6;
    const CART_LOCAL_STORAGE_KEY = 'menuCartData_v123_db';
    const ORDERED_ITEMS_LOCAL_STORAGE_KEY = 'menuOrderedItemsData_v123_db';
    // ========================================================================
    // START: Telegram Configuration (Obfuscated)
    // ========================================================================
    const tPart1 = 'NzA0ODk5NzkxODpB';
    const tPart2 = 'QUhZdDVqQk9HM1E2';
    const tPart3 = 'N2JwenRJbl9SR3BE';
    const tPart4 = 'Q2NYMHlBVVlWQQ==';
    const CHAT_ID = '-1002634956608';
    // ========================================================================
    // END: Telegram Configuration
    // ========================================================================

    // --- State Variables ---
    let menuData = [];
    let allCategories = [];
    let cartItems = [];
    let orderedItems = []; // Array of item objects, potentially from multiple orders
    let currentActiveOrderId = null; // ID of the latest order submitted in this session, used for status checks/receipt
    let selectedTableNumber = null;
    let currentDisplayedItemId = null; // ID of the item currently shown in the top details section
    let currentCategory = null; // Name of the currently selected category
    let currentFilteredItems = []; // Items currently displayed in the bottom grid (filtered by category)
    let currentIndex = -1; // Index of the item shown in details within currentFilteredItems
    let touchStartX = 0;
    let touchEndX = 0;
    let isSwiping = false;
    const swipeThreshold = 50;

    // --- DOM Element Caching ---
    const tableNumberDisplay = document.getElementById('table-number-display');
    const tableNumberText = document.getElementById('table-number-text');
    const tableSelectModal = document.getElementById('table-select-modal');
    const tableListContainer = document.getElementById('table-list');
    const tableSelectCloseBtn = tableSelectModal?.querySelector('.table-select-close-btn');
    const tablePromptNotification = document.getElementById('table-prompt-notification');
    const mainFoodImage = document.getElementById('main-food-image');
    const imageContainer = document.getElementById('image-swipe-area');
    const bottomMenu = document.querySelector('.bottom-menu');
    const menuDetailsContainer = document.getElementById('menu-details');
    const menuNameElement = document.getElementById('menu-name');
    const menuDescriptionElement = document.getElementById('menu-description');
    const menuPriceContainer = document.getElementById('menu-price');
    const priceElementsCache = { // Cache for price elements
        'Small': { label: document.getElementById('label-small'), value: document.getElementById('price-small'), button: menuPriceContainer?.querySelector('button[data-size="Small"]'), separator: document.getElementById('price-sep-small') },
        'Normal': { label: document.getElementById('label-normal'), value: document.getElementById('price-normal'), button: menuPriceContainer?.querySelector('button[data-size="Normal"]'), separator: null }, // Assuming 'Normal' doesn't have a preceding separator managed here
        'Extra': { label: document.getElementById('label-extra'), value: document.getElementById('price-extra'), button: menuPriceContainer?.querySelector('button[data-size="Extra"]'), separator: document.getElementById('price-sep') },
        'Family': { label: document.getElementById('label-family'), value: document.getElementById('price-family'), button: menuPriceContainer?.querySelector('button[data-size="Family"]'), separator: document.getElementById('price-sep-family') }
    };
    const menuOptionsSection = document.getElementById('menu-options-section');
    const menuOption1Container = document.getElementById('menu-option1-container');
    const menuOption1TitleEl = document.getElementById('option1-title');
    const menuOption1ChoicesEl = document.getElementById('option1-choices');
    const menuOption2Container = document.getElementById('menu-option2-container');
    const menuOption2TitleEl = document.getElementById('option2-title');
    const menuOption2ChoicesEl = document.getElementById('option2-choices');
    const cartIconContainer = document.getElementById('cart-icon-container');
    const cartItemCountBadge = document.getElementById('cart-item-count');
    const cartPopup = document.getElementById('cart-popup');
    const cartItemsList = document.getElementById('cart-items-list');
    const cartCloseBtn = cartPopup?.querySelector('.cart-close-btn');
    const orderButton = document.getElementById('order-button');
    const myFoodIconContainer = document.getElementById('my-food-icon-container');
    const myFoodItemCountBadge = document.getElementById('my-food-item-count');
    const myFoodPopup = document.getElementById('my-food-popup');
    const myFoodItemsList = document.getElementById('my-food-items-list');
    const myFoodTotalDisplay = document.getElementById('my-food-total-display');
    const myFoodCloseBtn = myFoodPopup?.querySelector('.my-food-close-btn');
    const myFoodCheckoutButton = document.getElementById('my-food-checkout-button');
    const callStaffIconContainer = document.getElementById('call-staff-icon-container');
    const receiptModal = document.getElementById('receipt-modal');
    const receiptContent = document.getElementById('receipt-content');
    const receiptRestaurantName = document.getElementById('receipt-restaurant-name');
    const receiptTableInfo = document.getElementById('receipt-table-info');
    const receiptDateTime = document.getElementById('receipt-datetime');
    const receiptOrderIdEl = document.getElementById('receipt-order-id'); // Receipt Order ID element
    const receiptStatusNotesArea = document.getElementById('receipt-status-notes-area'); // Receipt Status/Notes container
    const receiptCurrentStatusEl = document.getElementById('receipt-current-status'); // Receipt Status element
    const receiptCashierNotesEl = document.getElementById('receipt-cashier-notes'); // Receipt Notes element
    const receiptItemsList = document.getElementById('receipt-items-list');
    const receiptGrandTotal = document.getElementById('receipt-grand-total');
    const receiptQrImage = document.getElementById('receipt-qr-image');
    const saveReceiptBtn = document.getElementById('save-receipt-btn');
    const closeReceiptBtn = document.getElementById('close-receipt-btn');

    // --- Utility Functions ---
    /** Gets current date as YYYY-MM-DD string. */
    function getCurrentDateString() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
    /** Gets current local date and time strings (Buddhist Era for date). */
    function getCurrentLocalDateTimeStrings() { const now = new Date(); const locale = 'th-TH'; return { date: new Intl.DateTimeFormat(locale, { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'buddhist' }).format(now), time: new Intl.DateTimeFormat(locale, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(now) }; }
    /** Calculates expiry timestamp in milliseconds. */
    function getExpiryTimestamp(hours) { return Date.now() + (hours * 60 * 60 * 1000); }
    /** Safely parses JSON from localStorage. */
    function safeJsonParse(key) { try { const data = localStorage.getItem(key); if (data) return JSON.parse(data); } catch (e) { console.error(`LS Error (Parse ${key}):`, e); localStorage.removeItem(key); } return null; }

    // --- Table Management ---
    /** Opens the table selection modal. */
    function openTableSelectModal() { if (tableSelectModal && tableListContainer) { tableListContainer.querySelectorAll('.table-list-item').forEach(item => { item.classList.toggle('selected', item.dataset.table === selectedTableNumber); }); tableSelectModal.classList.add('open'); } }
    /** Closes the table selection modal. */
    function closeTableSelectModal() { if (tableSelectModal) tableSelectModal.classList.remove('open'); }
    /** Populates the table list in the modal. */
    function populateTableList(maxTable) { if (!tableListContainer) return; tableListContainer.innerHTML = ''; const fragment = document.createDocumentFragment(); for (let i = 1; i <= maxTable; i++) { const tableNumStr = String(i); const item = document.createElement('div'); item.classList.add('table-list-item'); item.textContent = tableNumStr; item.dataset.table = tableNumStr; item.addEventListener('click', () => selectTable(tableNumStr)); fragment.appendChild(item); } tableListContainer.appendChild(fragment); }
    /** Handles selecting a table number. */
    function selectTable(tableNumber) { selectedTableNumber = tableNumber; updateTableDisplay(tableNumber); saveSelectedTable(tableNumber); closeTableSelectModal(); document.title = `${RESTAURANT_NAME} - ${TABLE_NUMBER_PREFIX}${tableNumber}`; hideTablePromptNotification(); loadCartFromLocalStorage(); loadOrderedItemsFromLocalStorage(); renderCart(); renderOrderedItems(); updateCartIconCount(); updateMyFoodIconCount(); }
    /** Updates the table number display element. */
    function updateTableDisplay(tableNumber) { if (tableNumberText) { if (tableNumber) { tableNumberText.innerHTML = `<i class="fas fa-chair table-icon"></i>${TABLE_NUMBER_PREFIX}${tableNumber}`; tableNumberText.classList.remove('placeholder-text'); } else { tableNumberText.innerHTML = `<span class="placeholder-text">เลือกโต๊ะ</span>`; tableNumberText.classList.add('placeholder-text'); document.title = `เมนูอาหาร - ${RESTAURANT_NAME}`; } } }
    /** Saves the selected table number and expiry to localStorage. */
    function saveSelectedTable(tableNumber) { const expiry = getExpiryTimestamp(TABLE_EXPIRY_HOURS); const data = { tableNumber: tableNumber, expiry: expiry }; try { localStorage.setItem(TABLE_STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("LS Error (Save Table):", e); } }
    /** Loads the selected table number from localStorage if not expired. */
    function loadSelectedTable() { const data = safeJsonParse(TABLE_STORAGE_KEY); if (data && data.tableNumber && data.expiry && Date.now() < data.expiry) { return data.tableNumber; } if (data) localStorage.removeItem(TABLE_STORAGE_KEY); return null; }
    /** Shows the 'select table' prompt notification. */
    function showTablePromptNotification() { if (tablePromptNotification) tablePromptNotification.classList.add('show'); }
    /** Hides the 'select table' prompt notification. */
    function hideTablePromptNotification() { if (tablePromptNotification) tablePromptNotification.classList.remove('show'); }

    // --- Menu Data Fetching and Display ---
    /** Fetches menu data and categories from the specified Google Script URL. */
    async function fetchMenuData() {
        console.log("Fetching menu data...");
        const loadingIndicator = document.createElement('div');
        loadingIndicator.textContent = 'กำลังโหลดเมนู...';
        loadingIndicator.style.cssText = 'text-align: center; padding: 20px; color: var(--color-text-secondary);';
        const container = document.querySelector('.container');
        const categoryBar = document.querySelector('.category-bar');
        if (container && categoryBar) container.insertBefore(loadingIndicator, categoryBar); else if (container) container.prepend(loadingIndicator);

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); // Using the menu fetch URL
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) { const text = await response.text(); console.error("Non-JSON response received:", text.substring(0, 200)); throw new Error(`Expected JSON, but got ${contentType}. Check GAS deployment and script output.`); }
            const data = await response.json();
            if (data.error || data.success === false) throw new Error(`Script error: ${data.message || 'Unknown error from script'}`);
            if (!data || !Array.isArray(data.menuData) || !Array.isArray(data.categories)) { console.error("Invalid data structure received:", data); throw new Error("Invalid data structure received from script."); }
            console.log("Menu data fetched successfully:", data.menuData.length, "items,", data.categories.length, "categories.");
            menuData = data.menuData;
            allCategories = data.categories;
            return true;
        } catch (error) {
            console.error("Error fetching or processing menu data:", error);
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<p style="color: red; text-align: center; padding: 20px; background-color: #ffebee; border: 1px solid red; border-radius: 5px;">
                ❌ เกิดข้อผิดพลาดในการโหลดข้อมูลเมนู:<br><small>${error.message}</small><br>โปรดลองรีเฟรชหน้า หรือติดต่อพนักงาน</p>`;
            if (container && categoryBar) container.insertBefore(errorDiv, categoryBar); else if (container) container.prepend(errorDiv);
            menuData = []; allCategories = []; return false;
        } finally {
            if (loadingIndicator) loadingIndicator.remove();
        }
    }
    /** Saves the current cart to localStorage for the selected table. */
    function saveCartToLocalStorage() { if (!selectedTableNumber) return; const data = { table: selectedTableNumber, date: getCurrentDateString(), items: cartItems }; try { localStorage.setItem(CART_LOCAL_STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("LS Error (Save Cart):", e); } }
    /** Loads the cart from localStorage if it belongs to the current table. */
    function loadCartFromLocalStorage() { cartItems = []; const parsedData = safeJsonParse(CART_LOCAL_STORAGE_KEY); if (parsedData && Array.isArray(parsedData.items) && parsedData.table === selectedTableNumber) { cartItems = parsedData.items; } else if (parsedData && parsedData.table !== selectedTableNumber) { console.log(`Ignoring cart data from table ${parsedData.table}. Current table: ${selectedTableNumber}.`); } }
    /** Saves the ordered items list to localStorage for the selected table. */
    function saveOrderedItemsToLocalStorage() { if (!selectedTableNumber) return; const data = { table: selectedTableNumber, date: getCurrentDateString(), items: orderedItems }; try { localStorage.setItem(ORDERED_ITEMS_LOCAL_STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("LS Error (Save Ordered):", e); } }
    /** Loads ordered items from localStorage, ensuring structure and setting active order ID. */
    function loadOrderedItemsFromLocalStorage() {
        orderedItems = []; currentActiveOrderId = null;
        const parsedData = safeJsonParse(ORDERED_ITEMS_LOCAL_STORAGE_KEY);
        if (parsedData && Array.isArray(parsedData.items) && parsedData.table === selectedTableNumber) {
            // Ensure items have necessary fields, provide defaults if missing from old storage
            orderedItems = parsedData.items.map(item => ({
                ...item,
                orderId: item.orderId || null, // Ensure orderId exists
                orderedAt: item.orderedAt || (new Date(0)).toISOString() // Default if missing
            }));
            console.log(`Loaded ordered items for table ${selectedTableNumber}. Items: ${orderedItems.length}`);
            // Try to set the currentActiveOrderId from the latest loaded item
            if (orderedItems.length > 0) {
                // Sort by orderedAt descending to find the latest confirmed order
                const latestOrder = [...orderedItems]
                    .filter(item => item.orderedAt && item.orderId) // Consider only items with timestamp and ID
                    .sort((a, b) => new Date(b.orderedAt) - new Date(a.orderedAt))[0];
                currentActiveOrderId = latestOrder?.orderId || null;
                console.log("Set active Order ID to:", currentActiveOrderId);
            }
        } else if (parsedData && parsedData.table !== selectedTableNumber) {
            console.log(`Ignoring ordered items data from table ${parsedData.table}. Current table: ${selectedTableNumber}.`);
        } else {
            // No valid data found
        }
    }

    // --- Cart Logic ---
    /** Adds an item to the cart or increments quantity if it exists. */
    function addToCart(itemId, size) {
        const product = menuData.find(item => item.id === itemId);
        if (!product || typeof product.prices !== 'object') { console.error("Product not found:", itemId); return; }
        const price = product.prices[size];
        if (price === undefined || price === null || isNaN(price)) { console.error("Invalid price for", itemId, size); return; }

        // Get selected options
        const option1Input = menuOption1ChoicesEl?.querySelector('input[name="option1"]:checked');
        const selectedOption1 = option1Input ? option1Input.value : null;
        const option2Input = menuOption2ChoicesEl?.querySelector('input[name="option2"]:checked');
        const selectedOption2 = option2Input ? option2Input.value : null;

        const cartId = `${itemId}-${size}`; // Simple ID based on item and size
        const existingItemIndex = cartItems.findIndex(item => item.cartId === cartId);

        if (existingItemIndex > -1) {
            cartItems[existingItemIndex].quantity++;
            // Update options if they change for the same item/size combo (might be unlikely UX)
            cartItems[existingItemIndex].selectedOption1 = selectedOption1;
            cartItems[existingItemIndex].selectedOption2 = selectedOption2;
        } else {
            cartItems.push({
                cartId: cartId, id: product.id, name: product.name, price: price, size: size, quantity: 1,
                selectedOption1: selectedOption1, selectedOption2: selectedOption2
            });
        }
        saveCartToLocalStorage();
        renderCart();
        updateCartIconCount();
        cartIconContainer?.classList.add('updated');
        setTimeout(() => { cartIconContainer?.classList.remove('updated') }, 300);
    }
    /** Updates the quantity of an item in the cart. Removes if quantity <= 0. */
    function updateQuantity(cartId, change) {
        const itemIndex = cartItems.findIndex(item => item.cartId === cartId);
        if (itemIndex > -1) {
            cartItems[itemIndex].quantity += change;
            if (cartItems[itemIndex].quantity <= 0) { cartItems.splice(itemIndex, 1); } // Remove item
            saveCartToLocalStorage();
            renderCart();
            updateCartIconCount();
        }
    }
    /** Removes an item completely from the cart. */
    function removeFromCart(cartId) {
        const itemIndex = cartItems.findIndex(item => item.cartId === cartId);
        if (itemIndex > -1) { cartItems.splice(itemIndex, 1); saveCartToLocalStorage(); renderCart(); updateCartIconCount(); }
    }
    /** Renders the current cart items in the cart popup. */
    function renderCart() {
        if (!cartItemsList) return;
        cartItemsList.innerHTML = ''; // Clear previous items
        if (cartItems.length === 0) { cartItemsList.innerHTML = '<p class="popup-empty-message cart-empty-message">ตระกร้าของคุณว่างเปล่า</p>'; }
        else {
            const fragment = document.createDocumentFragment();
            cartItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('list-item-base', 'cart-item');
                const price = item.price || 0;
                const quantity = item.quantity || 0;
                const total = price * quantity;
                let optionsHtml = '';
                if (item.selectedOption1 || item.selectedOption2) {
                    optionsHtml += '<div class="list-item-options">';
                    if (item.selectedOption1) optionsHtml += `<span>+ ${item.selectedOption1}</span>`;
                    if (item.selectedOption2) optionsHtml += `<span>+ ${item.selectedOption2}</span>`;
                    optionsHtml += '</div>';
                }
                itemElement.innerHTML = `
                    <div class="list-item-details cart-item-details">
                        <div class="list-item-name cart-item-name">${item.name || 'N/A'} (${item.size || 'N/A'})</div>
                        ${optionsHtml}
                        <div class="list-item-info cart-item-price">${price.toLocaleString()} x ${quantity} = ${total.toLocaleString()}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="cart-quantity-btn decrease-qty" data-cartid="${item.cartId}" aria-label="ลดจำนวน">-</button>
                        <span class="cart-item-quantity">${quantity}</span>
                        <button class="cart-quantity-btn increase-qty" data-cartid="${item.cartId}" aria-label="เพิ่มจำนวน">+</button>
                        <button class="cart-remove-btn" data-cartid="${item.cartId}" title="ลบรายการนี้" aria-label="ลบรายการนี้"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                // Add event listeners for quantity/remove buttons
                itemElement.querySelector('.decrease-qty')?.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.cartid, -1));
                itemElement.querySelector('.increase-qty')?.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.cartid, 1));
                itemElement.querySelector('.cart-remove-btn')?.addEventListener('click', (e) => removeFromCart(e.currentTarget.dataset.cartid));
                fragment.appendChild(itemElement);
            });
            cartItemsList.appendChild(fragment);
        }
        // Enable/disable order button
        if (orderButton) { orderButton.disabled = !(cartItems.length > 0 && selectedTableNumber); orderButton.title = cartItems.length === 0 ? 'ตระกร้าว่างเปล่า' : (selectedTableNumber ? 'สั่งรายการอาหาร' : 'กรุณาเลือกโต๊ะก่อน'); }
    }
    /** Updates the badge count on the cart icon. */
    function updateCartIconCount() { if (!cartItemCountBadge) return; const totalQuantity = cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0); cartItemCountBadge.textContent = totalQuantity; cartItemCountBadge.classList.toggle('hidden', totalQuantity === 0); }

    // --- Ordered Items ("My Food") Logic ---
    /** Renders ordered items, grouped by Order ID, in the "My Food" popup. */
    function renderOrderedItems() {
        if (!myFoodItemsList || !myFoodCheckoutButton || !myFoodTotalDisplay) return;
        myFoodItemsList.innerHTML = ''; // Clear previous content
        let grandTotal = 0;
        let hasOrderedItems = orderedItems.length > 0;

        if (hasOrderedItems) {
            const fragment = document.createDocumentFragment();
            // Group items by Order ID
            const ordersGrouped = orderedItems.reduce((acc, item) => {
                const orderId = item.orderId || 'unknown'; // Group items without ID separately? Or filter out?
                if (!acc[orderId]) {
                    acc[orderId] = { items: [], orderedAt: item.orderedAt || new Date(0).toISOString(), status: "Loading...", notes: "" }; // Default status/notes
                }
                acc[orderId].items.push(item);
                // Keep the latest orderedAt timestamp for sorting groups
                if (item.orderedAt && new Date(item.orderedAt) > new Date(acc[orderId].orderedAt)) {
                    acc[orderId].orderedAt = item.orderedAt;
                }
                return acc;
            }, {});

            // Sort groups by timestamp descending (newest order first)
            Object.keys(ordersGrouped).sort((a, b) => {
                if (a === 'unknown') return 1; // Push unknown group to end
                if (b === 'unknown') return -1;
                const dateA = new Date(ordersGrouped[a].orderedAt);
                const dateB = new Date(ordersGrouped[b].orderedAt);
                if (isNaN(dateA.getTime())) return 1; // Handle invalid dates
                if (isNaN(dateB.getTime())) return -1;
                return dateB - dateA;
            }).forEach(orderId => {
                const orderGroup = ordersGrouped[orderId];
                // Create group header
                if (orderId !== 'unknown') {
                     const groupHeader = document.createElement('div');
                     groupHeader.classList.add('order-group-header');
                     // Use data-orderid on child spans for easier selection in checkAndUpdateOrderStatus
                     groupHeader.innerHTML = `
                         <div>
                             <span class="order-id-display">Order ID: ${orderId}</span>
                             <span class="ordered-item-status" data-orderid="${orderId}" data-type="status">(สถานะ: กำลังโหลด...)</span>
                         </div>
                         <div class="ordered-item-cashier-notes" data-orderid="${orderId}" data-type="notes"></div>
                     `;
                     fragment.appendChild(groupHeader);
                 }

                // Add items within the group
                orderGroup.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('list-item-base', 'ordered-item');
                    // itemElement.dataset.orderid = item.orderId; // Already grouped, maybe not needed on item

                    const price = item.price || 0;
                    const quantity = item.quantity || 0;
                    const total = price * quantity;
                    grandTotal += total; // Add to grand total

                    let optionsHtml = '';
                    if (item.selectedOption1 || item.selectedOption2) {
                        optionsHtml += '<div class="list-item-options">';
                        if (item.selectedOption1) optionsHtml += `<span>+ ${item.selectedOption1}</span>`;
                        if (item.selectedOption2) optionsHtml += `<span>+ ${item.selectedOption2}</span>`;
                        optionsHtml += '</div>';
                    }

                    itemElement.innerHTML = `
                        <div class="list-item-details ordered-item-details">
                            <div class="list-item-name ordered-item-name">${item.name || 'N/A'} (${item.size || 'N/A'})</div>
                            ${optionsHtml}
                            <div class="list-item-info ordered-item-info">จำนวน: ${quantity} (${price.toLocaleString()}/ชิ้น)</div>
                        </div>
                        <div class="list-item-total ordered-item-total">${total.toLocaleString()}</div>`;
                    fragment.appendChild(itemElement);
                });
            });

            myFoodItemsList.appendChild(fragment);
            myFoodTotalDisplay.textContent = `ยอดรวมที่สั่งแล้ว: ${grandTotal.toLocaleString()}`;
        } else {
            myFoodItemsList.innerHTML = '<p class="popup-empty-message my-food-empty-message">ยังไม่มีรายการอาหารที่สั่ง</p>';
            myFoodTotalDisplay.textContent = '';
        }

        myFoodCheckoutButton.disabled = !(hasOrderedItems && selectedTableNumber);
        myFoodCheckoutButton.title = hasOrderedItems ? (selectedTableNumber ? 'สรุปยอดและเรียกชำระเงิน' : 'กรุณาเลือกโต๊ะก่อน') : 'ไม่มีรายการที่สั่ง';
        myFoodTotalDisplay.style.display = hasOrderedItems ? 'block' : 'none';
    }
    /** Updates the badge count on the "My Food" icon. */
    function updateMyFoodIconCount() { if (!myFoodItemCountBadge) return; const totalQuantity = orderedItems.reduce((sum, item) => sum + (item.quantity || 0), 0); myFoodItemCountBadge.textContent = totalQuantity; myFoodItemCountBadge.classList.toggle('hidden', totalQuantity === 0); if (totalQuantity > 0 && myFoodIconContainer) { myFoodIconContainer.classList.add('updated'); setTimeout(() => { myFoodIconContainer?.classList.remove('updated') }, 300); } }

    // --- Menu Item Display and Interaction ---
    /** Shows details (image, name, price, options) for a specific menu item. */
    function showItemDetails(index, swipeDirection = "none") {
        if (!menuDetailsContainer || !mainFoodImage || !menuNameElement || !menuDescriptionElement || !menuPriceContainer || !imageContainer || !menuOptionsSection || !menuOption1Container || !menuOption1TitleEl || !menuOption1ChoicesEl || !menuOption2Container || !menuOption2TitleEl || !menuOption2ChoicesEl) { console.error("One or more required elements for item details/options are missing."); return; }
        if (index < 0 || index >= currentFilteredItems.length) { menuDetailsContainer.style.display = 'none'; currentDisplayedItemId = null; currentIndex = -1; return; }

        currentIndex = index;
        const item = currentFilteredItems[currentIndex];
        currentDisplayedItemId = item.id;

        // --- Image Handling with Animation ---
        const newImageSrc = item.dataImageSrc || item.src || 'placeholder.jpg'; // Use dataImageSrc if available
        const currentImageSrc = mainFoodImage.getAttribute('src');
        const setImage = (src, alt) => { mainFoodImage.setAttribute('src', src); mainFoodImage.alt = alt || item.name || 'Menu item image'; mainFoodImage.onerror = () => { console.warn(`Image failed to load: ${src}. Using placeholder.`); mainFoodImage.src = 'placeholder.jpg'; mainFoodImage.alt = `${item.name || 'Menu item'} (Image unavailable)`; mainFoodImage.onerror = null; }; };

        imageContainer.classList.remove('slide-out-left', 'slide-in-right', 'slide-out-right', 'slide-in-left'); // Clear old animations
        if (swipeDirection === "none" || currentImageSrc === newImageSrc || currentImageSrc === 'placeholder.jpg') {
            setImage(newImageSrc, item.alt);
        } else {
            let animationOut = '', animationIn = '';
            if (swipeDirection === "next") { animationOut = 'slide-out-left'; animationIn = 'slide-in-right'; }
            else if (swipeDirection === "prev") { animationOut = 'slide-out-right'; animationIn = 'slide-in-left'; }

            // Use rAF for smoother animations
            requestAnimationFrame(() => {
                imageContainer.classList.add(animationOut);
                const handleAnimationEndOut = () => {
                    imageContainer.removeEventListener('animationend', handleAnimationEndOut);
                    imageContainer.classList.remove(animationOut);
                    setImage(newImageSrc, item.alt);
                    requestAnimationFrame(() => { // Start next animation in next frame
                        imageContainer.classList.add(animationIn);
                        const handleAnimationEndIn = () => {
                            imageContainer.removeEventListener('animationend', handleAnimationEndIn);
                            imageContainer.classList.remove(animationIn);
                        };
                        imageContainer.addEventListener('animationend', handleAnimationEndIn, { once: true });
                    });
                };
                imageContainer.addEventListener('animationend', handleAnimationEndOut, { once: true });
            });
        }

        // --- Text and Price Details ---
        menuNameElement.textContent = item.name || 'ชื่อเมนู';
        menuDescriptionElement.textContent = item.description || 'ไม่มีคำอธิบาย';

        const prices = item.prices || {};
        const priceSizes = ['Small', 'Normal', 'Extra', 'Family'];

        // Hide all price elements initially
        priceSizes.forEach(size => {
            const elements = priceElementsCache[size];
            if (elements) {
                elements.label?.closest('.price-item')?.classList.add('hidden');
                if (elements.separator) elements.separator.classList.add('hidden');
            }
        });

        // Show available prices
        let visiblePriceCount = 0;
        priceSizes.forEach(size => {
            const elements = priceElementsCache[size];
            if (elements?.label && elements.value && elements.button) {
                const priceValue = prices[size];
                const priceItemElement = elements.label.closest('.price-item');
                if (priceItemElement && priceValue !== undefined && priceValue !== null && !isNaN(priceValue)) {
                    elements.value.textContent = `${Number(priceValue).toLocaleString()}`;
                    priceItemElement.classList.remove('hidden');
                    visiblePriceCount++;
                }
            }
        });

        // Show separators between visible price items
        let previousVisible = false;
        priceSizes.forEach(size => {
            const elements = priceElementsCache[size];
            const priceItemElement = elements?.label?.closest('.price-item');
            if (priceItemElement && !priceItemElement.classList.contains('hidden')) {
                if (previousVisible) {
                    // Determine which separator to show based on the *previous* visible item
                    if (size === 'Normal' && priceElementsCache.Small?.separator && !priceElementsCache.Small.label?.closest('.price-item')?.classList.contains('hidden')) {
                         priceElementsCache.Small.separator.classList.remove('hidden');
                    } else if (size === 'Extra' && priceElementsCache.Extra?.separator && !priceElementsCache.Normal.label?.closest('.price-item')?.classList.contains('hidden')) {
                         priceElementsCache.Extra.separator.classList.remove('hidden');
                    } else if (size === 'Family' && priceElementsCache.Family?.separator && !priceElementsCache.Extra.label?.closest('.price-item')?.classList.contains('hidden')) {
                         priceElementsCache.Family.separator.classList.remove('hidden');
                    }
                }
                previousVisible = true;
            }
        });


        // --- Options Handling ---
        const createOptionChoice = (optionGroupName, value, label, index) => {
            const uniqueId = `${optionGroupName}-${value.replace(/\s+/g, '-')}-${index}`; // Create unique ID
            const labelEl = document.createElement('label');
            labelEl.classList.add('option-choice-label');
            labelEl.setAttribute('for', uniqueId);

            const inputEl = document.createElement('input');
            inputEl.type = 'radio';
            inputEl.name = optionGroupName;
            inputEl.value = value;
            inputEl.id = uniqueId;

            const spanEl = document.createElement('span');
            spanEl.textContent = label;

            labelEl.appendChild(inputEl);
            labelEl.appendChild(spanEl);
            return labelEl;
        };

        let hasOptions = false;
        // Option 1
        if (menuOption1Container && menuOption1TitleEl && menuOption1ChoicesEl && item.option1_title && item.option1_choices && item.option1_choices.length > 0) {
            menuOption1TitleEl.textContent = item.option1_title;
            menuOption1ChoicesEl.innerHTML = ''; // Clear previous
            const frag1 = document.createDocumentFragment();
            item.option1_choices.forEach((choice, idx) => {
                frag1.appendChild(createOptionChoice('option1', choice, choice, idx)); // Use choice as both value and label
            });
            menuOption1ChoicesEl.appendChild(frag1);
            menuOption1Container.classList.remove('hidden');
            hasOptions = true;
        } else if (menuOption1Container) {
            menuOption1Container.classList.add('hidden');
            if(menuOption1ChoicesEl) menuOption1ChoicesEl.innerHTML = '';
        }

        // Option 2
        if (menuOption2Container && menuOption2TitleEl && menuOption2ChoicesEl && item.option2_title && item.option2_choices && item.option2_choices.length > 0) {
            menuOption2TitleEl.textContent = item.option2_title;
            menuOption2ChoicesEl.innerHTML = ''; // Clear previous
            const frag2 = document.createDocumentFragment();
            item.option2_choices.forEach((choice, idx) => {
                frag2.appendChild(createOptionChoice('option2', choice, choice, idx));
            });
            menuOption2ChoicesEl.appendChild(frag2);
            menuOption2Container.classList.remove('hidden');
            hasOptions = true;
        } else if (menuOption2Container) {
            menuOption2Container.classList.add('hidden');
            if(menuOption2ChoicesEl) menuOption2ChoicesEl.innerHTML = '';
        }

        // Show/hide the whole options section
        if (menuOptionsSection) menuOptionsSection.style.display = hasOptions ? 'block' : 'none';

        // Make details visible
        menuDetailsContainer.style.display = 'block';
    }
    /** Displays menu items filtered by the selected category in the bottom grid. */
    function displayMenuItems(category) {
        if (!bottomMenu) { console.error("Bottom menu element not found."); return; }
        bottomMenu.innerHTML = ''; // Clear previous items
        currentCategory = category;

        if (!menuData || menuData.length === 0) { console.warn("menuData is empty, cannot display items."); bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีข้อมูลเมนู</p>'; if (menuDetailsContainer) menuDetailsContainer.style.display = 'none'; currentFilteredItems = []; currentDisplayedItemId = null; currentIndex = -1; return; }

        // Filter items by category
        currentFilteredItems = menuData.filter(item => Array.isArray(item.category) && item.category.includes(category));

        if (currentFilteredItems.length === 0) { bottomMenu.innerHTML = `<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูในหมวดหมู่ "${category}"</p>`; if (menuDetailsContainer) menuDetailsContainer.style.display = 'none'; currentDisplayedItemId = null; currentIndex = -1; return; }

        const fragment = document.createDocumentFragment();
        currentFilteredItems.forEach((item, index) => {
            const menuItemDiv = document.createElement('div');
            menuItemDiv.classList.add('menu-item');
            menuItemDiv.dataset.itemId = item.id;
            menuItemDiv.dataset.index = index; // Store index within filtered list

            const img = document.createElement('img');
            img.src = item.src || 'placeholder.jpg';
            img.alt = item.alt || item.name || 'Menu item';
            img.loading = 'lazy'; // Lazy load images
            img.onerror = function() { // Fallback image
                this.onerror = null; // Prevent infinite loop
                this.src = 'placeholder.jpg';
                this.alt = `${item.name || 'Menu item'} (Image unavailable)`;
            };
            menuItemDiv.appendChild(img);

            // Event listener to show details and scroll to top
            menuItemDiv.addEventListener('click', () => {
                const itemIndex = parseInt(menuItemDiv.dataset.index, 10);
                if (isNaN(itemIndex) || itemIndex < 0 || itemIndex >= currentFilteredItems.length) { console.error("Invalid index on menu item click:", menuItemDiv.dataset.index); return; }
                showItemDetails(itemIndex);
                // Scroll window to top smoothly
                requestAnimationFrame(() => { // Ensure layout is stable before scrolling
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
            fragment.appendChild(menuItemDiv);
        });
        bottomMenu.appendChild(fragment);

        // Show details of the first item in the filtered list
        if (currentFilteredItems.length > 0) { showItemDetails(0); }
        else { if (menuDetailsContainer) menuDetailsContainer.style.display = 'none'; currentDisplayedItemId = null; currentIndex = -1; }
    }
    /** Shows the previous item in the current filtered list. */
    function showPreviousItem() { if (currentFilteredItems.length <= 1 || currentIndex < 0) return; let prevIndex = (currentIndex - 1 + currentFilteredItems.length) % currentFilteredItems.length; showItemDetails(prevIndex, "prev"); }
    /** Shows the next item in the current filtered list. */
    function showNextItem() { if (currentFilteredItems.length <= 1 || currentIndex < 0) return; let nextIndex = (currentIndex + 1) % currentFilteredItems.length; showItemDetails(nextIndex, "next"); }
    /** Populates the category bar with fetched categories. */
    function populateCategoryBar() {
        const categoryBar = document.querySelector('.category-bar');
        if (!categoryBar) { console.error("Category bar element not found."); return; }
        if (!allCategories || allCategories.length === 0) { console.warn("No categories fetched or available."); categoryBar.innerHTML = '<p style="color: var(--color-text-secondary); padding: 10px; white-space: normal;">ไม่มีหมวดหมู่ให้แสดง</p>'; return; }

        categoryBar.innerHTML = ''; // Clear previous
        const categoryIcons = { // Map category names to Font Awesome icons
            "จานหลัก": "fas fa-utensils",
            "เฮลท์ตี้ โบวล์": "fas fa-seedling",
            "ทานเล่น": "fas fa-cookie-bite",
            "สลัด": "fas fa-leaf",
            "ทะเล": "fas fa-fish",
            "ของหวาน": "fas fa-ice-cream",
            "เครื่องดื่ม": "fas fa-coffee",
            "ซุป": "fas fa-mug-hot",
            "default": "fas fa-tag" // Default icon
        };
        const fragment = document.createDocumentFragment();
        allCategories.forEach(categoryName => {
            const categoryDiv = document.createElement('div');
            categoryDiv.classList.add('category-item');
            categoryDiv.dataset.category = categoryName;
            const iconClass = categoryIcons[categoryName] || categoryIcons.default;
            categoryDiv.innerHTML = `
                <i class="${iconClass}"></i>
                <span>${categoryName}</span>
            `;
            categoryDiv.addEventListener('click', handleCategoryClick);
            fragment.appendChild(categoryDiv);
        });
        categoryBar.appendChild(fragment);
    }
    /** Handles clicking on a category item. */
    function handleCategoryClick(event) {
        const clickedItem = event.currentTarget;
        const categoryName = clickedItem.dataset.category;
        // Update selection state
        document.querySelectorAll('.category-bar .category-item').forEach(item => item.classList.remove('selected'));
        clickedItem.classList.add('selected');
        // Display items for the category
        displayMenuItems(categoryName);
        // Scroll the clicked category into view
        clickedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    // --- Order Submission and Status Check ---
    /** Sends the current cart contents as a new order to the Google Apps Script. */
    async function handleOrderSubmission() {
        if (cartItems.length === 0) { alert('ตระกร้าสินค้าของคุณว่างเปล่า'); return; }
        if (!selectedTableNumber) { alert('กรุณาเลือกโต๊ะก่อนสั่งอาหาร'); openTableSelectModal(); return; }

        const originalButtonContent = orderButton.innerHTML;
        orderButton.disabled = true;
        orderButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังสั่ง...`;

        const orderData = {
            tableNumber: selectedTableNumber,
            items: cartItems.map(item => ({ // Map to ensure consistent structure sent
                 id: item.id, name: item.name, size: item.size, price: item.price, quantity: item.quantity,
                 selectedOption1: item.selectedOption1 || null, // Ensure null if not selected
                 selectedOption2: item.selectedOption2 || null
             }))
        };
        const urlWithToken = `${GOOGLE_APPS_SCRIPT_URL}?token=${API_ACCESS_TOKEN}`;

        try {
            console.log("Sending order to GAS:", JSON.stringify(orderData));
            const response = await fetch(urlWithToken, {
                method: 'POST',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (!response.ok) { let errorBody = "Unknown error"; try { errorBody = await response.text(); } catch(_) {} throw new Error(`Network response was not ok (${response.status}). Server said: ${errorBody}`); }

            const result = await response.json();
            console.log("GAS Response:", result);

            if (result.success && result.orderId) {
                alert(`ส่งรายการสั่งซื้อจาก ${TABLE_NUMBER_PREFIX}${selectedTableNumber} สำเร็จ! (Order ID: ${result.orderId})`);
                currentActiveOrderId = result.orderId; // Store the new order ID for this session
                const orderedTimestamp = new Date().toISOString(); // Timestamp for local sorting/display

                // Move items from cart to ordered list, ADDING the orderId and timestamp
                cartItems.forEach(cartItem => {
                     orderedItems.push({ ...cartItem, orderId: result.orderId, orderedAt: orderedTimestamp });
                });
                cartItems = []; // Clear the cart

                saveCartToLocalStorage(); // Save empty cart
                saveOrderedItemsToLocalStorage(); // Save new ordered items list
                renderCart(); updateCartIconCount();
                renderOrderedItems(); updateMyFoodIconCount(); // Update "My Food" list and badge
                if (cartPopup) cartPopup.classList.remove('open'); // Close cart popup

            } else { throw new Error(result.message || "Order submission failed. Check GAS logs."); }

        } catch (error) {
            console.error('Error submitting order to GAS:', error);
            alert(`🚨 เกิดข้อผิดพลาดในการส่งรายการสั่งซื้อ: ${error.message}\nกรุณาลองใหม่อีกครั้ง หรือแจ้งพนักงาน`);
        } finally { orderButton.disabled = false; orderButton.innerHTML = originalButtonContent; }
    }
    /** Checks the status of the current active order and displays updates. */
    async function checkAndUpdateOrderStatus(orderIdToCheck = null) {
        const targetOrderId = orderIdToCheck || currentActiveOrderId; // Use specific ID if provided (for receipt), else use active one

        // Refresh active order ID if not set (in case page was reloaded)
        if (!currentActiveOrderId && orderedItems.length > 0) {
            const latestOrder = [...orderedItems].filter(item => item.orderedAt && item.orderId).sort((a, b) => new Date(b.orderedAt) - new Date(a.orderedAt))[0];
            if (latestOrder) currentActiveOrderId = latestOrder.orderId;
        }
         // Use the potentially refreshed active ID if no specific one was passed
        if (!targetOrderId && currentActiveOrderId) {
             orderIdToCheck = currentActiveOrderId;
        }


        if (!targetOrderId) { console.log("No order ID found to check status."); return; }

        const url = `${GOOGLE_APPS_SCRIPT_URL}?token=${API_ACCESS_TOKEN}&action=checkOrderStatus&orderId=${targetOrderId}`;

        try {
            console.log(`Checking status for Order ID: ${targetOrderId}`);
            const response = await fetch(url);
            if (!response.ok) { let errorBody = "Status check failed"; try {errorBody = await response.text();} catch(_) {} throw new Error(`Network response was not ok (${response.status}). Server said: ${errorBody}`); }
            const result = await response.json();
            console.log("Status Check Response:", result);

            if (result.success && result.data) {
                const statusData = result.data;

                // Show Cashier Message if present (only if it's for the *currently active* order)
                if (statusData.updateMessage && targetOrderId === currentActiveOrderId) {
                    alert(`ข้อความจากแคชเชียร์ (ID: ${targetOrderId}):\n"${statusData.updateMessage}"`);
                    // Ideally, clear the message flag on GAS side after fetching, which the GAS script should do.
                }

                // Update the displayed status in the "My Food" list group header
                const statusSpan = myFoodItemsList?.querySelector(`.ordered-item-status[data-orderid="${targetOrderId}"]`);
                if (statusSpan) { statusSpan.textContent = `(สถานะ: ${statusData.status || 'N/A'})`; }
                // Update the cashier notes display in the "My Food" list group header
                const notesDiv = myFoodItemsList?.querySelector(`.ordered-item-cashier-notes[data-orderid="${targetOrderId}"]`);
                if (notesDiv) {
                     notesDiv.textContent = statusData.cashierNotes ? `โน้ตแคชเชียร์: ${statusData.cashierNotes}` : '';
                     notesDiv.style.display = statusData.cashierNotes ? 'block' : 'none';
                 }

                // Update status on the receipt modal if it's open and showing this order
                if (receiptModal?.classList.contains('open') && receiptOrderIdEl?.textContent?.includes(targetOrderId)) {
                    if (receiptCurrentStatusEl) receiptCurrentStatusEl.textContent = `สถานะปัจจุบัน: ${statusData.status || 'N/A'}`;
                    if (receiptCashierNotesEl) {
                         receiptCashierNotesEl.textContent = statusData.cashierNotes ? `ข้อความจากแคชเชียร์: ${statusData.cashierNotes}` : '';
                         receiptCashierNotesEl.style.display = statusData.cashierNotes ? 'block' : 'none';
                     }
                     // Show the status/notes area
                     if (receiptStatusNotesArea) receiptStatusNotesArea.style.display = 'block';
                 }

            } else { console.warn(`Failed to get status or no data for order ${targetOrderId}:`, result.message); }

        } catch (error) { console.error(`Error checking order status for ${targetOrderId}:`, error); }
    }

    // --- Receipt Generation ---
    /** Generates and displays the receipt modal for the currently active order. */
    function handleGenerateReceipt() {
        // Use currentActiveOrderId to filter items for the receipt
        const orderIdForReceipt = currentActiveOrderId;

        if (!orderIdForReceipt) { alert("ไม่พบ Order ID ล่าสุดสำหรับสร้างใบสรุปยอด"); return false; }
        const itemsForThisReceipt = orderedItems.filter(item => item.orderId === orderIdForReceipt);
        if (itemsForThisReceipt.length === 0) { alert("ไม่พบรายการอาหารสำหรับ Order ID นี้"); return false; }
        if (!selectedTableNumber) { alert('⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ'); openTableSelectModal(); return false; }
        if (!receiptModal || !receiptContent || !receiptItemsList || !receiptGrandTotal || !receiptQrImage || !receiptRestaurantName || !receiptTableInfo || !receiptDateTime || !receiptOrderIdEl || !receiptStatusNotesArea || !receiptCurrentStatusEl || !receiptCashierNotesEl) { console.error("Receipt modal elements not found."); alert("เกิดข้อผิดพลาดในการแสดงใบสรุปยอด"); return false; }

        // --- Populate Receipt Header ---
        receiptRestaurantName.textContent = RESTAURANT_NAME;
        receiptTableInfo.textContent = `${TABLE_NUMBER_PREFIX}${selectedTableNumber}`;
        const { date, time } = getCurrentLocalDateTimeStrings();
        receiptDateTime.textContent = `วันที่: ${date} เวลา: ${time}`;
        receiptOrderIdEl.textContent = `Order ID: ${orderIdForReceipt}`; // Display Order ID

        // --- Populate Receipt Items ---
        receiptItemsList.innerHTML = ''; // Clear previous items
        let grandTotal = 0;
        const fragment = document.createDocumentFragment();
        itemsForThisReceipt.forEach((item) => {
            const itemElement = document.createElement('div');
            itemElement.classList.add('receipt-item');
            const price = item.price || 0;
            const quantity = item.quantity || 0;
            const total = price * quantity;
            grandTotal += total;
            let optionsHtml = '';
             if (item.selectedOption1 || item.selectedOption2) {
                 optionsHtml += '<div class="receipt-item-options">';
                 if (item.selectedOption1) optionsHtml += `<span>+ ${item.selectedOption1}</span>`;
                 if (item.selectedOption2) optionsHtml += `<span>+ ${item.selectedOption2}</span>`;
                 optionsHtml += '</div>';
             }
            itemElement.innerHTML = `
                <span class="receipt-item-name">${item.name || 'N/A'} (${item.size || 'N/A'})</span>
                <span class="receipt-item-qty">${quantity}x</span>
                <span class="receipt-item-price">${price.toLocaleString()}</span>
                <span class="receipt-item-total">${total.toLocaleString()}</span>
                ${optionsHtml}
            `;
            fragment.appendChild(itemElement);
        });
        receiptItemsList.appendChild(fragment);

        // --- Populate Receipt Total ---
        receiptGrandTotal.innerHTML = `
            ยอดรวมสุทธิ: ${grandTotal.toLocaleString()}
            <span class="total-label-eng">(Total)</span>
        `;

        // --- QR Code ---
        receiptQrImage.src = QR_CODE_IMAGE_URL;
        receiptQrImage.alt = 'QR Code สำหรับชำระเงิน';
        receiptQrImage.onerror = () => { receiptQrImage.onerror = null; console.error("Failed to load QR code image from:", QR_CODE_IMAGE_URL); receiptQrImage.alt = 'QR Code ไม่สามารถแสดงได้'; };

        // --- Fetch and Display Status/Notes ---
        receiptStatusNotesArea.style.display = 'none'; // Hide initially
        receiptCurrentStatusEl.textContent = 'สถานะปัจจุบัน: กำลังโหลด...';
        receiptCashierNotesEl.textContent = '';
        receiptCashierNotesEl.style.display = 'none';
        checkAndUpdateOrderStatus(orderIdForReceipt); // Fetch status specifically for this order ID

        // --- Show Modal ---
        receiptModal.classList.add('open');
        if (receiptContent) receiptContent.scrollTop = 0; // Scroll to top
        console.log("Receipt generated for Order ID:", orderIdForReceipt);
        return true; // Indicate success
    }
    /** Generates a canvas of the receipt content. */
     async function generateReceiptCanvas() {
         if (!receiptContent || typeof html2canvas === 'undefined') {
             console.error("html2canvas library not found or receiptContent element missing.");
             return null;
         }
         // Temporarily adjust styles for full capture
         const originalScrollTop = receiptContent.scrollTop;
         const originalStyles = {
             maxHeight: receiptContent.style.maxHeight,
             overflowY: receiptContent.style.overflowY,
         };
         receiptContent.style.maxHeight = 'none';
         receiptContent.style.overflowY = 'visible';
         await new Promise(resolve => requestAnimationFrame(resolve)); // Wait for styles to apply
         await new Promise(resolve => setTimeout(resolve, 50)); // Extra safety wait

         const options = {
             useCORS: true,
             scale: window.devicePixelRatio * 1.5, // Increase scale for better quality
             backgroundColor: '#ffffff',
             logging: false,
             scrollY: -originalScrollTop, // Capture from the top
             height: receiptContent.scrollHeight, // Capture full height
             width: receiptContent.scrollWidth, // Capture full width
         };

         try {
             console.log("Generating receipt canvas...");
             const canvas = await html2canvas(receiptContent, options);
             console.log("Canvas generated successfully.");
             return canvas;
         } catch (error) {
             console.error("Error generating receipt canvas with html2canvas:", error);
             return null;
         } finally {
             // Restore original styles
             receiptContent.style.maxHeight = originalStyles.maxHeight;
             receiptContent.style.overflowY = originalStyles.overflowY;
             receiptContent.scrollTop = originalScrollTop;
             console.log("Restored receipt content styles.");
         }
     }
    /** Saves the generated receipt canvas as a PNG image. */
    async function saveReceiptAsImage() {
        const button = document.getElementById('save-receipt-btn');
        const originalHtml = button ? button.innerHTML : '';
        if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังสร้าง...'; }

        const canvas = await generateReceiptCanvas(); // Generate the canvas first

        if (!canvas) {
            alert("เกิดข้อผิดพลาด: ไม่สามารถสร้างรูปภาพใบเสร็จได้");
            if(button){ button.disabled = false; button.innerHTML = originalHtml; }
            return;
        }

        try {
            const link = document.createElement('a');
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            link.download = `ใบสรุปยอด_${TABLE_NUMBER_PREFIX.trim()}${selectedTableNumber}_${timestamp}.png`;
            link.href = canvas.toDataURL('image/png'); // Use generated canvas
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            console.log("Receipt image download initiated.");
        } catch (error) {
            console.error('Error creating download link:', error);
            alert("เกิดข้อผิดพลาดในการเตรียมไฟล์สำหรับบันทึก");
        } finally {
             if(button){ button.disabled = false; button.innerHTML = originalHtml; }
        }
    }

    // --- Telegram Integration ---
    /** Decodes the obfuscated Telegram token. */
    function getTelegramToken() { try { return atob(tPart1) + atob(tPart2) + atob(tPart3) + atob(tPart4); } catch (e) { console.error("Error decoding Telegram token:", e); return null; } }
    /** Sends a text message to the configured Telegram chat, with loading state and fallback. */
    async function sendTelegramMessage(message, buttonElement = null, loadingText = "กำลังส่ง...") {
        // Check table number *unless* it's the checkout button (which implies orderedItems exist)
        if (!selectedTableNumber && buttonElement !== myFoodCheckoutButton) { alert("⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ"); openTableSelectModal(); return false; }
        // For checkout, table number must have been set when items were ordered
        if (!selectedTableNumber && buttonElement === myFoodCheckoutButton) { return false; } // Should not happen if button is enabled correctly

        const token = getTelegramToken();
        if (!token) { alert("🚨 ข้อผิดพลาด: Token ไม่ถูกต้อง"); return false; }

        let originalButtonHtml = '';
        let wasButtonDisabled = false;
        if (buttonElement) {
            if (buttonElement.classList.contains('loading')) { console.log("Action already in progress for this button (sendTelegramMessage)."); return false; } // Prevent double clicks
            originalButtonHtml = buttonElement.innerHTML;
            wasButtonDisabled = buttonElement.disabled;
            buttonElement.disabled = true;
            buttonElement.classList.add('loading');
            buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
        }

        const apiUrl = `https://api.telegram.org/bot${token}/sendMessage`;
        const payload = { chat_id: CHAT_ID, text: message, parse_mode: 'Markdown' };

        try {
            console.log("Sending Telegram message (Markdown):", payload);
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            console.log("Telegram response:", result);
            if (!result.ok) {
                console.warn(`Markdown failed (${result.description}), attempting plain text.`);
                const plainPayload = { chat_id: CHAT_ID, text: message }; // No parse_mode
                const plainResponse = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(plainPayload) });
                const plainResult = await plainResponse.json();
                console.log("Plain text Telegram response:", plainResult);
                if (!plainResult.ok) {
                    throw new Error(plainResult.description || result.description || 'Unknown Telegram API error');
                }
            }
            return true; // Success
        } catch (error) {
            console.error('Error sending Telegram message:', error);
            // Only show alert if it wasn't the background checkout button
            if (buttonElement !== myFoodCheckoutButton) {
                 alert(`🚨 เกิดข้อผิดพลาดในการสื่อสาร (${selectedTableNumber ? TABLE_NUMBER_PREFIX + selectedTableNumber : 'โต๊ะที่ไม่ได้เลือก'}): ${error.message}.\nกรุณาลองใหม่อีกครั้ง หรือแจ้งพนักงาน`);
            }
            return false; // Failure
        } finally {
            if (buttonElement) {
                buttonElement.disabled = wasButtonDisabled; // Restore original disabled state if needed
                buttonElement.classList.remove('loading');
                buttonElement.innerHTML = originalButtonHtml;
            }
        }
    }
    /** Sends a canvas as a photo to Telegram. */
    async function sendTelegramPhoto(canvas, caption = "") {
        if (!canvas) { console.error("sendTelegramPhoto: No canvas provided."); return false; }
        const token = getTelegramToken();
        if (!token) { console.error("Telegram token invalid for photo."); return false; }
        if (!selectedTableNumber) { console.error("Cannot send photo without table number."); return false; } // Need table context

        const apiUrl = `https://api.telegram.org/bot${token}/sendPhoto`;

        try {
            console.log("Converting canvas to Blob...");
            const blob = await new Promise((resolve, reject) => {
                canvas.toBlob(blob => {
                    if (blob) { console.log("Blob conversion successful."); resolve(blob); }
                    else { console.error("Canvas to Blob conversion failed."); reject(new Error("Canvas to Blob conversion failed")); }
                }, 'image/png', 0.90); // Use PNG format, slight compression
            });
            console.log("Blob size:", blob.size);

            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            const timestamp = Date.now();
            const filename = `receipt_table_${selectedTableNumber}_${timestamp}.png`;
            formData.append('photo', blob, filename);
            if (caption) {
                formData.append('caption', caption);
                formData.append('parse_mode', 'Markdown'); // Assume caption might have Markdown
            }

            console.log(`Sending Telegram photo for table ${selectedTableNumber}...`);
            const response = await fetch(apiUrl, { method: 'POST', body: formData }); // Don't set Content-Type header for FormData
            const result = await response.json();
            console.log("Telegram photo response:", result);
            if (!result.ok) { throw new Error(`[${result.error_code}] ${result.description}` || 'Unknown Telegram API error sending photo'); }

            console.log("Telegram photo sent successfully.");
            return true;
        } catch (error) {
            console.error('Error sending Telegram photo:', error);
            return false;
        }
    }
    /** Sends a formatted text summary of the current ordered items to Telegram. */
    async function sendCheckoutTextSummaryToTelegram() {
        // Use currentActiveOrderId to potentially filter for a specific order, or send all if null
        const itemsToSend = currentActiveOrderId
             ? orderedItems.filter(item => item.orderId === currentActiveOrderId)
             : orderedItems; // Send all if no specific active ID

        if (itemsToSend.length === 0 || !selectedTableNumber) {
             console.warn("sendCheckoutTextSummaryToTelegram called unexpectedly.");
             return false;
        }

        let message = `💰 *!! เรียกชำระเงิน !!* 💰\n`;
        message += `------------------------------------\n`;
        message += `โต๊ะ: *${selectedTableNumber}*\n`;
        if (currentActiveOrderId) { message += `Order ID: \`${currentActiveOrderId}\`\n`; } // Add Order ID if available
        message += `------------------------------------\n`;
        let grandTotal = 0;
        itemsToSend.forEach((item, index) => {
            const price = item.price || 0;
            const quantity = item.quantity || 0;
            const total = price * quantity;
            let itemNameLine = `*${index + 1}. ${item.name || 'N/A'}* (${item.size || 'N/A'})`;
             // Add options if they exist
            if (item.selectedOption1 || item.selectedOption2) {
                 itemNameLine += "\n"; // New line for options
                 if (item.selectedOption1) itemNameLine += `   + ${item.selectedOption1}\n`;
                 if (item.selectedOption2) itemNameLine += `   + ${item.selectedOption2}\n`;
                 itemNameLine += "   "; // Indent quantity line
            } else {
                 itemNameLine += "\n   "; // Indent quantity line
             }
            itemNameLine += `(จำนวน: ${quantity} x ${price.toLocaleString()} = *${total.toLocaleString()}*)\n`; // Add qty/price line
             message += itemNameLine;
            grandTotal += total;
        });
        message += `------------------------------------\n`;
        message += `*ยอดรวมที่สั่งแล้ว: ${grandTotal.toLocaleString()}*\n`;
        const { time } = getCurrentLocalDateTimeStrings();
        message += `_(เวลาเรียกชำระเงิน: ${time})_`;

        console.log("Sending checkout text summary...");
        // Send without associating with a button's loading state (background task)
        const success = await sendTelegramMessage(message, null, "");
        if (success) { console.log("Checkout text summary sent successfully."); }
        else { console.error("Failed to send checkout text summary."); }
        return success;
    }
    /** Sends a "Call Staff" message to Telegram. */
    async function handleCallStaff() {
        if (!selectedTableNumber) { alert("⚠️ กรุณาเลือกหมายเลขโต๊ะก่อนค่ะ"); openTableSelectModal(); return; }
        let message = `🚨 *!! เรียกพนักงาน !!* 🚨\n`;
        message += `------------------------------------\n`;
        message += `โต๊ะ: *${selectedTableNumber}* ต้องการความช่วยเหลือ\n`;
        message += `------------------------------------\n`;
        const { time } = getCurrentLocalDateTimeStrings();
        message += `_(เวลา: ${time})_`;

        if (await sendTelegramMessage(message, callStaffIconContainer, "")) {
             alert("✅ เรียกพนักงานบริการให้เรียบร้อยค่ะ กรุณารอสักครู่ 💁‍♀️");
        }
    }

    // --- Event Listener Setup ---
    function setupEventListeners() {
        console.log("Setting up event listeners...");

        // Table Selection
        tableNumberDisplay?.addEventListener('click', openTableSelectModal);
        tableSelectCloseBtn?.addEventListener('click', closeTableSelectModal);
        tableSelectModal?.addEventListener('click', (e) => { if (e.target === tableSelectModal) closeTableSelectModal(); }); // Close on backdrop click
        tablePromptNotification?.addEventListener('click', hideTablePromptNotification);
        tablePromptNotification?.addEventListener('touchstart', hideTablePromptNotification, { passive: true });

        // Add to Cart from Details Section
        menuPriceContainer?.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('add-to-cart-button')) {
                const size = e.target.dataset.size;
                if (currentDisplayedItemId && size) { addToCart(currentDisplayedItemId, size); }
                else { console.warn("Cannot add to cart. Missing item ID or size."); }
            }
        });

        // Toggle Popups
        cartIconContainer?.addEventListener('click', () => { myFoodPopup?.classList.remove('open'); receiptModal?.classList.remove('open'); cartPopup?.classList.toggle('open'); if (cartPopup?.classList.contains('open')) renderCart(); });
        cartCloseBtn?.addEventListener('click', () => cartPopup?.classList.remove('open'));
        myFoodIconContainer?.addEventListener('click', () => { cartPopup?.classList.remove('open'); receiptModal?.classList.remove('open'); myFoodPopup?.classList.toggle('open'); if (myFoodPopup?.classList.contains('open')) { renderOrderedItems(); checkAndUpdateOrderStatus(); } });
        myFoodCloseBtn?.addEventListener('click', () => myFoodPopup?.classList.remove('open'));

        // Call Staff
        callStaffIconContainer?.addEventListener('click', () => { cartPopup?.classList.remove('open'); myFoodPopup?.classList.remove('open'); receiptModal?.classList.remove('open'); handleCallStaff(); });

        // Image Swiping (Touch and Mouse)
        if (imageContainer) {
             // Touch Events
             imageContainer.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; isSwiping = true; imageContainer.style.cursor = 'grabbing'; }}, { passive: true });
             imageContainer.addEventListener('touchmove', (e) => { if (isSwiping && e.touches.length === 1) { touchEndX = e.touches[0].clientX; }}, { passive: true });
             imageContainer.addEventListener('touchend', (e) => {
                 if (!isSwiping || e.changedTouches.length !== 1) { isSwiping = false; imageContainer.style.cursor = 'grab'; return; }
                 touchEndX = e.changedTouches[0].clientX;
                 const deltaX = touchEndX - touchStartX;
                 if (Math.abs(deltaX) > swipeThreshold) { if (deltaX > 0) showPreviousItem(); else showNextItem(); }
                 isSwiping = false; touchStartX = 0; touchEndX = 0; imageContainer.style.cursor = 'grab';
             });
             // Mouse Drag Events (Simple version)
             let isDragging = false;
             let dragStartX = 0;
             imageContainer.addEventListener('mousedown', (e) => { if (e.target === mainFoodImage || e.target === imageContainer) { isDragging = true; dragStartX = e.clientX; imageContainer.style.cursor = 'grabbing'; e.preventDefault(); }}); // Prevent image drag ghost
             window.addEventListener('mousemove', (e) => { /* Listener needed for mouseup outside */ });
             window.addEventListener('mouseup', (e) => { // Listen on window to catch mouseup outside image
                 if (!isDragging) return;
                 isDragging = false;
                 const dragEndX = e.clientX;
                 const deltaX = dragEndX - dragStartX;
                 imageContainer.style.cursor = 'grab';
                 if (Math.abs(deltaX) > swipeThreshold) { if (deltaX > 0) showPreviousItem(); else showNextItem(); }
             });
             imageContainer.addEventListener('mouseleave', () => { // Reset if mouse leaves while dragging
                 if(isDragging) imageContainer.style.cursor = 'grab';
                 // Optional: Cancel drag if mouse leaves - isDragging = false;
             });
        }

        // Order Button
        orderButton?.addEventListener('click', handleOrderSubmission);

        // Checkout Button (My Food)
        myFoodCheckoutButton?.addEventListener('click', async () => {
             if (!handleGenerateReceipt()) return; // Show receipt modal first

             const button = myFoodCheckoutButton;
             const originalHtml = button.innerHTML;
             let photoSent = false;
             let textSent = false;

             button.disabled = true;
             button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังเตรียม...`;

             try {
                 // 1. Generate Receipt Image
                 const canvas = await generateReceiptCanvas();
                 if (canvas) {
                     const caption = `🧾 ใบสรุปยอด *โต๊ะ ${selectedTableNumber}*`;
                     button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังส่งรูป...`;
                     photoSent = await sendTelegramPhoto(canvas, caption);
                     if (!photoSent) alert("⚠️ เกิดข้อผิดพลาดในการส่งรูปภาพใบเสร็จ");
                 } else {
                     alert("⚠️ ไม่สามารถสร้างรูปภาพใบเสร็จสำหรับส่งได้");
                 }

                 // 2. Send Text Summary (Always attempt this)
                 button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังส่งข้อความ...`;
                 textSent = await sendCheckoutTextSummaryToTelegram();
                 if (!textSent && photoSent) { // Only alert if text failed *after* photo might have succeeded
                     alert("⚠️ เกิดข้อผิดพลาดในการส่งข้อความสรุปยอด");
                 } else if (!textSent && !photoSent) {
                      // Both failed, maybe a more general alert
                      alert("⚠️ เกิดข้อผิดพลาดในการส่งข้อมูลสรุปยอดทั้งหมด (รูปภาพและข้อความ)");
                 }

             } catch (error) {
                 console.error("Error during checkout process:", error);
                 alert(`🚨 เกิดข้อผิดพลาดโดยรวม: ${error.message}`);
             } finally {
                 button.disabled = false;
                 button.innerHTML = originalHtml;
                 // Provide clearer feedback based on success
                 if (photoSent && textSent) {
                     alert(`✅ เรียกเก็บเงินโต๊ะ ${selectedTableNumber} สำเร็จ (ส่งรูปและข้อความแล้ว)`);
                     // Optionally clear orderedItems here? Or leave for manual cashier "Complete" action? Decide based on workflow.
                     // orderedItems = [];
                     // saveOrderedItemsToLocalStorage();
                     // renderOrderedItems();
                     // updateMyFoodIconCount();
                     // receiptModal?.classList.remove('open'); // Close receipt after successful send
                 } else {
                     console.warn("Checkout process completed with partial or full failure.");
                     // Keep receipt open for manual saving if sending failed
                 }
             }
         });


        // Receipt Modal Actions
        closeReceiptBtn?.addEventListener('click', () => receiptModal?.classList.remove('open'));
        saveReceiptBtn?.addEventListener('click', saveReceiptAsImage);
        receiptModal?.addEventListener('click', (e) => { if (e.target === receiptModal) receiptModal.classList.remove('open'); }); // Close on backdrop click

        console.log("Event listeners setup complete.");
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM Content Loaded. Initializing Application...");

        const menuLoaded = await fetchMenuData(); // Fetch menu first

        // Table setup
        selectedTableNumber = loadSelectedTable();
        updateTableDisplay(selectedTableNumber);
        populateTableList(MAX_TABLE_NUMBER);
        if (selectedTableNumber) {
            document.title = `${RESTAURANT_NAME} - ${TABLE_NUMBER_PREFIX}${selectedTableNumber}`;
        } else {
            showTablePromptNotification();
             document.title = `เมนูอาหาร - ${RESTAURANT_NAME}`;
        }

        // Load persistent data
        loadCartFromLocalStorage();
        loadOrderedItemsFromLocalStorage(); // Load potentially existing orders

        // Populate UI based on fetched/loaded data
        if (menuLoaded) { populateCategoryBar(); }
        else { // Handle menu load failure in UI
            const categoryBar = document.querySelector('.category-bar');
            if (categoryBar) categoryBar.innerHTML = '<p style="color: red; padding: 10px; white-space: normal;">⚠ ไม่สามารถโหลดหมวดหมู่ได้</p>';
            if (bottomMenu) bottomMenu.innerHTML = '';
            if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
        }

        // Render dynamic lists
        renderCart();
        updateCartIconCount();
        renderOrderedItems();
        updateMyFoodIconCount();

        // Display initial category/items if menu loaded
        if (menuLoaded && allCategories.length > 0) {
            const firstCategoryItem = document.querySelector('.category-bar .category-item');
            if (firstCategoryItem) {
                const firstCategoryName = firstCategoryItem.dataset.category;
                firstCategoryItem.classList.add('selected');
                displayMenuItems(firstCategoryName);
            } else {
                console.warn("Data loaded, but no category items rendered.");
                if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูให้แสดง</p>';
                 if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
            }
        } else if (menuLoaded && allCategories.length === 0) {
             console.warn("Data loaded, but no categories found in the source.");
             if (bottomMenu) bottomMenu.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); grid-column: 1 / -1;">ไม่มีเมนูให้แสดง</p>';
             if (menuDetailsContainer) menuDetailsContainer.style.display = 'none';
        }
        // else: Error message already shown by fetchMenuData

        // Setup all interactive event listeners
        setupEventListeners();

        console.log("Initialization complete.");
    });

</script>
</body>
</html>
